# Knowledge Graph Memory Server

ref: <https://github.com/modelcontextprotocol/servers/tree/main/src/memory>

Knowledge Graph Memory Serverは、Anthropicが開発したModel Context Protocol (MCP)の一部として提供されているサーバーです。このサーバーは、LLM（大規模言語モデル）に持続的なメモリ機能を提供するために設計されています。特にClaudeのようなLLMがチャット間でユーザー情報を記憶することを可能にします。

## 1. 基本概念

### ナレッジグラフの構造

Knowledge Graph Memory Serverは、ナレッジグラフを使用して情報を保存します。このナレッジグラフは主に以下の要素で構成されています：

1. **エンティティ (Entities)**
   - ナレッジグラフの主要なノード
   - 一意の名前（識別子）を持つ
   - エンティティタイプ（例：「人物」「組織」「イベント」）を持つ
   - 観察（observations）のリストを持つ

   例：

   ```json
   {
     "name": "John_Smith",
     "entityType": "person",
     "observations": ["流暢にスペイン語を話す"]
   }
   ```

2. **リレーション (Relations)**
   - エンティティ間の有向接続を定義
   - 常に能動態で保存され、エンティティ間の関係や相互作用を記述

   例：

   ```json
   {
     "from": "John_Smith",
     "to": "Anthropic",
     "relationType": "works_at"
   }
   ```

3. **観察 (Observations)**
   - エンティティに関する離散的な情報の断片
   - 文字列として保存
   - 特定のエンティティに関連付けられる
   - 独立して追加または削除可能
   - アトミック（1つの観察ごとに1つの事実）であるべき

   例：

   ```json
   {
     "entityName": "John_Smith",
     "observations": [
       "流暢にスペイン語を話す",
       "2019年に卒業",
       "朝のミーティングを好む"
     ]
   }
   ```

## 2. API機能

Knowledge Graph Memory Serverは、ナレッジグラフを操作するための以下のツールを提供します：

1. **create_entities**
   - ナレッジグラフに新しいエンティティを作成
   - 既存の名前を持つエンティティは無視

2. **create_relations**
   - エンティティ間に新しい関係を作成
   - 重複する関係はスキップ

3. **add_observations**
   - 既存のエンティティに新しい観察を追加
   - エンティティが存在しない場合は失敗

4. **delete_entities**
   - エンティティとその関係を削除
   - 関連する関係も一緒に削除（カスケード削除）
   - エンティティが存在しない場合は無視

5. **delete_observations**
   - エンティティから特定の観察を削除
   - 観察が存在しない場合は無視

6. **delete_relations**
   - グラフから特定の関係を削除
   - 関係が存在しない場合は無視

7. **read_graph**
   - ナレッジグラフ全体を読み込み
   - すべてのエンティティと関係を含む完全なグラフ構造を返す

8. **search_nodes**
   - クエリに基づいてノードを検索
   - エンティティ名、エンティティタイプ、観察内容を検索
   - 一致するエンティティとその関係を返す

9. **open_nodes**
   - 名前で特定のノードを取得
   - 要求されたエンティティとそれらの間の関係を返す
   - 存在しないノードは無視

## 3. 技術的実装

Knowledge Graph Memory Serverは、TypeScriptで実装されており、以下の主要なコンポーネントで構成されています：

1. **KnowledgeGraphManager** クラス
   - ナレッジグラフとの対話操作を含む
   - グラフの読み込みと保存の機能を提供
   - エンティティと関係の作成、削除、更新を管理
   - 検索と取得の機能を提供

2. **データストレージ**
   - デフォルトではローカルのJSON形式ファイルを使用
   - 各エンティティと関係は行区切りのJSONとして保存
   - 環境変数でメモリファイルのパスをカスタマイズ可能

3. **MCP Server**
   - @modelcontextprotocol/sdk を使用してMCPクライアントとのインターフェースを提供
   - ツールのリストと呼び出しハンドラーを定義
   - StdioServerTransportを使用して標準入出力経由で通信

## 4. クラウドデスクトップとの使用方法

### セットアップ

Claude Desktop（またはその他のMCPクライアント）でKnowledge Graph Memory Serverを使用するには、`claude_desktop_config.json`を以下のように設定します：

#### Dockerを使用する場合

```json
{
  "mcpServers": {
    "memory": {
      "command": "docker",
      "args": ["run", "-i", "-v", "claude-memory:/app/dist", "--rm", "mcp/memory"]
    }
  }
}
```

#### NPXを使用する場合

```json
{
  "mcpServers": {
    "memory": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-memory"
      ]
    }
  }
}
```

#### カスタム設定のNPX

```json
{
  "mcpServers": {
    "memory": {
      "command": "npx",
      "args": [
        "-y",
        "@modelcontextprotocol/server-memory"
      ],
      "env": {
        "MEMORY_FILE_PATH": "/path/to/custom/memory.json"
      }
    }
  }
}
```

環境変数：

- `MEMORY_FILE_PATH`: メモリストレージのJSONファイルへのパス（デフォルト：サーバーディレクトリ内の`memory.json`）

### プロンプト設定例

Model Context Protocolを使用する際のプロンプト例（Claude.aiプロジェクトの「カスタム指示」フィールドに使用可能）：

```
各インタラクションで以下の手順に従ってください：

1. ユーザー識別：
   - あなたはdefault_userと対話していると想定してください
   - default_userを識別していない場合は、積極的に識別を試みてください

2. メモリ取得：
   - 常にチャットを「Remembering...」という言葉だけで始め、あなたのナレッジグラフから関連する情報をすべて取得します
   - あなたのナレッジグラフは常に「memory」と呼んでください

3. メモリ
   - ユーザーとの会話中、以下のカテゴリに該当する新しい情報に注意してください：
     a) 基本的なアイデンティティ（年齢、性別、場所、職業、学歴など）
     b) 行動（興味、習慣など）
     c) 好み（コミュニケーションスタイル、好きな言語など）
     d) 目標（目標、目標値、願望など）
     e) 関係（最大3段階までの個人的・職業的関係）

4. メモリ更新：
   - インタラクション中に新しい情報が収集された場合、以下のようにメモリを更新します：
     a) 繰り返し出現する組織、人物、重要なイベントのエンティティを作成
     b) 関係を使用してそれらを現在のエンティティに接続
     b) 観察として事実を保存
```

## 5. 技術的な特徴

1. **ファイルストレージ**
   - メモリは行区切りのJSONファイルとして保存
   - 各エンティティと関係は個別の行として保存
   - ファイルが存在しない場合は新しく作成

2. **セキュリティ**
   - Model Context Protocolに基づく安全な通信
   - エンティティとその関係のスコープを制限する検索とフィルタリング機能

3. **スケーラビリティ**
   - 単一のJSONファイルベースのため、小〜中規模のメモリに最適
   - カスタムストレージパスで異なるメモリファイルを使用可能

4. **拡張性**
   - MCP SDKを使用して構築されており、拡張可能
   - コードをフォークして独自の拡張機能を追加可能
   - MITライセンスで提供されているため、商用利用も可能

## 6. ユースケース

1. **パーソナライズされた対話**
   - ユーザーの好み、行動、目標を記憶
   - 過去の会話を参照して連続性を提供

2. **コンテキスト認識の応答**
   - ユーザーの状況や背景に基づいた応答の生成
   - 冗長な質問や情報の繰り返しを減らす

3. **関係マッピング**
   - 人物、組織、概念間の複雑な関係を追跡
   - 推論と接続性の向上

4. **長期的な情報保持**
   - セッションを超えてユーザー情報を保持
   - 長期的な関係構築のための基盤

## 7. 限界と注意点

1. **ストレージ容量**
   - シンプルなJSONファイルベースのため、非常に大規模なグラフには適していない
   - メモリ使用量はグラフの大きさに比例

2. **パフォーマンス**
   - 大量のエンティティや関係がある場合、検索や更新のパフォーマンスが低下する可能性がある
   - 完全なグラフ読み込みは大きなグラフでは重くなる

3. **セキュリティ考慮事項**
   - ローカルファイルシステムへのアクセスが必要
   - 機密情報を保存する場合は適切なアクセス制御が必要

## 8. まとめ

Knowledge Graph Memory Serverは、Model Context Protocol上に構築された、LLMに持続的なメモリ機能を提供するための軽量で使いやすいソリューションです。エンティティ、関係、観察を通じて情報を構造化し、チャットセッション間でLLMが情報を記憶・検索・更新できるようにします。

特にClaudeのようなLLMと組み合わせることで、よりパーソナライズされた、コンテキストを認識したユーザーエクスペリエンスが可能になります。単純なJSONファイルベースのストレージ方式を採用しているため、セットアップが容易で、小〜中規模のユースケースに最適です。

シンプルなAPI設計と明確に定義されたデータモデルにより、開発者は必要に応じてKnowledge Graph Memory Serverを拡張し、カスタマイズすることができます。MITライセンスの下で提供されているため、個人的な実験から商用アプリケーションまで、幅広い目的で使用することができます。
