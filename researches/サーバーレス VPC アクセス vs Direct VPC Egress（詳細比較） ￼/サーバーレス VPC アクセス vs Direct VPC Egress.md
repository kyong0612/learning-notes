# サーバーレス VPC アクセス vs Direct VPC Egress（詳細比較）

この記事の前提に沿って、Cloud Run の「送信（egress）」経路を比較します。元記事の推奨は Direct VPC Egress です。

> 参考: [Cloud RunのサーバーレスVPCアクセスをDirect VPC Egressに安全に切り替える](https://blog.g-gen.co.jp/entry/modifying-serverless-vpc-access-for-direct-vpc-egress)

## 主要観点の比較（表）

| 観点 | サーバーレス VPC アクセス | Direct VPC Egress |
|------|--------------------------|-------------------|
| **構成方式** | Cloud Run → VPC Access コネクタ（VM）→ VPC → Cloud NAT/他 | Cloud Run → Direct VPC Egress（サーバレス）→ VPC → Cloud NAT/他 |
| **料金** | コネクタVMの起動時間・台数に応じて固定費が発生 | コネクタ不要。負荷に応じた柔軟スケールでコスト効率が良い |
| **スケーリング** | 2〜10台でスケールアウト可能。スケールイン不可（再作成が必要） | サーバレスに追随して柔軟にスケール（低レイテンシ／高スループット） |
| **パフォーマンス** | VM台数に依存。ピークでボトルネック化の懸念 | 低レイテンシ・高スループットが期待できる（記事の推奨） |
| **固定送信元IP** | Cloud NATで確保可能だが、コネクタがボトルネックになりがち | Cloud NATに静的IP割当。高可用・水平拡張で"固定IPかつスケーラブル" |
| **ネットワーク制御** | VPC経由のためFW/ルート/VPC SC適用可 | 同様に適用可。ゼロトラストの出口制御に適する |
| **到達性（プライベート）** | Cloud SQL/AlloyDB/Memorystore 等に到達可 | 同様に到達可 |
| **IP需要** | コネクタVM台数分のIPで足りることが多い | 最大コンテナ数の4倍のIP在庫が推奨（枯渇対策） |
| **運用** | コネクタ容量計画・再作成が必要 | サーバレス前提で運用容易。Flow Logs/NAT指標で監査しやすい |
| **移行難易度** | 既存利用時は維持は容易 | 推奨だがCLIの一部不具合に注意（all-trafficが効かないケース） |

## サーバーレス VPC アクセスのメリット

- **シンプルな前提で開始**: 既存の構成や小規模トラフィックでは、必要なVMコネクタ台数だけで成立。
- **IP需要が少ない**: 「最大コンテナ数×4」ほどのIP在庫が不要で、枯渇環境では有利。
- **プライベート到達性**: Cloud SQL 等のプライベート宛先に問題なく接続可能。
- **ネットワークポリシー適用**: VPC経由でFW/ルート/VPC SCを適用できる。

## サーバーレス VPC アクセスのデメリット

- **固定費とキャパ計画**: コネクタVMの起動時間がコストに直結。ピークに備え台数を盛ると過剰コスト。
- **スケールイン不可**: 台数縮小は再作成が必要。運用負荷・ダウンタイムリスク増。
- **性能ボトルネック**: コネクタが出口のスループット上限になりやすい。
- **拡張性の限界**: 大規模・急激なスパイクに追随しづらい。

## Direct VPC Egressのメリット

- **コスト効率＋性能**: コネクタ不要でサーバレスに追随。記事の通り「低レイテンシ・高スループット」が期待でき、推奨構成。
- **固定送信元IPのスケーラブル運用**: Cloud NATに静的IPを割当し、リージョン高可用・水平拡張で大量セッションを吸収。
- **ネットワーク制御の一貫性**: VPC経由でFW/ルート/VPC SCを適用。出口のゼロトラスト設計が容易。
- **運用容易性**: Flow Logs/NATメトリクスで監査・アラート。サービス／サブネット分離でポリシー運用しやすい。
- **トラフィックモードの柔軟性**: all-traffic にすれば外部宛も含めVPC経由統制。private-ranges-onlyで内向き限定も可。

## Direct VPC Egressのデメリット／注意点

- **IP在庫要件**: 最大コンテナ数の「約4倍」のIP在庫推奨。枯渇環境では導入が難しいことがある。
- **コールドスタート影響**: 第2世代実行環境ではコールドスタート時間増の可能性。厳密なレイテンシ要件では留意。
- **CLI切替の不具合（記事時点）**: `--vpc-egress=all-traffic` が効かず `private-ranges-only` になるケース。コンソールでの設定が安全（2024年8月時点の注意）。

## こう使い分ける

- **Direct VPC Egressが基本推奨**: 大半のケースでコスト・性能・拡張性が優れるため、記事でも推奨。
- **サーバーレス VPC アクセスを選ぶ場合**:
  - 第2世代のコールドスタート影響を避けたい厳格レイテンシ要件
  - 企業・ネットワークでIP枯渇中、IP在庫の確保が難しい
  - 既存の小規模構成でコネクタ台数の運用が十分に現実的

## 実践時のポイント（Direct VPC Egress）

- **モード設定**: Cloud NAT 経由で外部へ出すなら「すべてのトラフィック（all-traffic）」が前提。
- **IP計画**: ピークコンテナ数の約4倍のIP在庫を用意（セッション枯渇・拡張余裕のため）。
- **移行の安全策**: タグ付きリビジョン or トラフィック分割で無停止検証→段階移行。CLI不具合があるため当面はコンソールで確認・適用。
- **運用・監査**: VPC Flow LogsとCloud NATメトリクスで出口トラフィックの監視・アラート設計。

---

詳しい移行手順・注意点はこの記事にまとまっています。

> [Cloud RunのサーバーレスVPCアクセスをDirect VPC Egressに安全に切り替える](https://blog.g-gen.co.jp/entry/modifying-serverless-vpc-access-for-direct-vpc-egress)
