# 自動記事要約システム実装タスクリスト

## Phase 1: 基盤整備

### 1.1 プロジェクトセットアップ

- [x] 必要なパッケージのインストール
  - [x] `@mastra/core`
  - [x] `zod`
  - [x] `@ai-sdk/openai`（Claude Code用）→ `@ai-sdk/anthropic`がインストール済み
  - [x] 追加の必要なパッケージ
- [x] TypeScript設定の確認・調整
- [x] 環境変数の設定（.env）→ .env.exampleを作成

### 1.2 ディレクトリ構造の作成

- [x] `src/mastra/workflows`ディレクトリ作成（既存）
- [x] `src/mastra/tools`ディレクトリ作成（既存）
- [x] `src/mastra/config`ディレクトリ作成

## Phase 2: Tool実装

### 2.1 基本ツールの実装

- [x] GitDiffツールの実装
  - [x] git diffコマンドの実行
  - [x] 新規.mdファイルのフィルタリング
  - [x] エラーハンドリング

### 2.2 外部連携ツールの実装

- [x] YouTube MCPツールの実装
  - [x] YouTube URLの検証
  - [x] MCPサーバーとの連携（TODO: 実際の連携実装）
  - [x] レスポンスの整形

- [x] WebFetchツールの実装
  - [x] URL検証
  - [x] コンテンツ取得
  - [x] HTMLからMarkdownへの変換（簡易実装）

### 2.3 Claude Codeツールの実装

- [x] Claude Code CLIラッパーの作成
- [x] プロンプトファイルの読み込み
- [x] 実行結果のパース

## Phase 3: Workflow Step実装

### 3.1 基本ステップの実装

- [x] GitDiffStepの実装
  - [x] 入力スキーマ定義
  - [x] 出力スキーマ定義
  - [x] 実行ロジック

- [x] FileParserStepの実装
  - [x] Markdownファイルの読み込み
  - [x] ソースURL抽出ロジック
  - [x] メタデータパース

### 3.2 処理ステップの実装

- [x] ToolSelectorStepの実装
  - [x] URL判定ロジック
  - [x] ツール選択アルゴリズム
  - [x] デフォルトツールの設定

- [x] SummaryStepの実装（Suspendable）
  - [x] 要約生成ロジック
  - [x] サスペンド機能の実装
  - [x] レジューム機能の実装
  - [x] 承認UIとの連携

### 3.3 最終ステップの実装

- [x] UpdateFileStepの実装
  - [x] ファイル更新ロジック
  - [x] バックアップ処理
  - [x] エラーハンドリング

## Phase 4: Workflow統合

### 4.1 ワークフロー定義

- [x] autoSummarizeWorkflowの作成
- [x] ステップの連結
- [x] エラーハンドリングの実装
- [x] リトライロジックの実装（各ツール内で実装済み）

### 4.2 Mastraインスタンスへの登録

- [x] `src/mastra/index.ts`の更新
- [x] ワークフローの登録
- [x] ツールの登録

## Phase 5: ユーザーインターフェース

### 5.1 承認インターフェース

- [ ] 承認画面の設計
- [ ] Mastra Playgroundとの統合
- [ ] CLIベースの承認機能（オプション）

### 5.2 実行インターフェース

- [x] 手動実行スクリプトの作成（run-workflow.ts）
- [ ] 定期実行の設定（cron/scheduler）
- [x] 実行ログの表示

## Phase 6: テストと品質保証

### 6.1 ユニットテスト

- [ ] 各ツールのテスト作成
- [ ] 各ステップのテスト作成
- [ ] モックデータの準備

### 6.2 統合テスト

- [ ] ワークフロー全体のテスト
- [ ] エラーケースのテスト
- [ ] パフォーマンステスト

### 6.3 ドキュメント作成

- [x] READMEの作成
- [x] 使用方法ガイド
- [x] トラブルシューティングガイド

## Phase 7: デプロイと運用

### 7.1 デプロイ準備

- [ ] 環境変数の管理
- [ ] ビルドスクリプトの作成
- [ ] デプロイスクリプトの作成

### 7.2 モニタリング

- [ ] ログ収集の設定
- [ ] エラー監視の設定
- [ ] 実行統計の収集

## Phase 8: 拡張機能（オプション）

### 8.1 追加機能

- [ ] 複数ディレクトリ対応
- [ ] カスタムプロンプト対応
- [ ] バッチ処理の最適化
- [ ] 差分更新機能

### 8.2 UI改善

- [ ] Webベースの管理画面
- [ ] 実行履歴の可視化
- [ ] 統計ダッシュボード

## 優先度と見積もり

### 高優先度（必須）

- Phase 1-4: 基本機能の実装（2-3週間）
- Phase 6.1-6.2: テスト（1週間）

### 中優先度（推奨）

- Phase 5: UI実装（1週間）
- Phase 6.3: ドキュメント（3日）

### 低優先度（オプション）

- Phase 7-8: デプロイと拡張（1-2週間）

## 完了基準

- [x] 新規Markdownファイルの自動検出が可能
- [x] 各ファイルに対して要約が生成される
- [x] ユーザー承認フローが機能する
- [x] ファイルが正しく更新される
- [x] エラーハンドリングが適切に実装されている

## Phase 1実装後の課題と次のステップ（2025-07-16追加）

### 実装完了状況

- Phase 1-4の全機能実装完了
- 基本的なロジックと構造は完成

### 発生した課題

#### Mastra APIの仕様変更による型エラー

- [ ] ToolExecutionContextのinputDataプロパティが存在しない
- [ ] ワークフローのステップ間データ渡しの不整合
- [ ] Suspendable機能の実装方法が不明

### 推奨される次のステップ

#### 1. 環境設定

- [ ] .envファイルを作成して環境変数を設定
- [ ] Claude Code CLIの動作確認

#### 2. API仕様の確認と修正

- [ ] Mastraの公式ドキュメントで最新API仕様を確認
- [ ] ツールのexecuteメソッドのシグネチャを修正
- [ ] ステップ間のデータ受け渡し方法を修正

#### 3. 型エラーの解決

- [ ] git-diff-tool.tsのAPI修正
- [ ] youtube-mcp-tool.tsのAPI修正
- [ ] web-fetch-tool.tsのAPI修正
- [ ] claude-code-tool.tsのAPI修正
- [ ] 各ステップのexecuteメソッド修正

#### 4. 動作テスト

- [ ] 型チェックがパスすることを確認（pnpm typecheck）
- [ ] Lintチェックがパスすることを確認（pnpm lint）
- [ ] テスト用Markdownファイルで動作確認
- [ ] エラーハンドリングの確認
