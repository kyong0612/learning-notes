# 失敗から学ぶRDBの正しい歩き方

- [失敗から学ぶRDBの正しい歩き方](#失敗から学ぶrdbの正しい歩き方)
  - [アンチパターンの何が問題か？](#アンチパターンの何が問題か)
  - [アンチパターンを産まないためには](#アンチパターンを産まないためには)
    - [命名ミスは初期段階で対処](#命名ミスは初期段階で対処)
  - [アンチパターンの解説](#アンチパターンの解説)
    - [過去の事実(値)が失われる](#過去の事実値が失われる)
    - [過去の事実(過程)が失われる](#過去の事実過程が失われる)
    - [過去の事実は非常時に必要になる](#過去の事実は非常時に必要になる)
  - [アンチパターンを産まないためには?](#アンチパターンを産まないためには-1)
    - [「履歴の保存」はトレードオフ](#履歴の保存はトレードオフ)
  - [アンチパターンのポイント](#アンチパターンのポイント)

## アンチパターンの何が問題か？

- 不適切な名前では、データベースのテーブルの関連性や意図が理解できない
- リレーショナルモデルに基づいた設計をしていないと、既存の便利なツールが利用できない
- 保存されたデータが正しいかどうかどうかが判断できない
- どのようなデータを保存し、どのようなデータを取り出せばいいかわからない

## アンチパターンを産まないためには

- 動くものを作るときに適切に作る

### 命名ミスは初期段階で対処

- 命名ミスはさっさとなおせ
- - 現場で稀に、外部キー制約はCHECK制約をかけずに「アプリケーション側でバリテーションすれば良い」という人がいるが、CHECK制約が守る対象は「アプリケーションのバグ」も含み、DDLからそのカラムの持つ意味を担保することも含む

## アンチパターンの解説

- RDBは**時間軸と直行するような設計**が大切

- e.g) 消費税の改正後に商品の返品があったとき、過去の価格を参照できなくなる

### 過去の事実(値)が失われる

![alt text](<CleanShot 2025-01-01 at 17.57.35@2x.png>)

### 過去の事実(過程)が失われる

![alt text](<CleanShot 2025-01-01 at 17.58.25@2x.png>)

### 過去の事実は非常時に必要になる

- 今ある事実のみを保存してしまうと過去の事実を失ってしまうので、例外処理を行うときやトラブル時に状況把握する場合に情報が不足してしまう

## アンチパターンを産まないためには?

- 履歴を保存する
  - ![alt text](<CleanShot 2025-01-01 at 18.00.42@2x.png>)
  - ![alt text](<CleanShot 2025-01-01 at 18.01.09@2x.png>)

### 「履歴の保存」はトレードオフ

- RDBに履歴を保存させるデメリット
  - レコードの保存量が増えるためテーブルサイズが増える
  - 集計が単純な主キー検索ができなくなるため、テーブルサイズが肥大化した際に検索速度が劣化する

## アンチパターンのポイント

- 払い戻しなど取り消し処理に対応できるか
- 配送状況などステータス変化を追えるか
- トラブル対応時、欲しい情報が失われていないか

- パフォーマンスの劣化を考えて、あえて履歴を保存しない設計をとるケースもある
  - 別手段で履歴を保存する
    - 遅延レプリケーションを使う
    - アプリケーションログとしてElasticsearchなどの分析ツールに保存する
