---
title: "Go 1.26の新GC「Green Tea（緑茶）」解説"
source: "https://future-architect.github.io/articles/20260130a/"
author:
  - "[[棚井龍之介]]"
published: 2026-01-30
created: 2026-01-31
description: "Go 1.26でデフォルト有効となった新GC「Green Tea GC」の仕組みと性能改善について解説。ページ単位処理とFIFOキュー戦略により、メモリアクセスの空間的局所性を改善し、10〜40%のGCオーバーヘッド削減を実現。"
tags:
  - "clippings"
  - "Go"
  - "GC"
  - "ガベージコレクション"
  - "パフォーマンス"
  - "Go1.26"
---

## TL;DR

- Go 1.26からGreen Tea GCがデフォルト有効（オプトアウト: `GOEXPERIMENT=nogreentea`）
- Intel/AMDの最新CPUではAVX-512によるベクトル加速も利用可能
- メモリアクセスの空間的局所性を大幅に改善
- **10〜40%のGCオーバーヘッド削減**を実現

---

## Green Tea GCとは

Go 1.26でリリースされた新しいガベージコレクタ。名前の由来は、2024年にGoランタイムチームのAustinが日本でカフェ巡りをしながら、大量の抹茶を飲みつつプロトタイプを開発したことから。

Go 1.25で実験的に導入され、Go 1.26からデフォルトで有効化された。

---

## 従来GCの問題点

### マーキング処理の仕組み

GoのGCは**並行マークスイープ（Concurrent Mark-Sweep）**アルゴリズムを採用。

1. ルート（グローバル変数やスタック上の変数）から参照をたどる
2. 到達できるオブジェクトに「使用中」の印をつける
3. 印がつかなかったオブジェクトがGC対象

### 問題: ランダムなメモリアクセス

従来のマーキング処理（「グラフフラッド」）では：
- ワークリストからオブジェクトを取り出すたびに、メモリ上の異なる場所にジャンプ
- ポインタをたどる順序とメモリ上の配置が無関係
- **キャッシュ効率が悪い**

公式ブログでは「高速道路ではなく市街地を走るようなもの」と表現。

### 具体的な影響（数値）

| 指標 | 値 |
|------|-----|
| メインメモリ vs キャッシュ | 最大100倍遅い |
| マーキング時間のメモリ待ち | 35%以上 |
| GC時間に占めるマーキング | 90% |

---

## Green Teaの仕組み

### 核心アイデア

> **「オブジェクト単位ではなく、ページ（スパン）単位で作業する」**

### ページ蓄積戦略

1. ポインタを発見 → ターゲットオブジェクトが存在する**ページ全体**をワークリストに追加
2. ページがキューで待機中に、同じページ内の他のオブジェクトも蓄積
3. ページ処理時に、蓄積された全オブジェクトを**メモリ順序で一括スキャン**

各オブジェクトに「発見済み／スキャン済み」のビットを持たせて効率的に追跡。

### FIFOキューの採用

| 方式 | 動作 | 結果 |
|------|------|------|
| LIFO（従来） | 最後に入れたものを最初に処理 | 蓄積する時間がない |
| FIFO（Green Tea） | 最初に入れたものを後で処理 | 待機中に同じページの他オブジェクトが蓄積される |

### ベクトル加速

- 2020年以降のIntel/AMD CPU（AVX-512対応）で追加で約10%の性能改善
- 512バイト以下の小オブジェクトに最適化
- 各プロセッサが独自のスパンキューを持ち、多コア環境でも効率的にスケール

---

## ベンチマーク結果

GC負荷の高いベンチマーク（1000万個×100回のリンクリスト生成・破棄）での計測結果：

| バージョン | 平均実行時間 |
|------------|--------------|
| Go 1.25 | 41.24s |
| Go 1.26rc1 | 36.71s |

**約11%の改善**。GC回数も減少（129回 → 109回）。

※ 実際のアプリケーションでは、ワークロードの特性により改善率は変動（公式発表: 10〜40%）

---

## 従来GCとGreen Tea GCの比較

| 観点 | 従来のGC | Green Tea GC |
|------|----------|--------------|
| 処理単位 | オブジェクト | ページ（スパン） |
| メモリアクセス | ランダム | シーケンシャル |
| キュー戦略 | LIFO | FIFO |
| キャッシュ効率 | 低い | 大幅に改善 |

---

## 導入方法

Go 1.26では**何もしなくても**Green Tea GCが有効。

### オプトアウト（問題発生時）

```bash
GOEXPERIMENT=nogreentea go build
```

### GCトレースの確認

```bash
GODEBUG=gctrace=1 ./your-program
```

---

## 参考リンク

- [A Guide to the Go Garbage Collector](https://go.dev/doc/gc-guide)
- [The Green Tea Garbage Collector](https://go.dev/blog/greenteagc)
- [Go 1.26 Release Notes](https://go.dev/doc/go1.26)
