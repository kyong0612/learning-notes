---
title: "Reactの内部構造を知っておく (React Tokyo #6 - @calloc134)"
source: "https://www.figma.com/proto/89Ec97h17sGVk7huDaXnqg/React%E3%81%AE%E5%86%85%E9%83%A8%E6%A7%8B%E9%80%A0%E3%82%92%E7%9F%A5%E3%81%A3%E3%81%A6%E3%81%8A%E3%81%8F--React-Tokyo--6----calloc134-?node-id=1-2"
author:
  - "calloc134"
published: 2025-06-19
created: 2025-06-19
description: "React Tokyo #6で発表されたReactの内部構造について詳しく解説したプレゼンテーション資料。仮想DOM、Fiberノード、レンダリングフロー、スケジューリングなどReactの核心的な概念を分かりやすく説明。"
tags:
  - "React"
  - "JavaScript"
  - "Fiber"
  - "Virtual DOM"
  - "Frontend"
  - "Architecture"
---

# React の内部構造を知っておく (React Tokyo #6)

## 概要

React Tokyo #6のメイントークで発表されたプレゼンテーション資料。Reactの内部構造について、特にFiberアーキテクチャを中心とした詳細な解説。スライドはgenspark.aiで作成され、html.to.designでFigmaに変換後、デザインが修正された。

## 主要テーマ

### 1. はじめに

- **Reactの役割**: UIの宣言的記述を行うライブラリ
- **現状**: デファクトスタンダードなUIライブラリ
- **問題**: ユーザーが気づかぬうちに仕組みを勘違いしていることが多い
- **目的**: ソースコードを通して仕組みを解説

### 2. 宣言的UIとは？

**宣言的アプローチの特徴**:

- 「どのように達成するか (How)」ではなく「何を達成するか(What)」に焦点
- 例: キャンバスに四角形を描くタスクでの比較
  - **命令的**: ペンを下ろす→右に線を引く→下に線を引く→左に線を引く→上に線を引く
  - **宣言的**: 「キャンバスに四角形を描く」と宣言

### 3. Reactの宣言的UI実装

**Reactのアプローチ**:

1. 仮想DOM（下描き用紙）と実際のDOM（本番キャンバス）の2層構造
2. 下描きで全体を再描画し、差分検出で実際のキャンバスには差分のみ適用
3. 開発者は詳細な手順を意識せず「何を達成するか」のみを宣言的に記述

**メリット**:

- 効率的かつ手間が少ない
- 開発者体験の大幅な向上

### 4. Reactのレンダリングの流れ

**4つのフェーズ**:

1. **トリガーフェーズ**: イベント発火、レンダリング開始の契機
2. **スケジュールフェーズ**: レンダリングの優先度決定と実行計画管理
3. **レンダーフェーズ**: Fiber更新、差分検出（中断可能）
4. **コミットフェーズ**: DOM更新、差分反映（中断不可）

### 5. 仮想DOMの正体: Fiberノード

**重要な概念**:

- React内部で管理しているのは「仮想DOM」ではなく「Fiberノード」
- Fiberノードはコンポーネントツリーを構成する基本要素

**主要プロパティ**:

- `key`: コンポーネントの一意な識別子
- `tag`: コンポーネントのタイプ
- `stateNode`: 実際に対応するDOMノードやクラスインスタンス

**参照関係**:

- `child`: 第一子へのFiberノード参照
- `sibling`: 次の兄弟Fiberノード参照
- `return`: 親Fiberノード参照
- `alternate`: 相対するもう一方のノードへの参照

### 6. FiberRootNodeの役割

**構造**:

- `current`: 現在の表示状態を表すツリー
- `workInProgress`: 次のレンダリングで表示される状態を表すツリー
- FiberRootNodeは2つのFiberツリーを管理する上位ノード

### 7. 優先度: レーン

**実装方式**:

- 32ビットのビットマスクとして優先度を表現
- 「車線（レーン）」概念で優先度別処理を実現

**優先度レベル**:

- ユーザー入力の更新 → 高優先度
- アニメーション → 中優先度
- バックグラウンド更新 → 低優先度

**メリット**: OR演算で優先度を組み合わせ可能

### 8. 各フェーズの詳細

#### トリガーフェーズ

- 優先度付きキューを利用したタスク管理
- `taskQueue`: すぐ実行されるタスク
- `timerQueue`: 将来実行予定のタスク

#### スケジュールフェーズ

- タスク取得と実行判断
- 長時間実行タスクによるUI更新ブロックを防止
- 処理を細かく分割しブラウザに制御を戻す

#### レンダーフェーズ

- `beginWork`: 関数コンポーネント実行、差分検出
- `completeWork`: フラグ登録・DOM生成
- リコンシリエーション（差分検出処理）
- 深さ優先探索によるノード巡回

#### コミットフェーズ

- 実際のDOMに差分を反映
- 中断不可の処理
- 完了時にFiberRootNode.currentをworkInProgressに更新

### 9. リコンシリエーション

**2段階マッチング**:

1. **位置ベースマッチング**: まず位置でマッチング試行
2. **キーベースマッチング**: 失敗時はキーを利用したマッチング

**処理パターン**:

- マッチング成功 → 既存ノード再利用
- Fiberノードが余る → 削除フラグ付与
- 要素が余る → 新規Fiberノード作成

## 技術的洞察

### アーキテクチャの革新性

1. **中断可能なレンダリング**: React Fiberの最大の特徴
2. **優先度ベーススケジューリング**: レスポンシブなUI実現
3. **2つのツリー構造**: 効率的な差分管理

### パフォーマンス最適化

- フラグを利用した効率的な更新判定
- 深さ優先探索による体系的なノード処理
- alternate参照による既存ノードの再利用

## 参考資料

プレゼンテーション内で紹介された関連記事:

- <https://zenn.dev/calloc134/articles/how-react-works-guide>
- <https://deepwiki.com/facebook/react>  
- <https://zenn.dev/ktmouk/articles/68fefedb5fcbdc>
- <https://jser.dev/series/react-source-code-walkthrough>
- <https://incepter.github.io/how-react-works/>

## まとめ

本プレゼンテーションは、Reactの内部構造を体系的に説明した優れた資料である。特にFiberアーキテクチャの理解に焦点を当て、宣言的UIからスケジューリング、レンダリングフローまで、Reactの核心概念を段階的かつ分かりやすく解説している。React開発者にとって、フレームワークの深い理解を得るための貴重な学習リソースとなっている。
