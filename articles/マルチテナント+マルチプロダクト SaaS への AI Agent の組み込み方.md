---
title: "マルチテナント+マルチプロダクト SaaS への AI Agent の組み込み方"
source: "https://speakerdeck.com/kworkdev/integrate-ai-agent-into-saas"
author:
  - "川中真耶（株式会社ナレッジワーク / CTO）"
published: 2025-06-18
created: 2025-06-18
description: |
  株式会社ナレッジワークのCTO川中真耶氏によるAI Engineering Summit 2025での登壇資料。マルチテナントSaaS環境におけるAIエージェントの効果的な導入・運用のための実践的手法を解説。アーキテクチャ設計、テナント別データ分離・セキュリティ確保、スケーラビリティ、カスタマイズ運用のポイントを具体例で紹介。
tags:
  - AI Agent
  - マルチテナント
  - SaaS
  - アーキテクチャ
  - セキュリティ
  - protobuf
  - MCP
---

# マルチテナント+マルチプロダクト SaaS への AI Agent の組み込み方

## 講演者プロフィール

**川中真耶（株式会社ナレッジワーク / CTO）**

- 東京大学大学院情報理工学系研究科コンピュータ科学専攻修士課程修了
- 日本IBM東京基礎研究所研究員
- Googleソフトウェアエンジニア
- 株式会社ナレッジワーク共同創業
- CTO of the year 2022 ファイナリスト
- 「王様達のヴァイキング」（週刊ビッグコミックスピリッツ）技術監修

## ナレッジワークについて

株式会社ナレッジワークは、営業担当の支援をするプロダクト「ナレッジワーク」を提供。多くの大手企業に数千名規模で導入されているセールスイネーブルメントAIプラットフォーム。

## 課題の背景

### AI Agent 開発の現状

- 現在は様々なAI Agent開発フレームワークが登場し、簡単にAgentを動かせる時代
- しかし、実際にプロダクトに組み込むと以下の課題が発生：
  - 認証・権限管理
  - データ読取権限
  - デプロイ戦略との整合
  - テナント別プロンプトライセンス管理

### システムアーキテクチャの前提

**マルチテナントアーキテクチャ**

- 1つのシステムに多数のテナントが相乗り

**マルチプロダクト**

- 1つのシステムに複数のプロダクトを抱え、それぞれでAI Agentを動かしたい
- プロダクト単位でサーバーが分かれており、プロダクト間通信は禁止

**テナント単位での挙動カスタマイズ**

- 会社によって業務フローが異なり、テナントごとのプロンプトカスタマイズが必要

## マルチテナントに伴う課題

### 1. モデル利用制限の課題

- **テナントによって使用可能モデルが異なる**
  - エンタープライズ顧客からの厳しいセキュリティ要件
  - データの国内閉じ込み要求
  - 金融・保険・医療業界での特に厳しい制限

- **日本国内で利用可能なモデルの制限**（2025年現在）
  - Google Cloud: Gemini 1.5 flash 32kトークンモデルのみ
  - Azure OpenAI: o4のみ
  - AWS Bedrock: Claude Haiku 3.0 or Sonnet 3.5

### 2. プロンプトカスタマイズの需要

- 最適な顧客体験提供のためのテナント別プロンプト調整
- カスタマーサクセスやコンサルによる併走型カスタマイズ
- 業務フローの違いに対応した細かな調整

## マルチプロダクトに伴う課題

### 1. ライセンス・権限管理

- ユーザーによって保持するプロダクトライセンスが異なる
- 使用可能プロダクト範囲での機能実装が必要

### 2. アーキテクチャ上の制約

- プロダクト間通信禁止によるAI Agent配置の制約
- プロダクト連携が必要な機能は「クロスプロダクト」に配置が必要

### 3. 開発プロセスの課題

- **AIインタフェースの非統一**
  - 各プロダクトが独自にAIインタフェースを拡張
  - メモリ機能やセッション管理の定義方法の不一致

- **外部通信機能のオーナーシップ不在**
  - MCP serverや A2A (Agent to Agent) Protocolの管理
  - プロダクト横断でのインタフェース統一の必要性

- **デプロイサイクルの不一致**
  - プロダクトリリースと AI Agent フレームワークのデプロイタイミングの齟齬

## 解決案

### マルチテナント対応

1. **言語モデル利用制限の一律定義**
   - テナント別の使用可能モデル管理
   - 勝手な言語モデル利用の防止

2. **プロンプトのテナント別カスタマイズ**
   - デフォルトエージェントとカスタマイズエージェントの同名定義
   - 名前による呼び出し統一

### マルチプロダクト対応

1. **プロダクト単位でのエージェント定義**
   - プロンプト定義、ツール定義のプロダクト側設定
   - protobufによるツール構成

2. **エージェント実行の抽象化**
   - 定義を渡して実行するインターフェース
   - プロダクト開発者の詳細隠蔽

## アーキテクチャ詳細

### 全体構成

```
共通基盤 -> 認証 -> プロダクト横断 -> プロダクト -> クライアント
```

- エージェント実行部・MCPをプロダクト横断サーバーへ配置
- 各プロダクト・共通基盤でツール定義
- エージェント定義を共通基盤へ配置

### エージェント定義と実行

#### protobuf による統一定義

```protobuf
message SingleAgentSpec {
  string name = 1;
  AgentModel model = 2;
  optional string description = 3;
  optional string instruction = 4;
  optional ToolSpec tool = 5;
  optional SingleOutputSpec output = 6;
  optional SingleMemorySpec memory = 7;
}
```

#### テナント別カスタマイズ

- 同じ名前のデフォルトエージェントとカスタマイズエージェントを定義
- モデルとプロンプトをペアで保持（モデル別の癖に対応）

#### セッション管理

```protobuf
message AgentSession {
  string agent_session_id = 1;
  Agent agent = 2;
  google.protobuf.Struct session_context = 3;
}
```

### ツール定義と実行

#### protobuf + connect rpc によるツール定義

```protobuf
service McpToolService {
  rpc List(ListRequest) returns (ListResponse) {}
  rpc McpToolSearchKnowledgeChunks(
    McpToolSearchKnowledgeChunksRequest
  ) returns (
    McpToolSearchKnowledgeChunksResponse
  ) {
    option (mcp.tool) = {
      name: "search_knowledge_chunk"
      description: "ナレッジチャンクを検索します。..."
    };
  }
}
```

#### ツール実装の利点

- 既存の認証・認可・ライセンス機能の利用
- protobufエコシステムによる自動実装
- サービスデプロイによる自動ツール更新

#### MCP変換アーキテクチャ

- JSON-RPC と connect rpc の自動変換
- 内部向けMCP proxyによるセッション情報管理
- 外部向けMCPサーバーの提供

## 実装のポイント

### 権限・認証の統合

- テナント情報、ユーザー情報、セッション情報の一元管理
- session_idによる実行コンテキストの追跡
- プロダクト単位での権限チェック自動化

### デプロイ戦略

- プロダクトサーバーデプロイでのツール自動更新
- エージェント実行部の独立性維持
- 型安全性を保ちながらの柔軟な拡張

### パフォーマンス最適化

- agnoフレームワークの採用（LangChainより高速）
- ローカル通信によるレイテンシ削減
- エージェント定義のキャッシュ機能

## まとめ

1. **マルチテナント・マルチプロダクト SaaS における AI エージェント組み込みの困難さとその解決策**
   - プロダクトサーバーでのAgent定義
   - デフォルト・カスタマイズエージェントの管理

2. **デプロイ戦略との整合性を取るツール定義の仕組み**
   - protobuf + connect rpcによる統一インターフェース
   - 既存エコシステムとの統合

3. **テナント隔離・認証・権限・ライセンスチェックの実現**
   - 既存システムとの連携
   - 様々なHACKによる課題解決

この発表は、AI Engineering Summit 2025（2025年6月18日開催）での登壇資料として、実践的なマルチテナントSaaSへのAI Agent組み込み手法を具体的なアーキテクチャとともに紹介している。
