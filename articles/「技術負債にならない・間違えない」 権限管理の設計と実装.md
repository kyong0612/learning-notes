---
title: "「技術負債にならない・間違えない」 権限管理の設計と実装"
source: "https://speakerdeck.com/naro143/ji-shu-fu-zhai-ninaranaijian-wei-enai-quan-xian-guan-li-noshe-ji-toshi-zhuang"
author:
  - "Yusuke Ishimi (@naro143)"
published: 2025-09-27
created: 2025-09-30
description: |
  Kaigi on Rails 2025 Day2での発表スライド。権限管理の重要性とアンチパターンを整理し、対象・操作・役割・条件に分割したモジュール設計と実装で技術負債とミスを減らす手法を解説する。
tags:
  - "access-control"
  - "rbac"
  - "rails"
  - "nextjs"
  - "kaigi-on-rails"
---

## セッション概要

- Kaigi on Rails 2025 Day2での講演。プレゼンターは株式会社プレックスのテックリードであるYusuke Ishimi（@naro143）。
- 目標は、権限管理の重要性を理解し、アンチパターンを避け、対象・操作・役割・条件を分離したモジュール設計で技術負債とミスを減らすこと。
- スライドでは「対象・操作・役割・条件」の4要素を示す図や、Module構造の概念図、UI制御の画面キャプチャなどの視覚要素が用いられている。

## 権限管理の重要性と失敗事例

- SaaSにおける権限の例（運営アカウントのみの機能表示、管理者の招待機能、特定プランでの機能解放など）を提示。
- 権限ミスで給与情報や取引先情報が露出するリスク、サービス信頼性の毀損、事業損失が強調される。
- 「給与を公開してしまった」「取引先を公開してしまった」といった失敗イメージ図で、権限管理のミスが許されないことを可視化。

## よくある実装とアンチパターン

- `admin?` や `super_admin` に依存する単純なロール判定はアンチパターン。役割が変動すると整合性確保が困難で技術負債化する。
- 役割ベース判定は権限が暗黙化し、レビュアーが全判定箇所を把握する負担が増す。
- 事業・サービスの変化（対象市場、企業規模、ユーザー変化）で役割の意味が変わることを図示し、将来的な破綻を指摘。

## 権限管理を構造化するアプローチ

- RBAC（Role-Based Access Control）とABAC（Attribute-Based Access Control）を比較。役割と条件（属性）を分ける必要性を説明。
- 「対象のCRUDは役割か条件で判定できる」というフレームで、対象・操作・役割・条件の4要素に分解する図を提示。
- 具体例：「プロジェクト更新は管理者または担当者が可能」を対象・操作・役割・条件で記述する流れを解説。

## Module設計とPunditによる実装

- Punditを例に、対象ごとにディレクトリ、役割ごとにファイルを配置し、役割と条件の責務を分離。
- メタプログラミングで対象と役割から権限クラスを特定する仕組みを導入し、変更容易性を高める。
- 権限の基底クラスでCRUD操作を定義し、対象固有の追加操作や条件を拡張可能にする。図では対象・操作・役割・条件のブロック構造が示される。

## 判定モードと利用方法

- `record` モード：レコードに対する権限判定。対象と操作を明示し、条件を論理演算で表現。
- `scope` モード：アクセス可能なレコードへ絞り込む。クエリに権限判定ロジックを組み込む例を提示。
- `list` モード：権限一覧を取得しクライアントへ渡す。Moduleが全publicメソッドを評価し、権限マップを生成する。
- 図示されたフローチャートで各モードの手順（クラス特定→モード指定→操作関数→条件評価）を可視化。

## 実装詳細と具体例

- 条件は英語と論理演算で読めるよう命名し、Booleanやスコープ戻り値で表現。or条件は配列で定義する。
- 追加操作も同様に条件を記述し、対象基底クラスで共通条件を提供。記号付きの論理図で可読性を強調。
- コード例スライドではContextオブジェクトを経由して権限クラスを生成し、操作メソッドを呼び出す流れを解説。

## Next.jsとの連携とUI制御

- Railsから権限一覧JSONを返し、Next.jsでMap化・管理することでクライアント側も役割ではなく権限に依存。
- listモードで取得した権限をUI制御に利用し、ボタン表示制御を宣言的に記述。画面キャプチャで編集ボタンの制御例を提示。
- レコード固有の判定はNext.js側で実施し、対象・操作が明示されることで問い合わせ対応や調査が迅速になる。

## 効果とまとめ

- Module導入後1年間、不具合発生ゼロ。CSやPdMがGitHubの一次情報で自己解決できるようになり、社内問い合わせがゼロに。
- RailsだけでなくNext.js側の技術負債も防止し、権限によるUI制御を宣言的に実現。
- 重要な結論：権限実装は役割ではなく権限に依存し、対象・操作・役割・条件の4分割で設計する。適切なモジュール化により理解・実装・利用の各フェーズで「間違えない」を達成。
- 注意点：対象や操作が定義されていない場合のハンドリング、具体的レコードが不要な場合の判定記述など、条件設計時の一貫性が品質に直結する。
