---
title: "タスクキューとマイクロタスクキュー｜イベントループとプロミスチェーンで学ぶJavaScriptの非同期処理"
source: "https://zenn.dev/estra/books/js-async-promise-chain-event-loop/viewer/d-epasync-task-microtask-queues"
author:
  - "estra"
published:
created: 2025-07-01
description: |
  JavaScriptの非同期処理におけるイベントループの重要な構成要素であるタスクキューとマイクロタスクキューの役割、違い、そしてそれらがどのように処理されるかを解説します。
tags:
  - "JavaScript"
  - "非同期処理"
  - "イベントループ"
  - "タスクキュー"
  - "マイクロタスクキュー"
---

## イベントループの構成要素

イベントループは、JavaScriptの非同期処理の根幹をなす仕組みであり、以下の要素で構成されています。

- **コールスタック (Call Stack)**: 同期的なコードの実行コンテキストを管理するスタック。
- **ヒープ (Heap)**: オブジェクトや関数などのメモリ領域。
- **Web APIs**: `setTimeout`や`fetch`など、ブラウザが提供する非同期API。Node.js環境ではC++ APIsなどが該当します。
- **タスクキュー (Task Queue / Macrotask Queue)**: 非同期APIのコールバック関数が待機するキュー。
- **マイクロタスクキュー (Microtask Queue / Job Queue)**: `Promise`のコールバックなどが待機する、タスクキューとは別のキュー。

## タスクキューとマイクロタスクキュー

イベントループには2種類のキューが存在し、それぞれ異なる種類の非同期タスクを扱います。

### タスクキュー (Task Queue / Macrotask Queue)

- `setTimeout`, `setInterval`, `setImmediate`などのタイマー処理や、I/O処理、UIレンダリングなど、比較的大きなタスク（マクロタスク）のコールバック関数が追加されます。
- これらのタスクは「タスク (Tasks)」と呼ばれます。

### マイクロタスクキュー (Microtask Queue / Job Queue)

- `Promise`の `.then()`, `.catch()`, `.finally()` で登録されたコールバックや、`queueMicrotask()`、`MutationObserver` など、より小さなタスク（マイクロタスク）が追加されます。
- これらのタスクは「ジョブ (Jobs)」と呼ばれます。

## イベントループにおける処理の優先順位

イベントループの1回のティック（繰り返し）における処理の流れは以下のようになります。

1. **コールスタックの確認**: コールスタックが空になるまで、同期的なコードをすべて実行します。
2. **マイクロタスクキューの処理**: コールスタックが空になったら、**マイクロタスクキューにあるすべてのタスクを実行**します。この処理中に新たなマイクロタスクが追加された場合、それも同じティック内で実行されます。マイクロタスクキューが完全に空になるまで処理は続きます。
3. **タスクキューの処理**: マイクロタスクキューが空になった後、**タスクキューからタスクを1つだけ取り出して実行**します。
4. **レンダリング (ブラウザ環境のみ)**: 必要に応じてレンダリング処理が行われます。
5. **ループの継続**: ステップ1に戻り、ループを繰り返します。

### 重要なポイント

- **マイクロタスクキューは常にタスクキューよりも優先されます**。
- あるイベントループのティックで、マイクロタスクキュー内のすべてのタスクが処理されるのに対し、タスクキューからは1つしかタスクが取り出されません。

### 実行例

以下のコードの実行順序を考えます。

```javascript
console.log("同期処理1");

setTimeout(() => {
  console.log("タスクキュー: setTimeout");
}, 0);

Promise.resolve().then(() => {
  console.log("マイクロタスクキュー: Promise.then");
});

console.log("同期処理2");
```

実行結果は以下のようになります。

```
同期処理1
同期処理2
マイクロタスクキュー: Promise.then
タスクキュー: setTimeout
```

#### 解説

1. `console.log("同期処理1")` がコールスタックに追加され、実行されます。
2. `setTimeout` がWeb APIに渡され、タイマーが即座に完了し、コールバック関数が**タスクキュー**に追加されます。
3. `Promise.resolve().then()` のコールバック関数が**マイクロタスクキュー**に追加されます。
4. `console.log("同期処理2")` が実行されます。
5. コールスタックが空になり、イベントループはまず**マイクロタスクキュー**をチェックします。
6. マイクロタスクキューにある `Promise.then` のコールバックが実行されます。
7. マイクロタスクキューが空になった後、イベントループは**タスクキュー**をチェックし、`setTimeout`のコールバックを実行します。
