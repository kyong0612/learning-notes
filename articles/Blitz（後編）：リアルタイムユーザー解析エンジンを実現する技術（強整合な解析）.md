---
title: "Blitz（後編）：リアルタイムユーザー解析エンジンを実現する技術（強整合な解析）"
source: "https://tech.plaid.co.jp/blitz_realtime_analytics_architecture?secret=plaid&slug=/blitz_realtime_analytics_architecture"
author:
  - "[[Jun Kusahana]]"
published: 2023-05-18
created: 2026-01-21
description: "PLAIDではPersonalizationに特化したリアルタイムユーザー解析エンジン（Blitz）を自分達で開発し、KARTEの基盤として使ってきました。今回新たに刷新した解析エンジンのコア要素である「強整合な解析」を実現する具体的なアーキテクチャ、技術選定の内容を紹介します。"
tags:
  - "clippings"
  - "architecture"
  - "real-time-analytics"
  - "distributed-systems"
  - "Cloud-Bigtable"
  - "data-engineering"
---

## 概要

本記事は、PLAIDが開発したリアルタイムユーザー解析エンジン「Blitz」の刷新において、「強整合な解析」を実現するための具体的なアーキテクチャと技術選定について解説する。前編の「Pre-Aggregation手法」に続く後編として、秒間最大13.4万イベント処理下でも常に最新の統計値を保証する仕組みを詳述している。

## 強整合な解析の定義

- **強整合**：ユーザー統計値が常に最新状態であり、過去全てのイベント履歴が反映されていること
- 秒間最大13.4万イベント処理という高負荷環境下でも整合性を保証
- ルール定義例として、イベント構造（$meta、$buy）を用いた会員判定、購買単価平均、セッション数などの複合条件フィルタリングが可能

## 刷新前のアーキテクチャと課題

### 従来の2コンポーネント構成

| コンポーネント | 役割 |
|---------------|------|
| **Track（リアルタイム側）** | Key-Value Storeから統計値を読み込むのみ |
| **Analyze（非同期側）** | キューのイベントを処理し統計値を更新 |

### 主要な課題

- 非同期処理中のイベントが統計値に未反映
- 結果整合性（Eventual Consistency）にとどまり、強整合性を実現できない

## 刷新後のアーキテクチャ

### フロントエンド・バックエンド二層構成

1. **フロントエンドサーバー**：分散キューへイベントを書き込み
2. **バックエンドサーバー**：キューから読み込み、最新の統計値で解析を実行

### 設計のポイント

- 分散キューを前段に配置することで強整合な解析を実現
- イベントの到着順序を保証しながらリアルタイム処理を可能に

## 高スケーラビリティかつ低レイテンシな分散キュー

### 性能要件

| 要件 | 目標値 |
|------|--------|
| スケーラビリティ | ピーク時 30,000 ops/秒、300 MiB/s |
| レイテンシ | 10ms以内の読み書き |

### 既存サービスの比較検討

| サービス | 高スケーラビリティ | 低レイテンシ | 評価 |
|---------|-------------------|-------------|------|
| Redis Queue | × | ○ | 低レイテンシのみ対応 |
| Cloud PubSub（Ordering付き） | ○ | × | 高スケーラビリティのみ対応 |
| Kafka | △ | △ | 両要件が中程度 |

### 採用技術：Cloud Bigtable

既存サービスでは両要件を満たせないため、**Cloud Bigtable**を採用し、行キースキーマの設計で要件を実現。

#### 行キー設計

```
行キー = ${プレフィックス}_${ユーザーID}_${イベントのtimestamp}
バリュー = イベントデータ
```

#### 設計の利点

- タイムスタンプを付与することでレンジスキャンが可能
- ガベージコレクション機能によるTTL（Time To Live）管理
- ユーザーIDでのパーティショニングにより高スケーラビリティを実現

## 結論と重要な発見

1. **既製品の限界**：低レイテンシとスケーラビリティの両立は、既存の分散キューサービスでは実現困難
2. **独自実装の有効性**：Cloud Bigtableの行キー設計を工夫することで、両要件を同時に満たすことが可能
3. **アーキテクチャ変更の効果**：フロントエンド・バックエンド二層構成と分散キューの組み合わせにより、強整合な解析を実現

## 関連情報

- 前編：Pre-Aggregation手法による自由度と即時更新性の担保
- 続編予告：キャッシュ戦略に関する記事
