# Your Single-Page Applications Are Vulnerable: Here's How to Fix Them

ref: <https://cloud.google.com/blog/topics/threat-intelligence/single-page-applications-vulnerable?hl=en>

## 要約

- クライアントサイドの性質により、シングルページアプリケーション（SPA）は、通常、複数のアクセス制御の脆弱性を抱えています。

- これに対処するために、サポートするAPIに強力なアクセス制御ポリシーを実装することで、クライアントサイドレンダリングに関連するリスクを大幅に軽減することが可能です。

- さらに、SPA内でサーバーサイドレンダリングを使用することで、認可されていないユーザーがページやデータを操作したり閲覧したりすることを防ぐことができます。

## はじめに

シングルページアプリケーション（SPA）は、その動的でユーザーフレンドリーなインターフェースにより人気がありますが、同時にセキュリティリスクを招く可能性もあります。SPAで一般的に採用されるクライアントサイドレンダリングは、不正アクセスやデータ操作に対して脆弱性を持つ可能性があります。このブログ記事では、SPAに内在する脆弱性（ルーティング操作、隠し要素の露出、JavaScriptデバッグなど）を探り、これらのリスクを軽減するための推奨事項を紹介します。

## シングルページアプリケーション（SPA）とは

シングルページアプリケーション（SPA）は、アプリケーションが1つのドキュメントを返し、その内容をJavaScriptによって非表示または表示、またはその他の方法で操作するウェブアプリケーションデザインフレームワークです。これは、従来のPHPや純粋なHTMLサイトで実装される静的ファイルアプリケーションフレームワークや、データ、ビュー、サーバー制御がアプリケーションの異なる部分で処理されるModel-View-Controller（MVC）アーキテクチャとは異なります。

SPAの動的データは、APIコールを通じて更新されるため、ページのリフレッシュや異なるURLへのナビゲーションが不要です。このアプローチにより、SPAはネイティブアプリケーションに近い体験を提供し、シームレスなユーザーエクスペリエンスを実現します。SPAを実装する際に一般的に使用されるJavaScriptフレームワークには、React、Angular、Vueなどがあります。

## クライアントサイドレンダリング

クライアントサイドレンダリングを使用するSPAでは、サーバーはリクエストに対して、CSS、メタデータ、JavaScriptのみを含むHTMLドキュメントを返します。最初に返されるHTMLドキュメントにはコンテンツが含まれておらず、代わりにブラウザ内でJavaScriptファイルが実行されると、アプリケーションのフロントエンドUIとコンテンツがHTMLドキュメントに読み込まれます。

アプリケーションがルーティングを使用するように設計されている場合、JavaScriptはURLを解析し、ユーザーがリクエストしたページを生成しようとします。この間、アプリケーションはAPIエンドポイントにリクエストを送り、データを読み込み、現在のユーザーがそのデータにアクセスする権限があるかどうかを確認します。ユーザーがまだ認証されていない場合、アプリケーションはログインページをレンダリングするか、シングルサインオン（SSO）アプリケーションにリダイレクトします。

これが進行している間、ユーザーは一時的に白い空白ページを目にするかもしれません。この空白ページの背後で、アプリケーションは数十万行の圧縮されたJavaScriptを読み込み、完全なユーザーエクスペリエンスを構築します。SPAは、Netflix、Hulu、Uber、DoorDashなど、世界中で数百万のアプリケーションに使用されています。

## クライアントサイドレンダリングの問題点

SPAが完全にクライアントのブラウザに依存してコンテンツをレンダリング（APIデータを使用）するため、ユーザーはアプリケーションを自由に操作する大きな制御権を持っています。これにより、ユーザーやロールのなりすましが容易になります。

## ルーティング

SPAの実装に使用されるJavaScriptフレームワークの基本的な側面の1つはルートの概念です。これらのフレームワークは、アプリケーション内の異なるページを示すためにルートを使用します。ルートとは、ダッシュボードやユーザープロフィールのように、ユーザーが閲覧できる異なるビューのことを指します。

JavaScriptがクライアントのブラウザによって処理されるため、クライアントはアプリケーションソースに含まれるJavaScriptファイル内でこれらのルートを確認できます。これらのルートを特定できる場合、ユーザーはそれらにアクセスしようと試みる可能性があります。JavaScriptの実装方法によっては、特定のルートにユーザーがアクセスできるかどうかを確認するチェックが存在する場合があります。

## 隠し要素

SPAでは、アクセス制御が隠しページ要素によって処理される場合があります。これは、ページが読み込まれると、アプリケーションがローカル/セッションストレージ、クッキー値、またはサーバー応答を通じてユーザーのロールを確認する仕組みです。その後、アプリケーションはユーザーのロールに基づいて要素を表示または非表示にします。

一部のケースでは、アプリケーションはユーザーがアクセス可能な要素のみをレンダリングします。別のケースでは、すべての要素をレンダリングしますが、「非表示」にするためにCSSプロパティを使用して制御します。しかし、これらの隠された要素はブラウザの開発者ツールを使用することで簡単に露出する可能性があります。これにより、非表示の要素を強制的に表示させることができます。隠された要素には、フォームフィールドや他のページへのリンクが含まれる場合があります。

## JavaScriptデバッグ

モダンブラウザでは、リアルタイムでJavaScriptをデバッグし、ブレークポイントを設定することができます。この機能を使用して、変数を変更したり、関数全体を書き換えたりすることが可能です。コア機能をデバッグすることで、アクセス制御を迂回し、不正にページにアクセスすることができます。

以下はその例です：

```js
function isAuth() {
    var user;
    var cookies = document.cookies;
    var userData = btoa(cookies).split(':');
    if (userData.length == 3) {
        user.name = userData[0];
        user.role = userData[1];
        user.isAuthed = userData[2] === "true";
    } else {
        user.name = "";
        user.role = "";
        user.isAuthed = false;
    }
    return user;
}
```

上記の関数は、ユーザーのクッキーを読み取り、Base64でデコードし、データを分割します。そして値が一致する場合、ユーザーを認証済みと見なします。このようなコア関数を特定できると、攻撃者はクライアントサイドアプリケーションで行われているあらゆる認可・アクセス制御を迂回することが可能になります。

## 悪用

JavaScriptフレームワークの問題を手動で悪用するには時間とスキルが必要ですが、これを容易にするいくつかの手法があります。一般的な方法の1つは、JavaScriptファイルを分析してアプリケーションルートを特定することです。ルートを特定することで、アプリケーションのUIを介さずにページへ直接アクセス（フォースブラウズ）できるようになります。この方法単独で機能する場合もありますが、アプリケーション内のロールチェックを特定する必要がある場合もあります。これらのチェックは、JavaScriptデバッガを使用して、実行中に変数を変更することで認証または認可チェックを迂回できます。

さらに、HTTPプロキシ（例：Burp Suite Professional）を使用して、サーバー応答をキャプチャし、ユーザーオブジェクトを手動で変更する方法も有効です。これらの悪用手法は効果的ですが、本記事で紹介する強力な防止策を実装することで軽減できます。

## 推奨事項

クライアントサイドでレンダリングされるJavaScriptフレームワークにおけるアクセス制御の問題は、構造的な問題です。ユーザーがアプリケーションをブラウザに読み込んだ後、ユーザーがコンテンツに不正アクセスするのを防ぐ有効な対策はほとんどありません。しかし、APIに対して強力なサーバーサイドアクセス制御を実装することで、攻撃者が引き起こせる影響を大幅に削減できます。

例えば、攻撃者が管理者としてのページビューや要求の構造を確認できたとしても、制限されたデータを取得または変更することはできません。

- APIリクエストの監視とログ記録：不正ユーザーが保護されたデータにアクセスを試みているか、成功しているかを検出するために、APIリクエストを監視および記録する必要があります。
- 定期的なペネトレーションテスト：アプリケーションおよびAPIに対する定期的なペネトレーションテストを実施し、セキュリティ上の欠陥を特定することで、問題が悪用される前に修正できます。

## APIアクセス制御

SPAを保護するためには、強力なAPIアクセス制御を実施することが重要です。アクセス制御メカニズムには、JSON Web Token（JWT）やその他の一意で変更不可能なセッション識別子を使用し、セッショントークンの改ざんや偽造を防ぎます。また、APIエンドポイントはセッショントークンを検証し、すべての操作に対してロールベースアクセスを適用する必要があります。

多くの場合、APIはユーザーが認証されているかどうかを確認するように構成されていますが、エンドポイントへのロールベースのアクセスを包括的に確認することはしていません。一部のケースでは、誤った構成のエンドポイント1つがアプリケーション全体を危険にさらす可能性があります。例えば、すべてのアプリケーションエンドポイントがユーザーのロールをチェックしている場合でも、管理者ユーザーを作成するエンドポイントがそのチェックを行っていなければ、攻撃者は任意のロールレベルでユーザーを作成することが可能になります。

以下は、正しいAPIアクセス制御の例です：

### 正しいAPIアクセス制御の例

この例では、ユーザーがアプリケーションに認証を行い、JWT（JSON Web Token）を受け取り、その後ページをレンダリングするプロセスを示しています。

 1. ユーザーがSPAにアクセスし、特定のページをリクエストします。
 2. SPAはユーザーが認証されていないことを認識し、ログインページをレンダリングします。
 3. ユーザーがログインリクエストを送信すると、SPAはAPIリクエストを介してサーバーにその情報を転送します。
 4. サーバーはユーザーが認証されていることを確認し、JWTを返します。このJWTは後続のリクエストで使用されます。
 5. SPAはサーバーからの応答を受け取り、JWTを保存して、元々ユーザーがリクエストしていたダッシュボードをレンダリングします。

このプロセス中、SPAはページを表示するために必要なデータをAPIからリクエストし、サーバーはそのデータを返します。ただし、攻撃者がクライアントサイドアクセス制御を迂回して管理者ページをリクエストしようとした場合、サーバーはユーザーのロールレベルをチェックし、管理者でない場合は403エラーを返します。

この例は、APIアクセス制御がどのようにしてユーザーがAPIデータに不正アクセスするのを防ぐかを示しています。

## サーバーサイドレンダリング

APIアクセス制御以外にも、JavaScriptフレームワークのサーバーサイドレンダリング（SSR）機能を活用することで、この問題を軽減することができます。例えば、SvelteKit、Next.js、Nuxt.js、Gatsbyなどのフレームワークです。サーバーサイドレンダリングは、MVCとSPAアーキテクチャを組み合わせたものです。

サーバーサイドレンダリングでは、すべてのソースコンテンツを一度に配信するのではなく、サーバーがリクエストされたSPAページをレンダリングし、完成したHTMLをユーザーに送信します。この方法では、ルーティング、レンダリング、アクセス制御がすべてサーバー側で処理されます。サーバーは、HTMLをレンダリングする前にアクセス制御ルールを適用できるため、認可されたユーザーだけが特定のコンポーネントやデータを見ることができます。

### サーバーサイドレンダリングの例

以下は、サーバーサイドレンダリングを使用したアプリケーションの例です：

 1. ユーザーが認証されたページをリクエストします。
 2. サーバーはユーザーが認証・認可されているかをチェックします。
 3. 認証されていない場合、アプリケーションはログインページをレンダリングし、それをユーザーに表示します。
 4. ユーザーが認証されると、サーバーはセッションを構築し、必要なクッキーやトークンを設定して、ユーザーをアプリケーションダッシュボードにリダイレクトします。
 5. ユーザーがリダイレクトされた後、サーバーは認証状態を再度確認し、ユーザーがアクセス許可を持つページのデータを取得して、ダッシュボードをレンダリングします。

攻撃者が管理者ページのURLを特定してアクセスを試みた場合でも、サーバーは認証状態とユーザーのロールを確認します。攻撃者が管理者ロールを持たない場合、サーバーは「403 Forbidden」エラーを返すか、エラーページにリダイレクトします。

## 結論

シングルページアプリケーション（SPA）は、動的で魅力的なユーザー体験を提供しますが、クライアントサイドレンダリングを採用する場合、独自のセキュリティ上の課題を招きます。ルーティング操作、隠し要素の露出、JavaScriptデバッグなど、SPAに内在する脆弱性を理解することで、開発者はリスクを軽減するための積極的な対策を講じることができます。

- 強力なサーバーサイドアクセス制御
- APIセキュリティの実施
- サーバーサイドレンダリングの導入

これらの方法は、SPAを不正アクセスやデータ漏洩から保護するための有効な手段です。また、定期的なペネトレーションテストやセキュリティ評価を行うことで、アプリケーションに存在するセキュリティギャップを特定し、それらを攻撃者に悪用される前に修正することができます。セキュリティのベストプラクティスを優先することで、SPAはシームレスなユーザー体験と機密データの安全性の両方を提供できるようになります。
