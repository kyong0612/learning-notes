---
title: "Slackで発見されたHTTPリクエスト・スマグリング"
source: "https://cysec148.hatenablog.com/entry/2025/09/16/072838"
author:
  - "ThisIsOne"
published: 2025-09-16
created: 2025-11-04
description: "セキュリティ研究者がSlackのインフラストラクチャでCL.TE型HTTPリクエスト・スマグリング脆弱性を発見し、6,500ドルのバグバウンティ報奨を獲得した事例。AkamaiとSlackのバックエンド間のHTTPヘッダー処理の不一致を悪用し、セッションクッキーの窃取やアカウント乗っ取りが可能となる脆弱性について解説。"
tags:
  - "security"
  - "http-request-smuggling"
  - "bug-bounty"
  - "slack"
  - "web-security"
  - "vulnerability"
---

## 概要

セキュリティ研究者ThisIsOneがSlackのインフラストラクチャにおいて、CL.TE（Content-Length/Transfer-Encoding）型HTTPリクエスト・スマグリング脆弱性を発見しました。この脆弱性により、攻撃者はセッションクッキーを窃取し、Slackアカウントを乗っ取ることが可能でした。研究者はこの発見により**6,500ドル**のバグバウンティ報奨を受け取りました。

## 1. 発見の経緯

研究者は特に大規模な準備をしていたわけではなく、Slackのサブドメイン（slackb.com）を調査中に「もしかして…」という直感で試してみたのがきっかけでした。

### ハッカー的思考のポイント

- **大手サービスでも古典的な脆弱性が残っている可能性がある**という直感を持つこと
- 深く掘り下げる前に、まず簡単なテストから始めてみること
- 2005年に発見された古典的な脆弱性が、2025年の現代においても大手サービスに存在している事実

## 2. CL.TE型リクエスト・スマグリングの仕組み

### 攻撃リクエストの構造

研究者が送信したリクエストは以下の通りです：

```http
POST / HTTP/1.1
Host: slackb.com
Content-Length: 13
Transfer-Encoding: chunked

0

GET /some/endpoint HTTP/1.1
X-Test: value
```

### 処理の矛盾点

この攻撃が成功した理由は、2つのシステム間でHTTPリクエストの解釈方法が異なっていたためです：

| システム | 優先するヘッダー | 動作 |
|---------|----------------|------|
| **Akamai（リバースプロキシ）** | `Content-Length` | リクエスト本文を13バイトまで読み取り、残りを次のリクエストとして扱う |
| **Slackのバックエンド** | `Transfer-Encoding: chunked` | チャンク形式でリクエストを解析し、`0`でチャンクが終了したと判断 |

### リクエストの境界混乱

この不一致により、以下のような状況が発生します：

1. Akamaiは`Content-Length: 13`に従い、`0`の後の改行までを1つのリクエストとして処理
2. バックエンドは`Transfer-Encoding: chunked`に従い、`0`でリクエストが終了したと判断
3. **残りの`GET /some/endpoint...`の部分が、次のユーザーのリクエストの先頭に紛れ込む**
4. 次のユーザーのリクエストが、攻撃者が仕掛けたGETリクエストと結合されて処理される

## 3. 攻撃の影響範囲

### 検出方法

攻撃者は以下の兆候から脆弱性の存在を確認できます：

- 予期しないレスポンスコードやコンテンツの取得
- 注入したヘッダーがレスポンスに現れる
- **他のユーザーのセッションクッキーが漏洩する**

### 主な被害

この脆弱性により、以下の攻撃が可能になります：

#### セッションハイジャック

- 他のユーザーのセッションクッキーを窃取
- 窃取したクッキーを使用して、対象ユーザーとしてSlackにアクセス可能
- アカウントの完全な乗っ取りが可能

#### キャッシュポイズニング

- 悪意のあるレスポンスをキャッシュに格納
- 複数のユーザーに汚染されたコンテンツを配信

#### XSS（クロスサイトスクリプティング）攻撃

- JavaScriptを注入し、すべてのユーザーのブラウザで実行
- ユーザーの機密情報を窃取

#### CSRF（クロスサイトリクエストフォージェリ）攻撃

- セッションの混乱を悪用して、ユーザーに意図しない操作を実行させる

## 4. 修正と報奨

Slackのセキュリティチームは脆弱性を迅速に確認し、パッチを適用しました。研究者は**6,500ドル**のバグバウンティ報奨を受け取りました。

## 5. 学べる教訓

### セキュリティ研究者向け

1. **古典的な脆弱性を軽視しない**
   - 2005年に発見された脆弱性が、2025年の大手サービスにも存在する可能性がある
   - シンプルなテストが大きな発見につながることがある

2. **複雑な自動化ツールより、シンプルな実験が有効な場合がある**
   - 基本的な理解と直感的なテストの重要性
   - 手動テストの価値を見直す

3. **リクエスト処理の不一致に注目する**
   - フロントエンドとバックエンドの処理方法の違いを理解する
   - プロキシやCDNとアプリケーションサーバー間の挙動の差異を調査する

### システム管理者・開発者向け

1. **フロントエンドとバックエンド間でのリクエスト処理を統一する**
   - すべてのレイヤーで同じHTTPヘッダーの優先順位を設定
   - `Content-Length`と`Transfer-Encoding`の両方が存在する場合の処理ルールを明確化

2. **古典的な脆弱性に対する定期的な監査**
   - 新しい脆弱性だけでなく、古典的な脆弱性も定期的にチェック
   - セキュリティテストにHTTPリクエスト・スマグリングのテストを含める

3. **レイヤー間の整合性を確保**
   - リバースプロキシ、WAF、アプリケーションサーバー間の設定を統一
   - HTTPプロトコルの実装を最新の標準に準拠させる

## タイムライン

- **2025年9月16日**: 脆弱性の発見と報告記事の公開

## 参考資料

- 元記事: [Slackで発見されたHTTPリクエスト・スマグリング](https://cysec148.hatenablog.com/entry/2025/09/16/072838)
