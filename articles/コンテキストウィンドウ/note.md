# コンテキストウィンドウ

ref: <https://docs.anthropic.com/ja/docs/build-with-claude/context-windows>

## コンテキストウィンドウの基本概念

「コンテキストウィンドウ」とは、言語モデルが新しいテキストを生成する際に参照できるテキストの総量と、生成する新しいテキストの合計を指します。これはモデルの「作業メモリ」として機能し、学習データとは異なります。大きなコンテキストウィンドウでは複雑で長いプロンプトの処理が可能ですが、小さなコンテキストウィンドウでは長期的な会話の一貫性維持などが制限されます。

![コンテキストウィンドウの図](https://mintlify.s3.us-west-1.amazonaws.com/anthropic/images/context-window.svg)

APIリクエストの標準的なコンテキストウィンドウの特徴：

- **段階的なトークンの蓄積**: 会話が進むにつれて、各ユーザーメッセージとアシスタントの応答がコンテキストウィンドウ内に蓄積されます
- **線形成長パターン**: コンテキスト使用量は各ターンで線形的に増加し、以前のターンは完全に保持されます
- **20万トークンの容量**: 利用可能な総コンテキストウィンドウは200,000トークンで、会話履歴の保存とClaudeからの新しい出力の生成のための最大容量です
- **入出力フロー**: 各ターンは「入力フェーズ」（過去の会話履歴と現在のユーザーメッセージを含む）と「出力フェーズ」（テキスト応答を生成する）で構成されます

## 拡張思考を伴うコンテキストウィンドウ

拡張思考機能を使用する場合、思考に使用されるトークンを含むすべての入出力トークンがコンテキストウィンドウの制限にカウントされますが、複数ターンの状況では特別な処理が行われます。

![拡張思考を伴うコンテキストウィンドウの図](https://mintlify.s3.us-west-1.amazonaws.com/anthropic/images/context-window-thinking.svg)

- **思考予算のトークン**: `max_tokens`パラメータのサブセットであり、出力トークンとして課金され、レート制限にカウントされます
- **自動的な思考ブロックの除外**: 以前の思考ブロックはAnthropicのAPIによって自動的にコンテキストウィンドウの計算から除外され、後続のターンでモデルが「見る」会話履歴の一部とはなりません
- **トークン容量の効率化**: 実際の会話コンテンツのためのトークン容量が保持されます
- **有効なコンテキストウィンドウの計算式**: `context_window = (input_tokens - previous_thinking_tokens) + current_turn_tokens`
- **思考トークンの範囲**: `thinking`ブロックと`redacted_thinking`ブロックの両方が含まれます

## 拡張思考とツール使用を組み合わせた場合

![拡張思考とツール使用を伴うコンテキストウィンドウの図](https://mintlify.s3.us-west-1.amazonaws.com/anthropic/images/context-window-thinking-tools.svg)

拡張思考とツール使用を組み合わせた場合のコンテキストウィンドウの処理は3つの段階で行われます：

**1. 最初のターン**

- **入力**: ツール設定とユーザーメッセージ
- **出力**: 拡張思考 + テキスト応答 + ツール使用リクエスト
- **トークン計算**: すべての入出力コンポーネントがコンテキストウィンドウにカウントされます

**2. ツール結果の処理（ターン2）**

- **入力**: 最初のターンのすべてのブロックと`tool_result`
- **重要ポイント**: 拡張思考ブロックは対応するツール結果とともに**必ず**返す必要があります
- **出力**: ツール結果の処理後、Claudeはテキストのみで応答します（次の`user`メッセージまで追加の拡張思考はありません）

**3. 後続のターン**

- **入力**: すべての入力と前のターンの出力が、思考ブロックを除いて引き継がれます
- **思考ブロックの扱い**: ツール使用サイクル完了後に削除可能で、APIは自動的に除外します
- **出力**: 新しい`User`ターンがあるため、Claudeは新しい拡張思考ブロックを生成します

**重要な考慮事項**:

- ツール結果を投稿する際は、そのツールリクエストに付随する完全な未修正の思考ブロックを含める必要があります
- システムは暗号署名を使用して思考ブロックの真正性を確認します
- 思考ブロックを修正するとAPIはエラーを返します
- 拡張思考ブロック内でのツール使用は現在サポートされていません

## 新しいClaudeモデルでのコンテキストウィンドウ管理

Claude 3.7 Sonnet以降のモデルでは、コンテキストウィンドウの扱いに重要な変更があります：

- プロンプトトークンと出力トークンの合計がモデルのコンテキストウィンドウを超える場合、システムは**コンテキストを暗黙的に切り詰めるのではなく、検証エラーを返します**
- この変更はより予測可能な動作を提供しますが、より慎重なトークン管理が必要です
- トークン使用量を計画するには「[トークンカウントAPI](https://docs.anthropic.com/ja/docs/build-with-claude/token-counting)」を使用して、メッセージ送信前にトークン数を見積もることができます
- モデル別のコンテキストウィンドウサイズは「[モデル比較](https://docs.anthropic.com/ja/docs/models-overview#model-comparison)」表で確認できます

このアーキテクチャはトークン効率が良く、特に拡張思考ブロックが長くなる可能性がある場合でも、トークンの無駄なく広範な推論を可能にします。
