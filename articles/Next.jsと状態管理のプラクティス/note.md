---
title: "Next.jsと状態管理のプラクティス"
source: "https://speakerdeck.com/uhyo/next-dot-jstozhuang-tai-guan-li-nopurakuteisu"
author:
  - "uhyo"
published:
created: 2025-05-14
description: |
  Next.js (App Router) や React Server Components にまだ慣れていない開発者を対象に、状態管理を効果的に行う方法について考察するプレゼンテーション。
tags:
  - "Next.js"
  - "React"
  - "状態管理"
  - "サーバーコンポーネント"
  - "フロントエンド開発"
---

## 概要

本プレゼンテーションは、Next.js (App Router) および React Server Components (RSC) を使用する際の状態管理のプラクティスについて解説します。特に、RSCにまだ慣れていない開発者を対象に、サーバーコンポーネントとクライアントコンポーネントを効果的に組み合わせ、状態管理を最適化する考え方と具体的な手法を提案します。

## 目次 (スライド構成より)

1. **はじめに**
    * タイトル: Next.jsと状態管理のプラクティス
    * 発表者: uhyo (株式会社カオナビ フロントエンドエキスパート)
    * 対象: Next.js (App Router) / React Server Components にまだ慣れない方
    * 目的: 状態管理をいい感じにやる方法について考える
2. **これまでの復習: React Server Components の基本**
    * RSC は多段階計算として捉えられる (サーバーコンポーネント → クライアントコンポーネント)
    * サーバーコンポーネントの特性:
        * サーバー側でキャッシュが効く
        * クライアントの計算を削減 (場合によっては転送量も)
        * データ取得にネットワークを経由する必要あり
    * クライアントコンポーネントの特性:
        * サーバーを介さずに再レンダリング可能
        * クライアントでJavaScriptを実行する必要あり
    * 使い分け: 土台はサーバーコンポーネント、インタラクションが必要な部分はクライアントコンポーネント (アイランドアーキテクチャ)
    * RSC の利点: 従来クライアントサイドで持っていたステートでも、インタラクションに影響しないものはサーバーコンポーネントに担わせることでクライアントのステートを削減可能。
3. **実例1: Todoアプリにおける状態管理**
    * 一般的なTodoアプリをNext.jsで実装するケースを想定。
    * AIによる初期実装例:
        * サーバーコンポーネントでTodoデータを取得。
        * Todo更新時は `revalidatePath` でキャッシュを破棄し、サーバーコンポーネントを再レンダリング。
    * 問題点:
        1. `revalidatePath` ではページ全体が再レンダリングされ、小さな変更でもデータ再受信の無駄が大きい。
        2. 変更の影響範囲をパスで管理するのは微妙 (`revalidateTag` の方がマシだがキャッシュキー管理が煩雑)。
    * アイデア: **差分だけステート管理する**
        * Todoアイテムのチェック状態など、インタラクティブな部分のみクライアントコンポーネントでローカルステートとして管理。
        * サーバーから取得したデータ (allTodos) とローカルステート (checkedState) を組み合わせて最終的な表示データ (finalTodos) を計算。
        * これにより、不要な通信を避け、UIへ素早く反映可能。
        * このアプローチは「サーバーから送られてきたデータを土台とし、その上にインタラクションをクライアント側で実装する」という考え方。
4. **実例2: Todoアプリに無限スクロールを実装**
    * 要件: 無限スクロールを実装し、差分データのみダウンロードしたい。
    * サーバーコンポーネントごとの再レンダリングは非効率。
    * アイデア: **ここでもステートで差分を管理**
        * サーバーから取得した最初の1ページ分のデータをクライアントコンポーネントの初期ステートとして利用。
        * 追加データはクライアントサイドでフェッチし、既存のステートにマージしていく。
5. **まとめ**
    * Next.jsにおける状態管理のプラクティスとして、サーバーコンポーネントをページの「土台」として使用する考え方を紹介。
    * インタラクションに関わる部分や、頻繁に更新される細かなデータはクライアントコンポーネントのステートで管理し、サーバーから取得したデータと組み合わせる。
    * この方法が常に正解とは限らないが、Next.jsの機能を活かしつつ状態管理を行うための一つの有効なアプローチである。

## 重要な結論・発見

* React Server Components (RSC) の導入により、状態管理の考え方が変化。サーバーコンポーネントを「土台」とし、クライアントコンポーネントで「差分」や「インタラクション」を管理するアプローチが有効。
* `revalidatePath` や `revalidateTag` によるキャッシュ戦略は、UIの細かな更新には不向きな場合があり、クライアントサイドでの楽観的更新や部分的な状態管理が求められる。
* サーバーから取得したデータを初期値としつつ、ユーザー操作による変更はクライアントのローカルステートで管理することで、パフォーマンスとユーザー体験を両立できる。

## 視覚的要素 (スライドへの言及)

本資料はスライド形式であり、各要点はテキストと図解で説明されています。詳細なコード例や図については、元の[Speaker Deck](https://speakerdeck.com/uhyo/next-dot-jstozhuang-tai-guan-li-nopurakuteisu)をご参照ください。

* スライド6: RSCの多段階計算の図解
* スライド19-20: 「差分だけステート管理する」アイデアのコード例
* スライド25: 無限スクロールにおける「ステートで差分を管理する」コード例

## 制限事項

* 本プレゼンテーションで示されたプラクティスは一例であり、アプリケーションの要件や特性に応じて最適な状態管理戦略は異なります。
* 詳細な実装やエッジケースについては触れられていない部分もあります。
