---
title: "Go 1.26 は、軽くなり速くなる"
source: "https://zenn.dev/mattn/articles/64c47f937a522f"
author:
  - "mattn"
published: 2025-12-25
created: 2025-12-26
description: |
  Go 1.26で導入された2つの主要なパフォーマンス改善について解説。Green Tea GCがデフォルトで導入されGCオーバーヘッドが10～40%削減、syscall呼び出しの高速化により短時間のシステムコールが約30%高速化。具体的なベンチマーク結果と適用条件を詳しく説明。
tags:
  - "Go"
  - "GC"
  - "パフォーマンス"
  - "syscall"
  - "cgo"
  - "clippings"
---

## Go 1.26 は、軽くなり速くなる

この記事は [Go Advent Calendar 2025](https://qiita.com/advent-calendar/2025/go) の最終日（25日目）の記事です。Go 1.26は派手さはないものの、Goユーザーにとって大きなリリースとなる。短く言えば「軽くなり」「速くなる」という2つのパフォーマンス改善が実現された。

## パフォーマンスに関する大きな変更2つ

### Green Tea GC

Go 1.25まで実験的に導入されていた **Green Tea GC** が、Go 1.26でデフォルトで導入された。

#### 従来のGCの問題点

これまでのGCは、ヒープ上のオブジェクトへのポインタを追跡して個別にマークしていた。その結果：

- メモリアクセスがランダムになりキャッシュミスが多発
- CPUキャッシュに不要なデータがロードされる
- 細かなオブジェクトが多く生成されるケースでGCに時間がかかる

#### Green Tea GCの改善

Green Tea GCは、ヒープを連続したメモリブロック（span）単位で取り扱うように変更し、数多くのオブジェクトをまとめてスキャンするようになった。これにより：

- キャッシュ効率が向上
- GCのCPU使用時間が大幅に減少

![Green Tea GCの説明図](https://storage.googleapis.com/zenn-user-upload/f1f657e9267a-20251222.png)

#### パフォーマンス改善

- **GCオーバーヘッドが10～40%削減** されると見込まれる
- 新しいamd64ベースのCPUプラットフォーム（Intel Ice LakeまたはAMD Zen 4以降）では、さらに10%程度の改善が見込まれる

詳細は [Go公式ブログのGreen Tea GC記事](https://go.dev/blog/greenteagc) を参照。

### syscall 呼び出しの高速化

Go言語のパフォーマンスに関する話題の1つが、syscall呼び出しのオーバーヘッドだった。

#### G-M-Pモデルと状態遷移

Goのランタイムは、G-M-Pモデルに基づいてgoroutineの状態とスケジューリングを管理している：

- **G（goroutine）**: `_Grunning`, `_Grunnable`, `_Gsyscall`, `_Gwaiting` などの状態
- **M（OSスレッド）**: Goのコードを実行する
- **P（processor）**: `_Prunning`, `_Pidle`, `_Psyscall` などの状態

MがGoのコードを実行するには、必ずPを1つ保持する必要がある。

#### 従来の動作

これまでのランタイムでは、実行中のgoroutineからシステムコールを呼び出す際：

- Gは `_Gsyscall` に遷移
- Pは `_Psyscall` に遷移して一時的に解放

この状態遷移のためにCAS（Compare-And-Swap）が行われていた。

#### 改善後の動作

今回の変更により：

- Pは `_Psyscall` に遷移せず、Gを `_Gsyscall` にしたまま（短時間の呼び出しではPを保持して）システムコールを呼び出す
- 長時間ブロックすると判断された場合は、従来通りPは解放される
- CASが1回分不要になった

#### ベンチマーク結果

**syscall呼び出しのベンチマーク**（`syscall.SYS_GETPID`を使用）:

```text
Go 1.25: 455.1n ± ∞ sec/op
Go 1.26: 314.0n ± ∞ sec/op
改善率: -31.00%
```

**cgo呼び出しのベンチマーク**（`getenv`を使用）:

```text
Go 1.25: 169.7n ± ∞ sec/op
Go 1.26: 123.2n ± ∞ sec/op
改善率: -27.40%
```

実測値で約30%の高速化が確認された。

#### 適用条件

この変更により速くなるケースは、以下の条件に限定される：

1. 非常に短い syscall / cgo を
2. tight loop で
3. 高頻度に
4. CPU-bound で呼ぶ場合

**注意点**:

- Goのみのビジーループや、比較的重たいシステムコール呼び出し（例: read/write）を含むGoのコードが速くなるわけではない
- `net/http` が速くなる可能性は低い
- `go-sqlite3` のような細粒度APIを持つcgoではパフォーマンスが向上する可能性がある

## まとめ

Go 1.26では大きく2つのパフォーマンス改善が行われた：

1. **Green Tea GC**: デフォルト導入により、GCオーバーヘッドが10～40%削減。ほぼすべてのユーザーが恩恵を得られる
2. **syscall呼び出しの高速化**: 短時間のシステムコールが約30%高速化。適用条件は限定的だが、該当するケースでは大きな改善が見込める

これらの改善により、Go 1.26は「軽くなり」「速くなる」リリースとなった。
