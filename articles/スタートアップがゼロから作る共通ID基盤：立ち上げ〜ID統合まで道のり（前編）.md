---
title: "スタートアップがゼロから作る共通ID基盤：立ち上げ〜ID統合まで道のり（前編）"
source: "https://kaminashi-developer.hatenablog.jp/entry/2025/09/02/id-integration-part1"
author:
  - "トモ=ロウ（カミナシ認証認可ユニット）"
published: 2025-09-02
created: 2025-09-04
description: "カミナシが単一プロダクトから複数プロダクトへと事業拡大する過程で、共通ID基盤を構築し既存システムを統合した実体験を詳細に記録した技術記事。認証機能の切り離し、ダブルライト方式でのゼロダウンタイム移行、OIDC準拠のIDプロバイダー実装まで、実際の開発者視点から得た知見と課題を包括的に解説している。"
tags:
  - "認証認可"
  - "ID基盤"
  - "マルチプロダクト"
  - "OIDC"
  - "データ移行"
  - "ゼロダウンタイム"
  - "マイクロサービス"
  - "SaaS"
---

## 概要

株式会社カミナシの認証認可ユニットのトモ=ロウ氏による、共通ID基盤構築プロジェクトの実体験記録。カミナシが『カミナシ レポート』という単一プロダクトから『カミナシ 従業員』を含む複数プロダクト体制へと移行する過程で直面した課題と解決策を、技術的詳細と共に包括的に解説している。

## はじめに

### なぜ共通ID基盤が必要だったのか

**課題の背景：**

- カミナシは2024年8月まで『カミナシ レポート』単一のプロダクトを提供
- 従来は典型的な**モノリシックアーキテクチャ**でID管理・認証機能がアプリケーション内に組み込まれていた
- マルチプロダクト化により以下の問題が顕在化：
  - プロダクトごとに別アカウントが必要になる煩雑なユーザー体験
  - 各プロダクトでの独自認証機能実装による開発工数肥大化
  - サービス間で一貫性のないセキュリティポリシー

**解決の必要性：**

- ユーザーにシームレスな体験を提供
- 効率的な開発体制の構築
- 共通ID基盤による統一されたセキュリティポリシーの実現

## プロジェクトの全体像

**ID統合プロジェクトの概略図**を通じて、2023年4月から開始された長期プロジェクトの全体的な流れを示している。段階的な移行戦略により、既存サービスへの影響を最小限に抑えながら統合を進める設計となっている。

## 第1章：認証機能の切り離しと段階的な移行戦略

### 戦略的判断

**2023年4月：** 『カミナシ ID管理』の開発着手

**重要な設計判断：**

- **ユーザーデータの移行を後回しにする**戦略を採用
- 認証機能のオーナーシップの早期確立を優先
- 開発責任範囲の明確化と迅速な意思決定体制の構築

### 段階的移行のメリット

- **リスクの段階的管理：** 小さな変更から着手することで影響範囲を限定
- **ロールバックの容易性：** 問題発生時の迅速な対応が可能
- **実際の効果：** 想定外のトラフィックスパイク問題の早期発見と対応

**具体的な課題例：**

- ピーク時トラフィック量の想定不足
- 10秒単位で均されたメトリクスでは捉えきれない瞬間的なスパイクトラフィック
- インフラ構成の迅速な調整対応

## 第2章：ゼロダウンタイム移行「ダブルライト」への挑戦

### 実装背景

**2023年7月：** ユーザーデータ移行プロジェクト開始

**課題：**

- 深夜稼働する工場での24時間利用
- 長時間システム停止によるお客様業務への影響回避の必要性

### ダブルライト手法の詳細

**実装概要：**

- 新しいユーザーデータを『カミナシ レポート』と『カミナシ ID管理』の両データベースに同時書き込み
- データ移行と認証時の参照先切り替えを分離することでリスク軽減

**技術的な複雑性：**

**エラーハンドリング：**

1. **通常のエラー：** 『カミナシ ID管理』エラー時の『カミナシ レポート』トランザクションロールバック
2. **複雑なケース：** コミット失敗時の補償トランザクション実装
   - 作成 → 削除リクエスト送信
   - 更新 → 更新前データでの更新リクエスト送信
   - 削除 → 作成リクエスト送信
3. **最終手段：** 補償トランザクション失敗時の手動リカバリ体制

### プロジェクト管理上の課題と学び

**実装者の背景による課題：**

- 筆者が元『カミナシ レポート』開発メンバーであることによる説明不足
- ステークホルダーへの十分な説明機会の欠如
- プロジェクト全貌把握機会の不提供

**影響：**

- 技術的問題の発生（詳細は後編で紹介予定）
- ボディーブローのような長期的な影響

**成果：**

- **2023年10月：** 約1ヶ月間のダブルライト期間を経て全ユーザーデータ移行完了
- 両システム間でのデータ整合性確保
- 安全なロールバック体制の構築

## 第3章：共通基盤としてのはじめの一歩

### OpenID Connect（OIDC）対応

**2023年12月リリース：** 『カミナシ ID管理』のOIDC準拠IDプロバイダー化

**採用理由：**

- OAuth 2.0ベースの業界標準プロトコル
- 確立されたセキュリティベストプラクティス
- 豊富な拡張仕様によるノンデスクワーカー向けユースケース対応

**移行戦略：**

- 『カミナシ レポート』：開発スケジュールの都合で独自認証方式を継続
- 新規プロダクト（『カミナシ 従業員』など）：最初からOIDC準拠フローを採用

### ユーザー管理機能の提供

**2024年2月：** 『カミナシ ID管理』管理画面の誕生

**機能分離戦略：**

- 『カミナシ レポート』ユーザー：既存のユーザー管理画面を継続利用
- 新規プロダクトユーザー：『カミナシ ID管理』の管理画面を利用
- お客様への説明コストと機能ギャップによるハレーション回避

## プロジェクトの中間成果（2024年2月時点）

### 完了した作業

1. **認証機能の分離：** 『カミナシ レポート』からの認証機能切り離し
2. **データ移行：** ユーザーデータの『カミナシ ID管理』への移行
3. **OIDC対応：** 業界標準プロトコルへの準拠
4. **管理機能：** ユーザー管理画面の提供

### 残存課題

- 『カミナシ レポート』の独自ログインフロー継続
- ユーザー管理画面の複数存在
- 認証機能の重複状態
- 各種ワークアラウンドの存在

## 次回予告（後編への導入）

**2024年3月：** 残存課題解決のための新プロジェクト開始

**後編で扱う予定の内容：**

- 技術的課題と具体的解決方法
- マルチプロダクト化で新たに見えてきた課題
- 真の共通ID基盤実現への道のり

## 重要な学びと示唆

### 技術戦略

1. **段階的移行の重要性：** リスク管理と問題の早期発見
2. **ダブルライト手法の有効性：** ゼロダウンタイム移行の実現
3. **業界標準の採用：** OIDC準拠によるセキュリティと拡張性の確保

### プロジェクト管理

1. **ステークホルダーコミュニケーションの重要性：** 十分な説明と情報共有の必要性
2. **チーム間連携の課題：** 既存チームとの調整における注意点
3. **長期的視点の必要性：** 短期的な成功と長期的な影響の両立

### 制限事項

- 記事は前編のため、具体的な技術的問題の詳細や最終的な解決方法は後編で紹介予定
- プロジェクトの完全な成果と最終的な教訓は後編を待つ必要がある
