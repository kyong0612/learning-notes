# A practical guide to building agents

ref: <https://cdn.openai.com/business-guides-and-resources/a-practical-guide-to-building-agents.pdf>

このガイドは、製品チームやエンジニアリングチームが初めてのエージェントを構築する際の参考となるよう、多くの顧客導入事例から得られた実践的なベストプラクティスをまとめたものです。有望なユースケースの特定、エージェントのロジックとオーケストレーションの設計パターン、そしてエージェントを安全かつ予測可能に、効果的に実行するためのベストプラクティスが含まれています。

## 目次

- エージェントとは何か？
- いつエージェントを構築すべきか？
- エージェント設計の基礎
- ガードレール
- 結論

## エージェントとは何か？

エージェントは、ユーザーに代わって独立してタスクを遂行するシステムです。従来のソフトウェアがワークフローの効率化や自動化を可能にするのに対し、エージェントは高度な自律性を持ってユーザーに代わってワークフローを実行できます。

エージェントの主な特徴：

1. **LLMによるワークフロー実行と意思決定:** ワークフローの完了を認識し、必要に応じて行動を修正できます。失敗した場合は実行を停止し、ユーザーに制御を戻します。
2. **ツールへのアクセス:** 外部システムと対話し、コンテキスト収集やアクション実行のために様々なツールにアクセスし、状況に応じて適切なツールを動的に選択します。常に明確に定義されたガードレール内で動作します。

## いつエージェントを構築すべきか？

エージェントは、従来の決定論的およびルールベースのアプローチが不十分なワークフロー、特に以下の特性を持つワークフローに適しています。

1. **複雑な意思決定:** 微妙な判断、例外処理、文脈依存の決定が伴うワークフロー（例: カスタマーサービスの返金承認）。
2. **維持困難なルール:** 広範で複雑なルールセットにより、更新が高コストまたはエラーが発生しやすいシステム（例: ベンダーのセキュリティレビュー）。
3. **非構造化データへの強い依存:** 自然言語の解釈、文書からの意味抽出、ユーザーとの対話的なやり取りが含まれるシナリオ（例: 住宅保険請求の処理）。

エージェント構築に着手する前に、ユースケースがこれらの基準を満たしているかを確認してください。そうでなければ、決定論的なソリューションで十分かもしれません。

## エージェント設計の基礎

エージェントは基本的に3つのコアコンポーネントで構成されます。

1. **モデル:** エージェントの推論と意思決定を支えるLLM。
2. **ツール:** エージェントがアクションを実行するために使用できる外部関数またはAPI。
3. **指示:** エージェントの振る舞いを定義する明確なガイドラインとガードレール。

### モデルの選択

- **タスクの複雑さ、レイテンシ、コスト**のトレードオフを考慮します。
- **プロトタイプ作成:** 最も高性能なモデルでベースラインを確立します。
- **最適化:** より小さなモデルを試して、許容可能な結果が得られるかを確認し、コストとレイテンシを最適化します。

### ツールの定義

ツールはエージェントの能力を拡張します。APIがないレガシーシステムの場合、エージェントはコンピュータ利用モデルを使用してUIを介して直接対話できます。

ツールは標準化された定義を持つべきで、柔軟な多対多の関係を可能にします。文書化され、テストされた再利用可能なツールは、発見可能性を高め、バージョン管理を簡素化し、冗長な定義を防ぎます。

ツールの種類:

- **データツール:** コンテキストや情報を取得（例: データベースクエリ、PDF読み取り、ウェブ検索）。
- **アクションツール:** システムと対話してアクションを実行（例: メール送信、CRMレコード更新、人間へのエスカレーション）。
- **オーケストレーションツール:** 他のエージェントのツールとして機能するエージェント（例: 返金エージェント、リサーチエージェント）。

必要なツール数が増える場合は、タスクを複数のエージェントに分割することを検討します（オーケストレーションを参照）。

### 指示の設定

高品質な指示はエージェントにとって特に重要です。明確な指示は曖昧さを減らし、エージェントの意思決定を改善し、ワークフロー実行をスムーズにし、エラーを減らします。

指示作成のベストプラクティス:

- **既存文書の活用:** 既存の運用手順、サポートスクリプト、ポリシードキュメントを使用します。
- **タスクの分解:** 密度の高いリソースから、より小さく明確なステップを提供します。
- **明確なアクションの定義:** 各ステップを特定のアクションまたは出力に対応させます。
- **エッジケースの捕捉:** 不完全な情報提供や予期しない質問など、一般的なバリエーションを予測し、対処方法を含めます。

`o1`や`o3-mini`のような高度なモデルを使用して、既存の文書から指示を自動生成できます。

## オーケストレーション

エージェントがワークフローを効果的に実行できるようにするためのオーケストレーションパターンを検討します。段階的なアプローチが一般的に成功しやすいです。

オーケストレーションパターンは主に2つのカテゴリに分類されます。

1. **単一エージェントシステム:** 単一モデルがツールと指示を備え、ループ内でワークフローを実行します。
2. **複数エージェントシステム:** ワークフロー実行が複数の調整されたエージェントに分散されます。

### 単一エージェントシステム

単一エージェントは、ツールを段階的に追加することで多くのタスクを処理でき、複雑さを管理しやすく、評価とメンテナンスを簡素化します。

すべてのオーケストレーションアプローチには「実行（run）」の概念が必要で、通常はエージェントが終了条件に達するまで動作するループとして実装されます。一般的な終了条件には、ツール呼び出し、特定の構造化出力、エラー、または最大ターン数到達が含まれます。

プロンプトテンプレートを使用すると、複数エージェントフレームワークに切り替えずに複雑さを管理できます。個別のプロンプトを多数維持する代わりに、ポリシー変数を受け入れる単一の柔軟なベースプロンプトを使用します。

### 複数エージェントを検討するタイミング

単一エージェントの能力を最大限に活用することを推奨します。複数エージェントは概念の分離を提供しますが、複雑さとオーバーヘッドが増加する可能性があります。

エージェントが複雑な指示に従えなかったり、一貫して誤ったツールを選択したりする場合、システムをさらに分割し、より多くの異なるエージェントを導入する必要があるかもしれません。

エージェント分割の実践的なガイドライン:

- **複雑なロジック:** プロンプトに多くの条件文が含まれ、プロンプトテンプレートがスケーリングしにくい場合。
- **ツールの過負荷:** ツールの数だけでなく、類似性や重複が問題となる場合。ツールの明確性を向上させてもパフォーマンスが改善しない場合。

### 複数エージェントシステム

複数エージェントシステムには、主に2つのパターンがあります。

1. **マネージャーパターン (ツールとしてのエージェント):** 中央の「マネージャー」エージェントが、ツール呼び出しを介して複数の専門エージェントを調整します。
2. **分散パターン (エージェント間のハンドオフ):** 複数のエージェントがピアとして動作し、専門分野に基づいてタスクを相互に引き渡します。

複数エージェントシステムはグラフとしてモデル化でき、エージェントはノードとして表されます。

### マネージャーパターン

中央のLLM（マネージャー）が、ツール呼び出しを通じて専門エージェントのネットワークをシームレスに調整します。マネージャーはタスクを適切なエージェントにインテリジェントに委任し、結果を統合して一貫した対話を実現します。単一のエージェントがワークフロー実行を制御し、ユーザーにアクセスするワークフローに最適です。

### 分散パターン

エージェントがワークフロー実行を互いに「ハンドオフ」できます。ハンドオフは、エージェントが別のエージェントに委任できるようにする一方向の転送です。このパターンは、単一のエージェントが中央制御や統合を維持する必要がない場合に最適です。各エージェントが必要に応じて実行を引き継ぎ、ユーザーと対話できます。会話のトリアージなどのシナリオに特に効果的です。

## ガードレール

ガードレールは、データプライバシーリスク（例: システムプロンプトの漏洩防止）や評判リスク（例: ブランドに沿ったモデルの振る舞いの強制）を管理するのに役立ちます。複数の専門的なガードレールを組み合わせて使用することで、より回復力のあるエージェントを作成します。

ガードレールの種類:

- **関連性分類器:** 意図した範囲内に応答を留める。
- **安全性分類器:** 不正な入力（ジェイルブレイクやプロンプトインジェクション）を検出。
- **PIIフィルター:** 個人識別可能情報（PII）の不要な公開を防ぐ。
- **モデレーション:** 有害または不適切な入力をフラグ付け。
- **ツールセーフガード:** 各ツールのリスクを評価し、自動アクションをトリガー（例: 高リスク機能実行前に一時停止）。
- **ルールベースの保護:** 既知の脅威（禁止用語、SQLインジェクション）を防ぐための単純な決定論的措置（ブロックリスト、入力長制限、正規表現フィルター）。
- **出力検証:** プロンプトエンジニアリングとコンテンツチェックを通じて、応答がブランド価値と一致することを確認。

ガードレールの構築:

1. データプライバシーとコンテンツの安全性に焦点を当てます。
2. 実際のユースケースや遭遇した失敗に基づいて新しいガードレールを追加します。
3. セキュリティとユーザーエクスペリエンスの両方を最適化し、エージェントの進化に合わせてガードレールを調整します。

### 人間の介入計画

人間の介入は、ユーザーエクスペリエンスを損なうことなくエージェントの実世界のパフォーマンスを向上させるための重要なセーフガードです。特に導入初期に重要であり、失敗の特定、エッジケースの発見、堅牢な評価サイクルの確立に役立ちます。

人間の介入メカニズムを実装することで、エージェントはタスクを完了できない場合に制御をスムーズに移行できます。

人間の介入を必要とする主なトリガー:

- **失敗しきい値の超過:** エージェントの再試行やアクションの制限を設定します。
- **高リスクアクション:** 機密性が高い、元に戻せない、または影響が大きいアクション。

## 結論

エージェントはワークフロー自動化の新時代を切り開きます。システムは曖昧さを推論し、ツール間でアクションを実行し、高度な自律性を持って複数ステップのタスクを処理できます。

信頼性の高いエージェントを構築するには、強力な基盤から始めます：高性能なモデルと、明確に定義されたツール、構造化された指示を組み合わせます。複雑さのレベルに合ったオーケストレーションパターンを使用し、単一エージェントから始めて必要に応じて複数エージェントシステムに進化させます。ガードレールは、入力フィルタリングやツール使用から人間参加型の介入まで、あらゆる段階で重要であり、エージェントが本番環境で安全かつ予測可能に動作することを保証します。

成功への道は、オールオアナッシングではありません。小さく始め、実際のユーザーで検証し、時間をかけて能力を成長させます。適切な基盤と反復的なアプローチにより、エージェントはタスクだけでなく、インテリジェンスと適応性をもってワークフロー全体を自動化し、真のビジネス価値を提供できます。

---

**注記:** 元のドキュメントに含まれる画像や図表は、この要約には含まれていません。また、コードスニペットはPythonで記述されています。
