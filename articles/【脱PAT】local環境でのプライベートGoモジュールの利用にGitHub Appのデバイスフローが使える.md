---
title: "【脱PAT】local環境でのプライベートGoモジュールの利用にGitHub Appのデバイスフローが使える"
source: "https://kaminashi-developer.hatenablog.jp/entry/2025/07/09/local-private-go-module-github-app-device-flow"
author:
  - "mina"
published: 2025-07-09
created: 2025-07-10
description: "突然ですが、あなたの.netrcや環境変数に、ghp_...から始まる”あの文字列“、そっと忍ばせていませんか？ そう、GitHubのPersonal Access Token (PAT) です。 「自分しか使わないから」「有効期限なしが一番ラクだから」しかしその”魔法の文字列”は、開発効率を上げる便利な鍵であると同時に、ひとたび漏洩すれば全てを危険に晒す諸刃の剣。 果たして、この便利で危険な”魔法”を、私たちは本当に封印できるのでしょうか……？ local環境でセキュアにプライベートGoモジュールをダウンロードしたい こんにちは。カミナシ認証認可ユニットで共通ID基盤を開発しているminaで…"
tags:
  - "Go"
  - "GitHub"
  - "OAuth"
  - "Security"
  - "GitHub App"
---

## TL;DR

この記事では、ローカルのコンテナ開発環境でプライベートなGoモジュールを利用する際に、セキュリティリスクの高いPersonal Access Token (PAT) を使わずに、GitHub Appのデバイスフローを活用してセキュアかつ便利に認証を行う方法を解説しています。有効期限が短く、権限を最小限に絞ったアクセストークンを簡単な操作で取得できるため、セキュリティと開発者体験を両立させることができます。

## 課題: ローカル環境でのプライベートGoモジュールのセキュアな利用

GoモジュールがGitHubのプライベートリポジトリで管理されている場合、ローカルのコンテナ環境で `go mod download` するにはPATなどのGitHubクレデンシャルが必要です。

![](https://cdn-ak.f.st-hatena.com/images/fotolife/k/kaminashi-developer/20250708/20250708212005.png)

しかし、PATには以下のような問題点があります。

* **高いセキュリティリスク**:
  * 開発者任せにすると、過剰な権限や無期限のトークンが使われがち。
  * 漏洩した場合の影響が大きい。
* **悪い開発者体験**:
  * PATの定期的な手動ローテーションは煩雑。

これらの問題を解決するため、以下の要件を満たす必要がありました。

* **セキュリティ**: クレデンシャルの有効期間は短く、権限は必要最小限にすること。
* **開発者体験**: クレデンシャル取得のユーザー操作を最小限にすること。

## 解決策: GitHub App と デバイスフローの活用

この課題は、**GitHub Appのユーザーアクセストークン**と**デバイスフロー**を組み合わせることで解決できます。

### GitHub App ユーザーアクセストークン

* **有効期限**: 8時間と短い。
* **権限**: ユーザーとGitHub Appの両方が持つ権限の範囲内に制限される。

これにより、プライベートリポジトリの読み取り権限のみを持つ、短命なトークンを安全に利用できます。

### OAuth デバイスフロー (RFC 8628)

デバイスフローは、アプリケーション（コンテナ）とユーザー認証・認可（ホストマシン）が異なる端末で行われることを想定したOAuthの認可方式です。

![](https://cdn-ak.f.st-hatena.com/images/fotolife/k/kaminashi-developer/20250708/20250708212454.png)

コンテナ上で対話的なプロンプトなしに認証を完了できるため、今回のユースケースに最適です。

> **Note**: GitHub Appのデバイスフローは記事執筆時点でパブリックプレビューです。

## 実装方法

### 1. GitHub Appの作成と設定

* リポジトリ権限 (`Repository Permissions`) > `Contents` を `read-only` に設定したGitHub Appを作成します。
* 作成したAppを、プライベートGoモジュールが格納されているリポジトリにインストールします。

### 2. デバイスフローを実行するシェルスクリプト

以下の処理を行うシェルスクリプトを用意し、コンテナ上で実行します。

1. GitHubにデバイスコードとユーザーコードを要求します。
2. コンテナログに認証用のURLとユーザーコードを表示し、ユーザーにブラウザでの入力を促します。
3. ユーザーが認可を完了するまで、アクセストークンをポーリングします。
4. アクセストークン取得後、`git config`コマンドでgitがHTTPS経由でリポジトリにアクセスできるよう設定します。

```sh
#!/bin/bash

# --- JSONパース用のヘルパー関数 ---
# ... (スクリプト詳細は元記事参照) ...

# --- 設定 ---
CLIENT_ID="GitHub AppのクライアントID"

# --- メイン処理 ---
# ステップ1: デバイスコード及びユーザコードの要求
# ...

# ステップ2: ユーザコードの入力をユーザに促す
# ...

# ステップ3: ユーザがデバイスを認可したかポーリング
# ...
```

### 3. 実行例

スクリプトを実行すると、ターミナルに以下のようなメッセージが表示されます。

```
============================================================
ブラウザで以下のURLを開き、コードを入力してください（15分間有効）:
URL: https://github.com/login/device
Code: A93F-12DC
============================================================
```

ユーザーは表示されたURLをブラウザで開き、8桁のコードを入力してGitHub Appを認可します。

![](https://cdn-ak.f.st-hatena.com/images/fotolife/k/kaminashi-developer/20250708/20250708213054.png)
![](https://cdn-ak.f.st-hatena.com/images/fotolife/k/kaminashi-developer/20250708/20250708213033.png)
![](https://cdn-ak.f.st-hatena.com/images/fotolife/k/kaminashi-developer/20250708/20250708213442.png)

認可が完了すると、コンテナは取得したユーザーアクセストークンを使ってプライベートGoモジュールをダウンロードできるようになります。

## 検討したが採用しなかった方法

| 方法                                 | メリット                                 | デメリット                                                                  |
| :----------------------------------- | :--------------------------------------- | :-------------------------------------------------------------------------- |
| **GitHub Appのインストールトークン** | ユーザー認証が不要                       | 秘密鍵の管理が煩雑で漏洩リスクがある (CI環境では有効)                       |
| **GitHub CLIのデバイスフロー**       | デバイスフロー用のスクリプトが不要       | 発行されるトークンが無期限かつユーザーの全権限を持つため、セキュリティリスクが高い |

## 結論

GitHub Appのデバイスフローを利用することで、ローカルのコンテナ開発環境において、セキュリティを犠牲にすることなく、プライベートなGoモジュールを便利に利用する仕組みを構築できました。この方法は実際に運用されており、開発者からも「PATよりも負担は増えず、むしろセキュリティが向上した」と好評を得ています。
