---
title: "OpenSearchCon North America 2025「次世代の検索:UberとOpenSearchコミュニティが目指すCloud Native 3.0」- Shubham Gupta, Uber"
source: "https://bering.hatenadiary.com/entry/2025/10/03/223452"
author:
  - "[[bering]]"
published: 2025-10-03
created: 2025-12-16
description: "OpenSearchCon North America 2025のセッション「Next-Gen Search: How Uber and the OpenSearch Community Built a Cloud Native 3.0」をまとめます。 UberがOpenSearch Software Foundationの創設メンバーとして、サーバーレス/クラスターレスなOpenSearchの実現に向けて取り組む革新的なアプローチと、コミュニティへの貢献について紹介されています。"
tags:
  - "clippings"
  - "OpenSearch"
  - "Uber"
  - "検索エンジン"
  - "クラウドネイティブ"
  - "Apache Lucene"
  - "分散システム"
  - "ベクトル検索"
---

## 概要

本セッションでは、UberのSenior Engineering ManagerでありOpenSearch Technical Steering Committee（TSC）メンバーであるShubham Gupta氏が、Uberにおける検索プラットフォームの課題と、クラウドネイティブなOpenSearchの実現に向けた取り組みについて解説している。

動画: [YouTube](https://www.youtube.com/watch?v=uj1vP2D0JFM)

---

## 1. Uberにおける検索の課題

### 1.1 検索システムの特徴

Uberの検索システムには以下の独自の課題がある：

| 課題 | 詳細 |
|------|------|
| **位置情報特化** | 単純な地理検索ではなく、ユーザーの現在地・目的地・配達先などの文脈を常に考慮 |
| **大規模データ** | 数十億の料理・食料品・位置情報・道路情報から適切な結果を抽出 |
| **高スループット・低レイテンシー** | 複数のユースケースに対して高いパフォーマンスが必要 |
| **多様な検索意図** | 明確な検索と探索的な発見の両方に対応 |
| **複雑なリランキング** | 価格、配達速度、信頼性、パーティーサイズ、食事制限など多数の要因を考慮 |

### 1.2 規模

- **毎日500億件以上の検索を処理**
- **50以上のユースケース**
- **150以上のクラスター**

---

## 2. 検索ユースケース

### 2.1 Uber Eatsの検索

- 住所設定 → おすすめフィード表示 → 店舗・アイテム検索
- すべてのユースケースが検索問題として定式化され、検索プラットフォームが支えている

### 2.2 Uberライドの住所検索

- 乗客：目的地の住所検索
- ドライバー：行きたい場所の住所検索

### 2.3 リアルタイムマッチング

- **ドライバーの位置情報**と**乗客の乗車リクエスト**を2つのシグナルとして取得
- 例：「サンフランシスコのチェイスセンター近くで、Uber XLに対応できるドライバーを2マイル以内で検索」

### 2.4 RAG/GenAI

- ドライバー・ユーザーからの苦情対応を自動化
- **近似最近傍探索**を使用：過去のQ&Aコーパスをファインチューニングされた大規模言語モデルで埋め込みに変換し、新しい問い合わせに対して最も近い過去のQ&Aを見つける

---

## 3. OpenSearch導入以前のUberの検索プラットフォーム

### 3.1 アーキテクチャ概要

- **Apache Luceneを使用したカスタムソリューション**
- **Lambdaアーキテクチャ**：
  - バルクインデキシング：Spark
  - ストリーミングインジェスション：Kafka
- **ジオシャーディング**のネイティブサポート
- 独自のインデックスレイアウトとクエリ演算子

### 3.2 Uber Eatsのパフォーマンス要件

| 指標 | 要件 |
|------|------|
| P50レイテンシー | 50ms未満 |
| P99レイテンシー | 150ms未満 |
| ドキュメント更新スループット | ピーク時毎秒約10万件 |

### 3.3 転置インデックスと静的ランク

**問題点**：

- 単純な2次元行列（用語×ドキュメント）は疎性のため非効率
- 数百～数千の転置インデックスにまたがるクエリの処理

**解決策**：

- **転置インデックス**：用語からドキュメントIDのリストへのマッピング
- **静的ランク**：オフラインで計算した人気度に基づいてドキュメントIDを並べ替え、アーリーターミネーション（早期終了）を実現
- **Forwardインデックス**：リランク用の特徴を保存

### 3.4 カスタム結合（親子関係の効率的処理）

**背景**：店舗とアイテムを横断するフィルタリングが必要

**アプローチ**：

1. インデックス内の店舗とアイテムを特定の順序で並べ替え
2. 最も人気のある店舗 → その店舗内で人気のあるアイテム → 次に人気の店舗... という順序
3. 2段階のソートされたルックアップを連動させてナビゲート

**利点**：

- 網羅的検索なしで店舗間のコンテンツ多様性を確保
- 効率的な早期終了が可能

**実装**：

- リーダーとライターを分離
- ライターが更新を消費し、ソートされたインデックスをディスクにフラッシュ
- リーダーが読み取り

### 3.5 Concurrent Search

- シャードを単一ファイルセグメントとして扱うのではなく、より小さなサブシャードに分割
- KNN/NNスタイルの検索で各サブシャードのKを調整可能
- **結果**：CPUを過度に使用せずに、より高速で高品質なベクトル検索を実現

### 3.6 アーキテクチャ全体像

```
クライアント
    ↓
ゲートウェイ（読み取り/書き込み受付）
    ↓
┌─────────────────────────────────────────┐
│ 書き込み: Kafka → Ingestor → S3/HDFS    │
│ 読み取り: Searcher ← S3/HDFS            │
│ バックフィル: Spark → S3/HDFS           │
└─────────────────────────────────────────┘
```

---

## 4. OSSへの参加

### 4.1 課題認識（2024年初頭）

1. 製品チームからの新機能リクエストの速度に追いつけない
2. 業界のシステム改善（特にセマンティック検索）を取り入れられない

### 4.2 決断

- **2024年9月**：OpenSearch Software Foundationの**創設メンバー**として参加
- OpenSearch 2025ロードマップを共同作成
- テールユースケースからOpenSearchへのオンボーディングを開始

---

## 5. クラウドネイティブなOpenSearch

### 5.1 現行クラスターマネージャーの役割

1. 同期的な更新を実行（単一のモノリシックなBLOBストアにメタデータを保存）
2. すべてのノードで同期的なRPCコールを作成し、メタデータの一貫性を確保

### 5.2 現行クラスターマネージャーの問題点

| 問題 | 詳細 |
|------|------|
| 信頼性リスク | クラスターサイズが200ノードを超えると可用性低下 |
| 頻繁なシャード移動 | 一時的なネットワーク途切れによる（複数プロバイダー運用のため） |
| ローリングアップグレード | サポート不足 |
| 異種シャーディング | シャードごとに異なるレプリカ数を持てない |

### 5.3 クラウドネイティブクラスターマネージャーのビジョン

**目標**：

1. すべてのノードにわたる同期的なメタデータ更新を**非同期化**
2. メタデータを**分解**し、各ノードが役割に応じて必要なメタデータだけを受け取れるようにする

**アーキテクチャ**：

- **Controller/Config Storage**：メタデータを管理し、etcdのようなストアに保存
- **データノード/コーディネートノード/インジェスターノード**：クラスターマネージャーからの指示を待たず、etcdウォッチャーを通じて各自のペースでメタデータを取得

### 5.4 現在までの実装状況

- コントロールプレーン変更用の**新リポジトリ**を作成
- クラスターメタデータをリモートストレージ（etcd）に保存
- 役割に応じた特定のメタデータを保存（例：コーディネーターは全データノードのメタデータ、データノードは自身のシャード情報のみ）
- データプレーンの変更により、データノードはリモートクラスターか従来の同期クラスターかを意識不要に

---

## 6. 今後の取り組み

| 取り組み | 内容 |
|----------|------|
| サーバーレス/クラスターレスOpenSearch | 年末までにプロトタイプ稼働を目標 |
| Term based sharding/routing | 既存のUIDベースシャーディングとは異なるアプローチ |
| Spark上でのバッチインデックス構築 | クラスター起動不要でOpenSearchインデックスを構築 |
| 効率的な親子結合 | Luceneにはすでにコミット済み、OpenSearchにもコントリビュート予定 |
| GPUのサービング層での活用 | 将来的な計画 |

---

## 7. Q&A 主要ポイント

### 実行環境

- オンプレミスで稼働、OCIクラウドへの移行も計画
- OpenSource OpenSearchを自社運用（マネージドサービス不使用）

### オートスケーリング

- Luceneプラス（カスタム）：シャード単位でスケーリング
- OpenSearch：標準構成、単一ハードウェアフリートをクラスターマネージャーがバランス

### 検索効率向上の手法

1. インデックスソート + 2段階ロックステップイテレータ
2. 都市ベースの店舗グルーピングによるCPUキャッシュ効率化
3. デルタエンコーディングによるインデックスサイズ縮小

### ベクトル検索

- バニラLuceneのベクトル検索サポートを使用
- スカラー量子化/積量子化を活用
- サブシャードでKを調整し並列処理を改善

### スキーマ管理

- 非常に厳密に型付けされたスキーマを構築
- 動的マッピングは過去の問題から使用禁止
- Atlasベースの内部スキーマを使用

### ドキュメントサイズ

- Uber Eatsの場合、アイテム/店舗で数キロバイト程度

---

## 結論

Uberは、位置情報特化の大規模検索という独自の課題に対し、Apache Luceneベースのカスタムソリューションで対応してきた。しかし、機能開発の速度と業界の進歩への追従という課題から、2024年9月にOpenSearch Software Foundationの創設メンバーとして参加。現在は**サーバーレス/クラスターレスなOpenSearch**の実現に向けて、同期的なクラスターマネージャーを非同期化・分散化する取り組みを進めている。この取り組みは、200ノード以上のスケーラビリティ、異種シャーディングサポート、ローリングアップグレードなどの課題解決を目指している。
