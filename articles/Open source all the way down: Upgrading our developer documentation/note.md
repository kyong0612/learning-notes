# Open source all the way down: Upgrading our developer documentation

ref: <https://blog.cloudflare.com/open-source-all-the-way-down-upgrading-our-developer-documentation/>

Cloudflareでは、開発者向けのコンテンツを製品と同じように扱い、ユーザーやそのフィードバックを考慮しています。私たちは、コンテンツを絶えず反復し、テストし、分析し、改善しています。アジャイル開発に触発され、開発者ドキュメントをオープンソースプロジェクトと同様に取り扱うことで、その作成・維持プロセスを進化させています。

## オープンソースドキュメントの価値

オープンソースのドキュメントは、世界中の開発者コミュニティを支えます。それは誰もがコンテンツに貢献できる機会を提供し、ドキュメントのコンテンツとそのフレームワークを公開することで、開発者がドキュメントの構築・承認・維持のプロセスを理解し、参加できるようにします。この透明性は、コラボレーション、学習、革新を促進し、開発者が知識を共有し、他者から学ぶ場を提供します。また、私たちは他のオープンソース製品やプラグインへのフィードバックも提供し、私たちを支える同じコミュニティに恩返しをしています。

優れたドキュメントは、新しい製品を迅速に活用するための鍵であり、製品の使用方法やその利点を説明します。適切でタイムリーかつ正確なコンテンツは、フラストレーション、時間、お金を節約できます。さらに、オープンソースドキュメントは、包括的でサポート的なコミュニティを構築し、学習曲線を緩和する助けとなります。

## オープンソースドキュメントの拡張への挑戦

Cloudflareのコンテンツチームは、製品のローンチと同時にドキュメントを提供するために規模を拡大してきましたが、オープンソースのドキュメントサイト自体はうまくスケールできていませんでした。
developers.cloudflare.com は、寄稿者向けのワークフローが限界に達しており、コミュニティの開発者による素晴らしいツールや機能を取り込む機会を逃していました。

ソフトウェア製品の評価と同様に、私たちはビジネスニーズを再検討しました。以下のような問いを自問しました：

- オープンソースを維持することは適切なのか？
- 他に使用したいツールはあるのか？
- 1年後、5年後にどのような利点を見たいのか？

寄稿者ワークフローの課題に加え、スケーラビリティとユーザーエクスペリエンス改善の高コストが主な制限要因であることが分かりました。

## 新しい機能の要望リスト作成とオープンソースへの再確認

新機能の要望リストをまとめた後、私たちはオープンソースへのコミットメントを再確認しました。ドキュメントサイトのコンテンツだけでなく、その基盤となるフレームワークにもオープンソースを活用する価値を認識していました。
このコミットメントは、単なる技術的な問題を超えて、私たちのコミュニティとの関係や透明性・協力の哲学に深く関わるものです。

オープンソースフレームワークを選択することは、多くの訪問者には目に見えないかもしれませんが、開発者や寄稿者コミュニティにとっては重要です。私たちの意思決定プロセスは主に以下の2つの要因に基づいていました：

1. 更新がコラボレーションエコシステムを強化するかどうか。
2. 全体的なドキュメント体験を向上させるかどうか。

このように、オープンソースの原則をコンテンツとインフラの両方に適用することが、革新を促進し、ピアレビューによる品質を保証し、より充実したユーザーコミュニティを構築するために不可欠であると考えています。

## 2021年：GatsbyからHugoへの移行

Cloudflareの開発者ドキュメントは、GitHubでオープンソースとして公開されています。このドキュメントエンジンは、2020年に初版がリリースされて以来、数回の改訂を経ています。初版は、ダークモードや適切なコード構文サポートなど、開発者に優しい機能を提供しました。

2021年には、カスタムドキュメントエンジンを導入し、GatsbyからHugoへの移行を行いました。この移行による主な改善点は以下の通りです：

- 開発フローの高速化：本番の挙動を再現する開発フローが導入され、反復速度と信頼性が向上しました。また、Cloudflare Pagesを介したプレビューリンクが導入され、コンテンツチームや関係者が本番環境での見た目を迅速に確認できるようになりました。
- カスタムコンポーネント：たとえば、リポジトリ全体でコンテンツを参照できる「resources-by-selector」のような新機能が導入され、チェックと自動化の柔軟性が向上しました。
- 構造化された変更履歴管理：YAML形式の変更履歴エントリを使用して、RSSフィードやDeveloper Discord、ドキュメント内での共有が容易になりました。
- パフォーマンスの向上：HTMLファーストへの移行によりページの読み込み時間が大幅に改善され、ローカルビルドもほぼ即時に完了するようになりました。

これらの機能は移行評価時に譲れないポイントでした。

## 2024年：Astroへの移行と新しい開発者ドキュメントの登場

HugoからAstro（およびその拡張であるJavaScriptエコシステム）への移行を決定しました。この選択は、次のような要望リストの項目を満たしていたためです：

- コンテンツの整理の向上：タグ付けの改善と関連ページのクロスリファレンスが強化されました。
- 拡張性：starlight-image-zoomのようなユーザープラグインのサポートにより、ライトボックス機能が可能に。
- 開発体験の向上：astro checkを用いたビルド時の型チェック、構文のハイライト、IntelliSense、診断メッセージ、ESLintやPrettierなどのプラグインがサポートされました。
- JavaScript/TypeScriptのサポート：多くの寄稿者にとって慣れ親しんだ言語と一致し、寄稿が容易になりました。
- CSS管理の改善：Tailwindとスコープスタイルの導入。
- コンテンツコレクション：Markdownフロントマターの検証（Zodスキーマを利用）やJSONスキーマによるIntelliSenseの提供、JavaScriptコールバックによるエントリフィルタリングなど、タグ付け管理の新しい方法を提供。

Astroのドキュメントテーマである「Starlight」は、移行の決定を左右する重要な要素でした。このテーマは強力なコンポーネントオーバーライドとプラグインシステムを提供し、組み込みコンポーネントや基本スタイリングを活用することができました。

マークダウン構文の移行とスムーズな切り替え

大量のコンテンツを短期間で移行する必要がありました。日々数十件のプルリクエストが開かれる中、1週間のコードフリーズは現実的ではありません。そのため、抽象構文木（AST: Abstract Syntax Tree）の仕組みを利用しました。これは、Markdownドキュメントの構造だけを解析し、ホワイトスペースやインデントなどの詳細には依存しない方法です。

以前のHugo構文では、コードブロックのタイトルや行のハイライト機能をコードブロック内のフロントマターで設定していました：

```markdown
---

title: index.js
highlight: 1
---

const foo = "bar";
```

一方、Starlightでは「Expressive Code」を使用しており、これらのオプションはコードフェンスの開始部分に設定されるようになりました：

```markdown

js title="index.js" {1}
const foo = "bar";

```

ASTを用いた処理では以下の手順を踏みます：

1. node.valueをフロントマターとして解析。
2. front-matterから得た属性をnode.metaに割り当て。
3. node.valueをコードブロックの残り部分に置き換え。

以下のコードでそのプロセスを実現しています：

```typescript
import { fromMarkdown } from "mdast-util-from-markdown";
import { toMarkdown } from "mdast-util-to-markdown";
import *as astray from "astray";
import type* as MDAST from "mdast";
import fm from "front-matter";

const markdown = await Bun.file("example.md").text();
const AST = fromMarkdown(markdown);

astray.walk<MDAST.Root, void, any>(AST, {
    code(node: MDAST.Code) {
        const { attributes, body } = fm(node.value);
        const { title, highlight } = attributes;

        if (title) {
            node.meta = `title="${title}"`;
        }

        if (highlight) {
            node.meta += ` {${highlight}}`;
        }

        node.value = body;
        return;
    }
});
```

## 移行プロセスの統計と成果

2021年にGatsbyからHugoへの移行では、約4,850件のファイルが変更され、計画から実装まで3週間かかりました。今回は、8,060件のファイルを対象とするほぼ倍の規模の移行を、次の計画で進めました：

1. 10日間：プラットフォーム、ベンダー、機能の評価。
2. 14日間：ドキュメントサイトで必要なコンポーネントの移行。
3. 5日間：ステージングおよびユーザー受け入れテスト（UAT）。
4. 8時間：コードフリーズおよびAstro/Starlightへの移行。

結果として、保守負担を軽減する19,624行のコードを削減することができました。

## 移行中の学び

Astro/Starlightへの移行は複雑なプロセスでしたが、計画、レビュー、調整に時間をかけたことで成功を収めました。特に以下の点で有益な学びがありました：

1. Cloudflare Community MVPとの協力
    - 移行の計画およびレビュー期間中、Cloudflare CommunityのMVPメンバーを巻き込んだことで、貴重なガイダンスとフィードバックを得られました。これにより、計画の質が向上しました。
2. コードフリーズの最小化
   - 移行においてコードフリーズは1日のみで済みました。この結果、訪問者はサイトのダウンタイムを経験することなく、移行はスムーズに進行しました。
3. 実験的なAstro APIの活用
   - テスト中にいくつかのユースケースでAstroの実験的APIを使用する必要がありましたが、これらはAstroコミュニティのオープンソースコンテンツのおかげで、優れたドキュメントが整備されていました。そのため、リリーススケジュールに影響を与えることなく迅速に実装できました。
4. ビルド時間の課題と迅速な対応
   - サイトに4,000以上のページが存在するため、ビルド時間のパフォーマンスに関する問題が発生しました。Astroチームは迅速にこの問題をトリアージし、恒久的な修正に取り組み始めました。Astro Discordコミュニティからのサポートには感謝しています。

## Astro/Starlight移行の成功と今後の展望

今回の移行は、Cloudflareが開発者向けのドキュメントとユーザーエクスペリエンスにどれほど深く投資しているかを示しています。2021年以降、「コンテンツを製品のように扱う」という戦略を採用したことで、オープンソースコミュニティへの包括性と透明性が向上しました。これにより、Cloudflareのユーザーがより満足する結果となりました。

私たちは、誰もが今回のアップデートを活用し、コミュニティとつながることを歓迎します。ドキュメントに関するフィードバックや提案があれば、GitHubのCloudflare-docsリポジトリに直接プルリクエストを送ることで共有してください。

## Cloudflareの取り組みと使命

Cloudflareは、企業ネットワーク全体を保護し、インターネット規模のアプリケーションを効率的に構築するための支援を提供しています。また、Webサイトやインターネットアプリケーションを高速化し、DDoS攻撃を防ぎ、ハッカーから守るほか、Zero Trustへの移行を支援します。
