---
title: "家族の思い出を形にする 〜 １秒動画の生成を支えるインフラアーキテクチャ"
source: "https://speakerdeck.com/ojima_h/jia-zu-nosi-ichu-woxing-nisuru-1miao-dong-hua-nosheng-cheng-wozhi-eruinhuraakitekutiya"
author:
  - "Ojima Hikaru"
published: 2025-08-07
created: 2025-08-12
description: |
  家族アルバム「みてね」における1秒動画生成を支えるインフラアーキテクチャについて、大量の写真・動画データを扱う大規模バッチ処理、機械学習・BigQueryとの連携、効率的なジョブフロー処理の工夫とジレンマを解説したMIXIのSREチームによる技術発表資料。
tags:
  - infrastructure
  - architecture
  - batch-processing
  - machine-learning
  - bigquery
  - kubernetes
  - sre
  - video-processing
  - family-album
  - mixi
---

## 概要

MIXIの家族アルバム「みてね」における1秒動画生成を支えるインフラアーキテクチャについて、SREチームの生島光氏による技術発表。大量の写真・動画データを扱う大規模バッチ処理、機械学習・BigQueryとの連携、効率的なジョブフロー処理の工夫とその際に発生するジレンマについて解説している。

## 発表者について

#### 生島 光（@ojima_h）

- 2019年から「家族アルバム みてね」のSREグループで活動
- データ分析基盤の構築、EKS移行、CI/CDの改善などを担当
- 3児の父

## 「家族アルバム みてね」について

- 家族向けの写真・動画共有アプリ
- iOS・Android・ブラウザ版を提供
- 主要機能：
  - **1秒動画**: 写真から自動生成される短編動画
  - **フォトブック**: 写真を使った製本サービス
  - **写真プリント**: 印刷サービス

## インフラアーキテクチャの全体像

1秒動画生成は以下の3つのステージで構成される：

### ステージ1：画像・動画アップロード

- アップロードされた写真・動画を保存し、スコアリングを実行
- 画像・動画に対するタグ付けとメタデータ抽出

### ステージ2：対象家族抽出処理

- 1秒動画生成の対象となる家族を抽出
- ジョブキューに処理対象を追加

### ステージ3：1秒動画生成

- スコアに基づく素材選択
- 加工・結合処理による最終的な1秒動画の生成

## ステージ1：画像・動画アップロード詳細

### アーキテクチャ構成

**メインサービス（Rails）：**

- サムネイル生成
- アップロード完了通知

**解析パイプライン：**

- 画像・動画に含まれる顔情報などを分析してスコアを算出
- 算出されたスコアはメインサービスのDBに保存
- 複数のMLモデルをジョブオーケストレータにより統合

**コンポーネント間連携：**

- SQSによるコンポーネント結合
- リクエスト送信用とレスポンス受信用の2つのSQSキューペア

### Amazon S3の活用

**選択理由：**

- **99.999999999%の耐久性**: データの欠損防止が最重要
- **スケーラビリティ**: 大量の画像・動画の処理に対応
- **豊富な機能**: 署名付きURLによる直接アップロード、CloudFrontによる配信最適化

### 技術スタックの課題

**メインサービス：**

- 単一のRailsアプリケーション
- 複数のAPIサーバー・Webサーバー
- 多数のジョブワーカー（Sidekiq、Shoryuken）

**解析パイプライン：**

- ジョブオーケストレーター（Rails実装）
- 解析器（TensorFlow、PyTorchなど個別技術、独立リポジトリ）

**管理の複雑化：**

- メインサービスと解析パイプライン間のデータベース整合性
- リポジトリごとのCI/CD整備
- セキュリティアップデートなどのメンテナンス
- サービス・リポジトリ分割による柔軟性と管理コストのトレードオフ

## ステージ2：対象家族抽出詳細

### BigQueryへの移行

**初期実装：**

- RDBを使用した対象家族抽出

**BigQueryへの移行理由：**

- **DB負荷の解消**: メインサービスへの影響を排除
- **分離による安定性**: メインサービスからの分離
- **パフォーマンス向上**: 実行時間の劇的な短縮
- **複雑なクエリへの対応**: 素材が少ない家族の除外など

### ETL処理の実装

**MySQL→BigQuery：**

- 一日1回のETL処理によりAurora MySQLからBigQueryへデータ転送
- MySQLのデータサイズ：数TB
- Apache SparkをKubernetes上で5時間程度実行
- **課題**: 運用負荷の高さ

## ステージ3：1秒動画生成詳細

### 処理フロー

**主要ステップ：**

1. 素材選択
2. 回転や切り抜きなどの整形処理
3. タイトルやBGMの追加
4. その他の加工処理

**実装方式：**

- 各ステップをSidekiq Jobとして実装
- 全体をSidekiq Batchにより統合
- ジョブの並列分散実行により生成時間を短縮

### 主要な課題

**大量ジョブ処理：**

- 数百万の家族に対するバッチ処理
- 複数ステップにまたがるジョブフロー

## Amazon EKSによるスケーラビリティ対応

### 基本構成

**選択理由：**

- コンピュートリソースの安定供給
- ジョブキューの長さに応じた即座のスケールアウト
- スポットインスタンスの活用によるコスト最適化

### キャパシティプランニングの課題

**運用上の注意点：**

- 多数のノード起動による管理複雑化
- Cluster autoscalerのメモリ不足
- スポットインスタンスのクォータ制限
- 定常時とは異なるリソース使用パターン

## ジョブキュー構成の最適化

### 改善前（BEFORE）

**問題点：**

- 全てのステップを単一のジョブキューに追加
- 1つ目のステップで全てのジョブ完了を待機
- 次に2つ目のステップで全てのジョブ完了を待機
- 最終的な1秒動画完成確認まで長時間を要する

### 改善後（AFTER）

**最適化内容：**

- 1つ目のステップのみ優先度の低いジョブキューを利用
- 1つのジョブが全てのステップを完了後、次のジョブへ
- 1秒動画の生成完了次第、順次配信する運用を実現

**効果：**

- より早い段階での成果物確認
- 逐次配信による運用効率向上

## 主要な技術的発見

### トレードオフの管理

**複数技術スタック組み合わせ：**

- MLパイプライン、BigQueryとの連携における複雑性
- 柔軟性と管理コストのバランス

**継続的チューニングの重要性：**

- ジョブキュー構成の最適化
- リソース使用パターンの変化への対応

### 信頼性の基盤

**安定したクラウドサービス活用：**

- Amazon S3による耐久性とスケーラビリティ
- Amazon EKSによる柔軟なコンピュート環境

## まとめ

**キーポイント：**

1. **信頼できる基盤の重要性**: Amazon S3、Amazon EKSなどの安定したサービスの活用
2. **技術スタック統合の複雑性**: MLパイプライン、BigQueryなど複数技術の組み合わせにおけるトレードオフ
3. **継続的最適化の必要性**: ジョブキュー構成など、運用状況に応じた継続的なチューニング

**制限事項：**

- アルゴリズムの詳細については本発表では言及せず
- 関連する詳細技術については別の発表・記事で解説済み

この発表は、大規模なメディア処理システムにおけるインフラアーキテクチャの実践的な知見を提供し、特に複数の技術スタックを統合する際の課題と解決策について具体的な事例を示している。

## 関連資料

- [1秒動画のつくり方 ― 「家族アルバム みてね」における動画エンコードパイプラインとその最適化事例 | gihyo.jp](https://gihyo.jp/)
- [BigQuery で1秒動画の配信対象家族を爆速で抽出する / How to create 1sec movie schedules with bigquery - Speaker Deck](https://speakerdeck.com/)
- [いい感じの素材選択ロジック / How to select videos for 1sec Movie - Speaker Deck](https://speakerdeck.com/)
- [「家族アルバム みてね」年間版1秒動画2023 大量配信の裏側 - Kyohei Hamada - Medium](https://medium.com/)
