---
title: "A postmortem of three recent issues"
source: "https://www.anthropic.com/engineering/a-postmortem-of-three-recent-issues"
author:
  - "[[@AnthropicAI]]"
published: 2025-09-17
created: 2025-09-19
description: |
  This is a technical report on three bugs that intermittently degraded responses from Claude. Below we explain what happened, why it took time to fix, and what we're changing.
tags:
  - "clippings"
  - "postmortem"
  - "infrastructure"
  - "bug"
  - "Claude"
  - "Anthropic"
---

これは、断続的にClaudeの応答を劣化させた3つのバグに関する技術的なレポートです。以下では、何が起こったのか、修正に時間がかかった理由、そして私たちが何を変更しているのかについて説明します。

2025年8月から9月上旬にかけて、3つのインフラ関連のバグが断続的にClaudeの応答品質を低下させました。私たちはこれらの問題を解決し、何が起こったのかを説明したいと思います。

8月上旬、多くのユーザーからClaudeの応答が劣化したとの報告が寄せられ始めました。これらの初期報告は、ユーザーフィードバックの通常変動と区別するのが困難でした。8月下旬までに、これらの報告の頻度と持続性が高まったため、私たちは調査を開始し、3つの別々のインフラ関連のバグを発見するに至りました。

はっきりと申し上げると、私たちは需要、時間帯、またはサーバー負荷によってモデルの品質を低下させることは決してありません。ユーザーが報告した問題は、インフラのバグのみによるものでした。

私たちは、ユーザーがClaudeに一貫した品質を期待していることを認識しており、インフラの変更がモデルの出力に影響を与えないようにするための非常に高い基準を維持しています。今回のインシデントでは、その基準を満たすことができませんでした。以下の事後報告では、何が問題だったのか、検知と解決になぜ私たちが望んでいたよりも時間がかかったのか、そして将来同様のインシデントを防ぐために何を変更しているのかを説明します。

私たちは通常、インフラに関するこのレベルの技術的な詳細を共有しませんが、これらの問題の範囲と複雑さを考慮し、より包括的な説明が必要だと判断しました。

## Claudeの提供規模

私たちは、自社API、Amazon Bedrock、およびGoogle CloudのVertex AIを介して、数百万人のユーザーにClaudeを提供しています。私たちは、AWS Trainium、NVIDIA GPU、Google TPUといった複数のハードウェアプラットフォームにClaudeを展開しています。このアプローチにより、世界中のユーザーにサービスを提供するために必要なキャパシティと地理的分散を確保しています。

各ハードウェアプラットフォームは異なる特性を持ち、特定の最適化が必要です。これらの違いにもかかわらず、私たちはモデル実装に対して厳格な同等性基準を設けています。私たちの目標は、どのプラットフォームがリクエストを処理するかにかかわらず、ユーザーが同じ品質の応答を得られるようにすることです。この複雑さは、インフラの変更にはすべてのプラットフォームと構成にわたる慎重な検証が必要であることを意味します。

## イベントのタイムライン

![クロードAPIでのイベントのタイムライン。黄色：問題検出、赤：悪化、緑：修正展開。](https://www-cdn.anthropic.com/images/4zrzovbb/website/d707dfc2effceba608d04007bc776132a3e57838-3840x1800.png)

これらのバグが重複していたため、診断は特に困難でした。最初のバグは8月5日に導入され、Sonnet 4へのリクエストの約0.8%に影響を与えました。さらに2つのバグが8月25日と26日のデプロイメントで発生しました。

初期の影響は限定的でしたが、8月29日のロードバランシングの変更により、影響を受けるトラフィックが増加し始めました。これにより、多くのユーザーが問題を経験する一方で、他のユーザーは通常のパフォーマンスを維持し続け、混乱を招く矛盾した報告が生まれました。

## 3つの重複した問題

以下に、品質低下を引き起こした3つのバグ、それらが発生した時期、および解決方法について説明します。

### 1. コンテキストウィンドウのルーティングエラー

8月5日、一部のSonnet 4リクエストが、近日公開予定の1Mトークンコンテキストウィンドウ用に設定されたサーバーに誤ってルーティングされました。このバグは当初、リクエストの0.8%に影響を与えました。8月29日、通常のロードバランシングの変更により、意図せずして1Mコンテキストサーバーにルーティングされるショートコンテキストリクエストの数が増加しました。8月31日の最も影響が大きかった時間帯には、Sonnet 4リクエストの16%が影響を受けました。

この期間中にリクエストを行ったClaude Codeユーザーの約30%が、少なくとも1つのメッセージを誤ったサーバータイプにルーティングされ、応答が劣化しました。Amazon Bedrockでは、誤ルーティングされたトラフィックは8月12日からSonnet 4全リクエストの0.18%でピークに達しました。Google CloudのVertex AIでは、8月27日から9月16日までの誤ったルーティングはリクエストの0.0004%未満でした。

しかし、私たちのルーティングは「スティッキー」であるため、一部のユーザーはより深刻な影響を受けました。これは、一度誤ったサーバーによってリクエストが処理されると、その後のフォローアップも同じ誤ったサーバーによって処理される可能性が高いことを意味します。

**解決策:** ショートコンテキストとロングコンテキストのリクエストが正しいサーバープールに送られるようにルーティングロジックを修正しました。修正は9月4日に展開し、自社プラットフォームとGoogle CloudのVertexへの展開は9月16日までに完了しました。Bedrockへの修正は現在展開中です。

### 2. 出力の破損

8月25日、私たちはClaude APIのTPUサーバーに誤った設定を展開し、トークン生成中にエラーを引き起こしました。ランタイムパフォーマンスの最適化に起因する問題が、文脈上ほとんど生成されるべきではないトークンに時折高い確率を割り当ててしまいました。例えば、英語のプロンプトに対してタイ語や中国語の文字を生成したり、コードに明らかな構文エラーを生成したりしました。英語で質問した一部のユーザーは、応答の途中で「สวัสดี」のような文字を見たかもしれません。

この破損は、8月25日から28日までのOpus 4.1およびOpus 4へのリクエスト、および8月25日から9月2日までのSonnet 4へのリクエストに影響を与えました。サードパーティプラットフォームはこの問題の影響を受けませんでした。

**解決策:** 私たちは問題を特定し、9月2日に変更をロールバックしました。デプロイプロセスに、予期しない文字出力を検出するテストを追加しました。

### 3. 近似top-k XLA:TPUのコンパイルミス

8月25日、Claudeがテキスト生成中にトークンを選択する方法を改善するためのコードを展開しました。この変更は、意図せずXLA:TPUコンパイラの潜在的なバグを誘発し、Claude Haiku 3.5へのリクエストに影響を与えることが確認されました。

また、これがClaude API上のSonnet 4およびOpus 3の一部にも影響を与えた可能性があると考えています。サードパーティプラットフォームはこの問題の影響を受けませんでした。

**解決策:** 私たちは最初にHaiku 3.5に影響を与えるバグを観測し、9月4日にそれをロールバックしました。その後、このバグと互換性のあるOpus 3の問題に関するユーザー報告に気づき、9月12日にロールバックしました。広範な調査の後、Sonnet 4でこのバグを再現することはできませんでしたが、万全を期してロールバックすることにしました。

同時に、私たちは(a)コンパイラのバグ修正についてXLA:TPUチームと協力し、(b)精度を高めた正確なtop-kを使用する修正を展開しました。詳細は以下の詳細な分析をご覧ください。

## XLAコンパイラバグの詳細

これらの問題の複雑さを説明するために、XLAコンパイラのバグがどのように現れ、なぜ診断が特に困難だったかを以下に示します。

Claudeがテキストを生成する際、考えられるすべての次の単語の確率を計算し、その確率分布からランダムにサンプルを選択します。私たちは、無意味な出力を避けるために「top-pサンプリング」を使用し、累積確率がしきい値（通常は0.99または0.999）に達する単語のみを考慮します。TPUでは、私たちのモデルは複数のチップにまたがって実行され、確率計算は異なる場所で行われます。これらの確率をソートするには、チップ間でデータを調整する必要があり、これは複雑です。

2024年12月、私たちはTPU実装がtemperatureがゼロのときに最も確率の高いトークンを時々ドロップすることを発見しました。私たちはこのケースを修正するための回避策を展開しました。

![2024年12月のパッチのコードスニペット。temperature = 0 のときに予期せずトークンがドロップされるバグを回避するためのものです。](https://www-cdn.anthropic.com/images/4zrzovbb/website/efee0d3d25f6b03cbfc57e70e0e364dcd8b82fe0-2000x500.png)

根本的な原因は、混合精度演算に関係していました。私たちのモデルは、次のトークンの確率をbf16（16ビット浮動小数点数）で計算します。しかし、ベクトルプロセッサはfp32ネイティブであるため、TPUコンパイラ（XLA）は、一部の操作をfp32（32ビット）に変換することでランタイムを最適化できます。この最適化パスは、デフォルトでtrueに設定されている `xla_allow_excess_precision` フラグによって制御されます。

これにより、最も高い確率のトークンについて一致するはずの操作が、異なる精度レベルで実行されるという不一致が生じました。この精度の不一致は、どのトークンが最も高い確率を持つかについて一致しないことを意味し、結果として最も高い確率のトークンが考慮から完全に消えることがありました。

8月26日、私たちはサンプリングコードの書き直しを展開し、精度の問題を修正し、top-pしきい値に達する限界確率の処理を改善しました。しかし、これらの問題を修正する過程で、より厄介な問題が露呈しました。

![2024年12月に回避策が講じられた「バグ」の根本原因となった8月11日の変更の一部としてマージされた最小限の再現コードを示すコードスニペット。実際には、これはxla_allow_excess_precisionフラグの期待される動作です。](https://www-cdn.anthropic.com/images/4zrzovbb/website/6d10e58c0bd5fd7cb03dc0adc716cb1e4f039343-2000x2560.png)

私たちの修正は、根本原因を解決したと信じていたため、12月の回避策を削除しました。これにより、近似top-k操作（最も確率の高いトークンを迅速に見つけるためのパフォーマンス最適化）におけるより深いバグが露呈しました。この近似は、特定のバッチサイズとモデル構成でのみ、完全に誤った結果を返すことがありました。12月の回避策は、意図せずしてこの問題を覆い隠していました。

![XLA:TPUのエンジニアと共有された、根本的な近似top-kのバグの再現コードを示すSlackメッセージ。このコードはCPUで実行すると正しい結果を返します。](https://www-cdn.anthropic.com/images/4zrzovbb/website/7e42db934d0e84ea40fc56b416ddb09b2097a5ff-2400x1404.png)

バグの挙動は非常に一貫性がありませんでした。それは、その前後に実行される操作や、デバッグツールが有効になっているかどうかなど、無関係な要因によって変化しました。同じプロンプトでも、あるリクエストでは完璧に機能し、次のリクエストでは失敗することがありました。

調査中に、私たちはまた、正確なtop-k操作がかつて持っていた法外なパフォーマンスペナルティをもはや持たないことを発見しました。私たちは近似top-kから正確なtop-kに切り替え、追加の操作をfp32精度で標準化しました。モデルの品質は譲れないため、わずかな効率への影響を受け入れました。

## 検知が困難だった理由

私たちの検証プロセスは通常、ベンチマークと安全性評価、パフォーマンスメトリクスに依存しています。エンジニアリングチームはスポットチェックを行い、最初に小さな「カナリア」グループに展開します。

これらの問題は、私たちがもっと早く特定すべきだった重大なギャップを露呈しました。私たちが行った評価は、ユーザーが報告していた品質低下を単純に捉えることができませんでした。これは、Claudeが孤立したミスからうまく回復することが多いためです。また、私たち自身のプライバシー慣行も、報告の調査において課題を生み出しました。私たちの内部プライバシーおよびセキュリティ管理は、エンジニアがユーザーとClaudeのインタラクションにアクセスできる方法と時期を制限しています。特に、それらのインタラクションがフィードバックとして報告されていない場合はなおさらです。これはユーザーのプライバシーを保護しますが、エンジニアがバグを特定または再現するために必要な問題のあるインタラクションを調査することを妨げます。

各バグは、異なるプラットフォームで異なる症状を異なる頻度で引き起こしました。これにより、単一の原因を指し示さない、混乱を招く報告が混在することになりました。それはランダムで一貫性のない品質低下のように見えました。

より根本的には、私たちはノイズの多い評価に過度に依存していました。オンラインでの報告が増加していることは認識していましたが、これらを最近の各変更に結びつける明確な方法がありませんでした。8月29日に否定的な報告が急増したとき、私たちはそれを標準的なロードバランシングの変更とすぐには結びつけませんでした。

## 今後の変更点

インフラストラクチャの改善を続ける中で、Claude を提供するすべてのプラットフォームで、上記のようなバグを評価し、防止する方法も改善しています。以下が変更点です。

* **より高感度な評価**: 特定の問題の根本原因を発見しやすくするため、正常な実装と壊れた実装をより確実に区別できる評価方法を開発しました。モデルの品質をより注意深く監視するために、これらの評価を改善し続けます。
* **より多くの場所での品質評価**: システムで定期的に評価を実行していますが、コンテキストウィンドウのロードバランシングエラーなどの問題をキャッチするために、実際のプロダクションシステムで継続的に実行します。
* **迅速なデバッグツール**: ユーザーのプライバシーを犠牲にすることなく、コミュニティから寄せられたフィードバックをより良くデバッグするためのインフラとツールを開発します。さらに、ここで開発されたいくつかの特注ツールは、将来同様のインシデントが発生した場合の修復時間を短縮するために使用されます。

評価と監視は重要です。しかし、これらのインシデントは、Claudeからの応答が通常の基準に達していない場合に、ユーザーからの継続的なシグナルも必要であることを示しました。観察された特定の変更の報告、遭遇した予期しない振る舞いの例、および異なるユースケースにわたるパターンはすべて、私たちが問題を特定するのに役立ちました。

ユーザーが直接フィードバックを送り続けてくれることは、引き続き特に役立ちます。Claude Codeで `/bug` コマンドを使用するか、Claudeアプリの「サムズダウン」ボタンを使用してフィードバックを送信できます。開発者や研究者は、私たちの内部テストを補完する新しい興味深いモデル品質評価方法をしばしば作成します。もしあなたの評価方法を共有したい場合は、<feedback@anthropic.com>までご連絡ください。

私たちは、コミュニティからのこれらの貢献に引き続き感謝しています。

---

[1] XLA:TPUは、XLA（High Level Optimizing language）—しばしばJAXを使用して記述される—をTPUマシン命令に変換する最適化コンパイラです。

[2] 私たちのモデルは単一のチップには大きすぎるため、数十以上のチップに分割されており、ソーティング操作は分散ソートになります。TPU（GPUやTrainiumと同様）はCPUとは異なるパフォーマンス特性を持ち、シリアルアルゴリズムの代わりにベクトル化された操作を使用した異なる実装技術が必要です。

[3] この近似操作は、パフォーマンスを大幅に向上させるため使用していました。この近似は、最も低い確率のトークンにおける潜在的な不正確さを受け入れることで機能しますが、バグによって最も高い確率のトークンをドロップさせてしまった場合を除き、品質に影響を与えるべきではありません。

[4] 現在の正しいtop-k実装は、top-pしきい値に近いトークンの包含にわずかな違いをもたらす可能性があり、まれにユーザーはtop-pの選択を再調整することで恩恵を受ける可能性があることに注意してください。
