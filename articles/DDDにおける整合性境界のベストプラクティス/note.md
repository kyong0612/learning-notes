# DDDにおける整合性境界のベストプラクティス

ref: <https://sizu.me/j5ik2o/posts/4eb3o143k1ws>

## 強い整合性と集約の境界

- **強い整合性**とは、ACIDトランザクションで一貫性を保ちたい範囲を指す。
  - RDBMSやその他ストレージでも同様の考え方が適用可能。
- **集約 (Aggregate)** は「整合性を保つための最小単位」。
  - 1つの集約を更新するとき、整合性はその内部だけで完結する設計が基本。
- 複数の集約間で強い整合性が必要な場合:
  - 集約の再設計を検討することが推奨される。
  - 分散トランザクションが必要になる場合、設計見直しを含め慎重な判断が必要。

## 弱い整合性とユースケース／サーガ

- 複数の集約にまたがる操作では、**弱い整合性 (Eventual Consistency)** を採用することが一般的。
  - ユースケースやサーガ (プロセスマネージャー) などで責任を持たせる。
  - イベントやメッセージ駆動で非同期的に整合性を担保する。
- 弱い整合性の特徴:
  - 即時的なACIDを保証せず、段階的・非同期的に矛盾を解消する。

## ユースケースをそのまま強いトランザクション境界としない理由

- **ユースケース = トランザクション境界**とすると以下のリスクがある:
  - 複数の集約が1つの大きなトランザクションに押し込められる。
  - 集約ごとに強い整合性を保つというDDDの基本ルールが破られやすくなる。
- **ユースケースの本来の責務**:
  - ビジネスロジックやアプリケーションフローの単位として機能すること。
  - 複数の集約を協調させる（弱い整合性を保つ）役割を担う。

## まとめ

- **強い整合性 (ACID)**:
  - 1集約単位で維持する。
  - 必要ならRDBMSトランザクションを利用。
- **弱い整合性**:
  - 複数の集約間の状態をユースケースやサーガで最終的に整合させる。
  - 同時コミットが必要な場合は集約定義を見直す。
  - イベント駆動やサーガパターンを活用。
- 設計の指針:
  - 「ユースケースを強いトランザクション境界としない」ことで、集約内部の整合性を守りつつ、複数集約の協調を実現する。
