---
title: "ナレッジワークにおけるデータ基盤の構成 - 2025/09"
source: "https://zenn.dev/knowledgework/articles/knowledgework-data-platform-20250905"
author:
  - "sisisin"
published: 2025-09-14
created: 2025-09-16
description: |
  この記事では、株式会社ナレッジワークにおける2025年9月時点でのデータ基盤の構成、その設計思想、そして現在に至るまでの経緯について解説します。Google Cloudを中心に構築されたデータ基盤の全体像から、各レイヤーでのデータの流れ、dbtを用いたデータ変換、そして最終的なデータ活用までを詳述しています。
tags:
  - "Google Cloud"
  - "BigQuery"
  - "データ基盤"
  - "dbt"
  - "tech"
---

この記事は、株式会社ナレッジワークのエンジニアであるsisisin氏による、2025年9月時点での同社のデータ基盤の構成、設計思想、およびその経緯についての解説です。

## 前提：ナレッジワークのサービスとデータ基盤

- **サービス基盤**: 主にGoogle Cloud (CloudSQL for PostgreSQL, BigQuery) 上に構築されており、`dev`, `qa`, `stg`, `prd`の4つの環境で運用されています。
- **データ基盤の役割**: 社内でのデータ活用に加え、顧客向けに提供する分析レポート出力機能にも利用されます。

## データ基盤の全体像

Google CloudとBigQueryを中心に構築され、データの抽出・変換・集計にはdbtをCloud Run Jobで実行しています。

![データ基盤の全体像](https://res.cloudinary.com/zenn/image/fetch/s--JXOnhR8i--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_1200/https://storage.googleapis.com/zenn-user-upload/deployed-images/caee85b1a2becc62973518df.png%3Fsha%3Db81d7c29a6b558c3f5e17f14d7d20f8507c530ef)

### 論理レイヤー

`Data Sources` → `Data Lake` → `Data Warehouse` → `Data Marts` → `Data Consumers` の5層構造でデータを管理しています。

| レイヤー | 説明 |
| --- | --- |
| **Data Sources** | CloudSQL, Google Analytics, スプレッドシートなどの元データ。 |
| **Data Lake** | ソースデータをBigQueryに格納。元の構造を極力維持。 |
| **Data Warehouse** | 分析用に整形されたデータ。dbtのStaging, Intermediateモデルが該当。 |
| **Data Marts** | 特定の目的に特化したデータ。dbtのMartモデルが該当。 |
| **Data Consumers** | BIツールやナレッジワークのサービスなど、データの利用者。 |

### 物理インフラ

3種類のGoogle Cloudプロジェクトを目的別に利用し、役割を明確に分離しています。

| プロジェクト名 | 説明 |
| --- | --- |
| `knowledgework-{env}` | サービス基盤のプロジェクト。サービスのData Lakeもここに配置。 |
| `kwdp-elt` | データ基盤のコアプロジェクト。Data LakeとData Warehouseを担う。 |
| `kwdp-mart` | データマート用プロジェクト。BIツールなどもホスティング。 |

## データフロー

### 1. Data Sources → Data Lake

各種データソースからBigQueryへデータを取り込みます。

![Data SourcesからData Lakeへのデータフロー](https://res.cloudinary.com/zenn/image/fetch/s--Aot9SWLD--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_1200/https://storage.googleapis.com/zenn-user-upload/deployed-images/b82c310e82949d47bc0f2b87.png%3Fsha%3D2b1e3e05c634d324cd6f682a9e76c58787e9d3d9)

- **サービス由来のデータ**:
  - **CloudSQL**: Datastreamを使い、BigQueryへストリーミング。
  - **Google Analytics**: BigQuery Export機能を利用。
  - **Cloud Logging**: Log Sink経由でBigQueryから参照可能に。
- **社内システム由来のデータ (例: GitHub)**: WebhookイベントをCloud Runで受け、Pub/Sub経由でBigQueryのJSON型カラムに直接格納。スキーマ変更への耐性を持たせています。

### 2. Data Lake → Data Warehouse → Data Mart

BigQueryに取り込んだデータをdbtで変換・集計し、データマートへ出力します。

![dbtを中心としたデータ変換・集計フロー](https://res.cloudinary.com/zenn/image/fetch/s--7T2X6CO---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_1200/https://storage.googleapis.com/zenn-user-upload/deployed-images/97ca7c82b632b911c0cb8dc4.png%3Fsha%3Dbdf4e05a9bea4f52e40a3c9e5eae570dd4d85348)

- **dbt実行基盤**: `kwdp-elt` プロジェクトに4環境（dev, qa, stg, prd）分のdbt実行用Cloud Run Jobを集約。これにより、デプロイライフサイクルや権限管理の課題を解決しています。
- **dbtによるデータの流れ**: `DBT_TARGET` 環境変数を切り替えることで、各環境に応じたデータソースの参照やデータマートへの出力先を動的に変更しています。中間生成物は `kwdp-elt` に、最終的なデータマートは用途に応じて `knowledgework-{env}` または `kwdp-mart` に出力されます。

### 3. Data Marts → Data Consumers

dbtによって生成されたデータマートを、サービスや社内BIツールで活用します。

![Data MartsからData Consumersへのデータ活用フロー](https://res.cloudinary.com/zenn/image/fetch/s--Sp4w3g1x--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_1200/https://storage.googleapis.com/zenn-user-upload/deployed-images/838a279f0a9f2ea7e70cc990.png%3Fsha%3D9d0dc41aff48eb0fb51a095ec0047a64967f70c7)

- **サービス向け出力**: `knowledgework-{env}` プロジェクト内のDatasetに出力。機能ごとにDatasetを分割し、適切な権限管理を実現。レポート機能にはSLAが設定されています。
- **社内利用向け出力**: `kwdp-mart` プロジェクトに出力。オーナーシップごとにDatasetを細かく分け、管理を容易にしています。
- **BIツール**: 主にLightdashとRedashを利用。Redashはユーザー個別の権限でBigQueryにクエリできない課題がありましたが、LightdashではGoogleログインユーザーの権限でクエリが実行できるため、より細かいアクセス制御が可能になっています。

## まとめ

ナレッジワークのデータ基盤は、Google Cloudのサービスを効果的に組み合わせ、dbtを中心に据えることで、複数の環境と多様なユースケースに対応できる柔軟なアーキテクチャを実現しています。プロジェクトの分割による役割の明確化や、BIツールの選定における権限制御への配慮など、運用面での工夫もなされています。
