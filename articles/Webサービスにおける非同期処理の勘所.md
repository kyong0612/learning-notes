---
title: "Webサービスにおける非同期処理の勘所"
source: "https://www.pospome.work/entry/2025/09/24/114738"
author:
  - "[[pospome (id:pospome)]]"
published: 2025-09-24
created: 2025-09-25
description: "株式会社カミナシで VPoE を務めている pospome です。 (´・ω・`) 最近非同期処理について考えることがあったので、そのときに考えたことをサクッとまとめようと思います。 非同期処理について体系的にまとめたものではなく、あくまで \"その時に考えた限定的な内容\" になります。 Webサービスにおける非同期処理とは 非同期処理はめんどくさい 同期処理では要件を満たせないケース 非同期処理の面倒なポイント 1. メッセージキュー/タスクキューに対する理解 2. ワーカー処理が失敗したときのリカバリ方法を考える 3. ボトルネックの確認と対策 補足：非同期処理を上手く扱えるようになろう ま…"
tags:
  - "clippings"
  - "非同期処理"
  - "Webサービス"
  - "アーキテクチャ"
  - "メッセージキュー"
---

## Webサービスにおける非同期処理とは

本記事での「非同期処理」とは、AWS SQSやGoogle Cloud Pub/Subのようなメッセージキューを利用した処理を指します。具体的には、バックエンドサーバーがメッセージキューにタスク（メッセージ）を登録し、それを別プロセスであるワーカーが受け取って処理するモデルです。

```
クライアント -----> バックエンドサーバ -----> AWS SQS -----> ワーカー
```

Webサービスの開発では多くの処理が同期的に実装されますが、特定の要件を満たすために非同期処理が必要になる場合があります。

## 非同期処理はめんどくさい

基本的に非同期処理は複雑で面倒なため、「同期処理では要件を満たせない時」に限定して採用するのが望ましいとされています。

## 同期処理では要件を満たせないケース

同期処理が不適切な代表的なケースは以下の通りです。

* **巨大なCSVファイルのダウンロード処理**: 同期処理ではユーザーを長時間待たせたり、データベースへの負荷が高まったりする問題があります。「CSVのアップロード＆DB登録」も同様です。
* **高RPS環境でレイテンシの高い外部APIを複数回呼び出す処理**: 同期処理ではバックエンドサーバーに通信が滞留し、コネクションプールの枯渇やスケール効率の悪化を引き起こす可能性があります。

多くの場合、「同期処理だと厳しいから非同期処理を使う」という判断になります。重要なのは、非同期処理を扱う際に何を考慮すべきかを理解することです。実装自体は難しくありませんが、考慮漏れがあるとリリース後の運用で問題が発生します。

## 非同期処理の面倒なポイント

設計フェーズで以下の点を考慮することが重要です。

### 1. メッセージキュー/タスクキューに対する理解

AWS SQSやGoogle Cloud Pub/Subなどの利用するサービスの仕様、機能、オプション、制限を十分に理解する必要があります。例えば、キューに溜まったメッセージ数に応じたワーカースケーリングの運用や、そのためのアラート設定などを事前に検討しておくべきです。

### 2. ワーカー処理が失敗したときのリカバリ方法を考える

ワーカーの処理は100%成功するとは限りません。プログラミングミス、OOM（Out of Memory）、デッドレターキューへの移動など、様々な原因で失敗する可能性があります。そのため、リカバリ方法の設計が不可欠です。

* **手動リカバリ**: 失敗頻度が低い場合、エンジニアが手動でメッセージを再キューイングする方法が考えられます。しかし、ペイロードの確認やDBの状態整合性を取る作業は複雑で、手順書が陳腐化しやすいリスクがあります。
* **自動リカバリ**: 失敗した処理をDBに記録し、定期的なバッチでリトライする方法です。実装コストはかかりますが、失敗頻度が高い場合に有効です。

### 3. ボトルネックの確認と対策

非同期処理を導入しても、負荷やボトルネックがなくなるわけではありません。処理の最終段階でどこかに負荷が集中します。

例として「DBから大量のデータを取得して巨大なCSVファイルを作成する」ケースでは、DBへのクエリが負荷となり、システム全体に影響を与える可能性があります。

考えられる対策には以下のようなものがあり、それぞれのメリデメを比較検討する必要があります。

* 同時に実行できるワーカー数を制限する。
* ワーカー用のリードレプリカDBを用意する。
* キューイングできるメッセージ数を制限する。
* ワーカー処理に `sleep` を入れてクエリ実行間隔を調整する。

特にRDBはボトルネックになりやすいため、トラフィックの多い環境ではNoSQLやNewSQLのようなスケーラブルなDBの導入も検討すると良いでしょう。

## 補足：非同期処理を上手く扱えるようになろう

非同期処理は複雑ですが、システムのスケール性能やサービス間の疎結合化に大きく貢献します。ある程度の規模のシステムでは必須の技術となるため、組織として非同期処理を適切に扱えるようになるための投資と学習が重要です。

## まとめ

本記事では、Webサービスにおける非同期処理の勘所として、特に運用面で考慮すべきポイントをまとめました。
