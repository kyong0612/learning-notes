# Scaling Pinterest - From 0 to 10s of Billions of Page Views a Month in Two Years

ref: <https://highscalability.com/scaling-pinterest-from-0-to-10s-of-billions-of-page-views-a/>

## Pinterest のスケーリング: 2年間で月間ページビュー0から数百億へ

### 要約

Pinterest は驚異的な成長を遂げ、2年間で月間ページビューが0から数百億に達しました。この成長を支えるため、アーキテクチャは劇的に進化しました。この記事では、Pinterest のエンジニアである Yashwanth Nelapati 氏と Marty Weiner 氏が、そのスケーリングの道のりと学んだ教訓について語っています。

### 主要なポイント

* **急成長:** サービス開始後、特に2011年には1ヶ月半ごとに倍増するペースで成長。
* **アーキテクチャの進化:**
  * **初期 (2010年3月):** Rackspace 上の小さな Web エンジン1台と MySQL DB 1台でスタート。
  * **ステルス期 (2011年1月):** Amazon EC2/S3/CloudFront に移行。NGinX 1台、Web エンジン4台、MySQL DB 1台 + スレーブ1台、MongoDB 1台など。
  * **実験期 (2011年9月まで):** 急成長により多くの技術（Cassandra, Membase, Memcache, Redis, Elastic Search, Mongo など）を導入するも、限界に達し、多くの問題が発生。結果として、アーキテクチャの再構築を決断。
  * **成熟期 (2012年1月):** MySQL, Redis, Memcache, Sharded Solr に技術スタックを絞り込み、シンプルで成熟した技術を選択。Web エンジン90台、API エンジン50台、MySQL DB 66台など、大幅にスケール。
  * **現在 (2012年10月):** さらにスケールし、Web エンジン180台、API エンジン240台、MySQL DB 88台、Redis 110台、Memcache 200台など。アーキテクチャは「同じものを追加する」ことでスケール可能に。
* **技術選択の哲学:**
  * 成熟していること (Mature)
  * 非常に優れており、シンプルであること (Really good and simple)
  * よく知られており、好まれていること (Well known and liked)
  * サポートが充実していること (Well supported)
  * 一貫して良好なパフォーマンスを発揮すること (Consistently good performers)
  * 可能な限り障害がないこと (Failure free as possible)
  * 無料であること (Free)
  * この基準に基づき、MySQL, Solr, Memcache, Redis を選択。Cassandra や Mongo は廃止。
* **Amazon EC2/S3 の採用理由:** 信頼性、優れたレポートとサポート、周辺サービス（ELB, MapReduce など）の充実、インスタンスの迅速な起動。
* **MySQL, Memcache, Redis の採用理由:** 成熟度、シンプルさ、パフォーマンス、コミュニティサポート、無料である点などが評価された。
* **クラスタリング vs シャーディング:**
  * **クラスタリング (Cassandra, Membase, HBaseなど):** 自動的なデータ分散、移動、リバランス、ノード間通信。セットアップは容易だが、根本的に複雑で障害モードが多く、コミュニティサポートが分散しがち。特にクラスター管理アルゴリズムが単一障害点 (SPOF) になり得る。Pinterest はデータリバランスの失敗、データ破損、不適切なバランシング、データ権限の失敗などを経験し、怖すぎると判断。
  * **シャーディング:** 手動でのデータ分散、データは移動しない、ノードは互いを認識しない。データ配置アルゴリズムがシンプル（SPOF だがコード量が少ない）。結合やトランザクションに制約が出るが、アプリケーション層で対応。Pinterest はこちらを選択。
* **シャーディング戦略:**
  * 可能な限りクエリ数を減らし、単一ページ表示に必要なデータベースアクセス数を最小限にする。
  * MySQL の JOIN をすべて排除。
  * 大量のキャッシュを追加。
  * プロジェクトの成長を予測し、事前に十分なシャードを用意（仮想シャード）。
  * ユーザーに関連するデータ（ピン、ボードなど）は同じシャードに配置 (collocation)。これによりユーザープロファイル表示などが高速化。
  * ID 構造: 64ビット (シャードID 16ビット + タイプ 10ビット + ローカルID)。ID自体にシャード情報を含めることで、ルックアップテーブルなしで直接アクセス可能。
  * オブジェクト (Pin, Board, Userなど) とマッピング (user\_has\_boards など) でデータを管理。オブジェクトは MySQL の BLOB (Thrift シリアライズ) に格納。
  * スキーマ変更は BLOB のバージョン管理で対応。ALTER TABLE のロック問題を回避。新しいインデックスが必要な場合は新しいテーブルを作成。
* **シャーディングへの移行:** フィーチャーフリーズを実施し、旧インフラと新インフラの両方に書き込みながら、スクリプトでデータを移行。予想以上に時間がかかった (4-5ヶ月)。
* **開発体制:** Facebook モデルを採用し、全員がすべてにアクセス可能。注意が必要。
* **将来の方向性:** サービスベースアーキテクチャへの移行。機能分離、接続数の削減、チーム編成の容易化、セキュリティ向上などが目的。

### 重要な結論と教訓

* **シンプルさを保つ:** システムは必ず失敗する。シンプルさが重要。
* **スケール可能なアーキテクチャ:** 成長は「同じものを追加する」ことで対応できるべき。資金投入（=サーバー追加）でスケールできるアーキテクチャを目指す。
* **技術選択:** 成熟し、シンプルで、サポートが充実した技術を選ぶ。限界まで使うとどんな技術も壊れるが、成熟した技術は問題解決の助けとなるコミュニティがある。
* **シャーディングの優位性:** Pinterest の経験では、クラスタリングよりもシャーディングの方が、障害モードが少なく、管理しやすく、安定性が高い。ノード間でデータを移動させないことが安定性の鍵。
* **サービス指向アーキテクチャ:** 機能分離、接続数削減、チーム編成、セキュリティ向上に役立つ。
* **ビジョンを持つ:** 自分たちが本当に目指す姿を問い、それに合わない技術は捨てる勇気を持つ。
* **多少のデータ損失は許容する:** 完全なデータ整合性よりも、シンプルで堅牢なシステムの方が重要。Redis のホームフィードのように、数時間のデータ損失を許容することで、よりシンプルで信頼性の高いアーキテクチャを実現。

(注: 元記事の画像はマークダウン形式では直接埋め込めないため、省略しています。)
