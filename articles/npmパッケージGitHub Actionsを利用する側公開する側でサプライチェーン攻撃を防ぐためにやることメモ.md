---
title: "npmパッケージ/GitHub Actionsを利用する側/公開する側でサプライチェーン攻撃を防ぐためにやることメモ"
source: "https://zenn.dev/azu/articles/ad168118524135"
author:
  - "azu"
published: 2025-09-09
created: 2025-09-19
description: |
  パッケージを利用する側、パッケージを公開する側でサプライチェーン攻撃を防ぐためにできることのメモ書きです。
tags:
  - "GitHub"
  - "npm"
  - "Security"
  - "githubaction"
  - "tech"
---

npmパッケージやGitHub Actionsのサプライチェーン攻撃を防ぐための対策について、パッケージの「利用する側」と「公開する側」の双方の視点からまとめたメモ。

## パッケージを利用する側

npmやGitHub Actionsなどを利用する側として、サプライチェーン攻撃を防ぐために以下の対策が挙げられています。

### 1. 依存関係のバージョンを固定する

* **ロックファイルの使用**: `package-lock.json`や`yarn.lock`などを用いて、依存関係のバージョンを厳密に固定する。
* **GitHub ActionsのSHA Pin**: `actions/checkout@v5.0.0`のようなタグ指定ではなく、`actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8`のようにコミットハッシュでバージョンを固定（ピニング）する。これにより、タグが不正なコミットを指すよう変更された場合でも影響を受けない。

### 2. 権限を最小化する

* **GitHub Actionsの最小権限**: ワークフローには`permissions`設定で必要最小限の権限のみを付与する。例えば、コードの読み取りだけであれば`contents: read`を指定する。

### 3. 安全でないスクリプト実行を防ぐ

* **ライフサイクルスクリプトの無効化**: `postinstall`のようなスクリプトは、マルウェアが機密情報を盗む起点となりやすいため、デフォルトで実行しないようにする。`pnpm` v10や `bun` ではデフォルトで無効化されており、`npm`では`--ignore-scripts`オプションで対応可能。

### 4. 安全なタイミングで依存を更新する

* **アップデートの冷却期間**: dependabotやrenovatebotには、パッケージが公開されてから一定期間（例: 7日間）が経過した後にアップデートPRを作成する`cooldown`や`minimumReleaseAge`といったオプションがある。これにより、公開直後のサプライチェーン攻撃に巻き込まれるリスクを低減できる。
* **偽のPRへの警戒**: dependabotになりすましたPRも考えられるため、`@dependabot merge`コメントでマージすることで、本物のdependabotからのPRであるかを確認できる。

### 5. `npx`の安全な利用

* **パッケージスキャンの徹底**: `npx`は最新版を自動でダウンロード・実行するため、安全性が確認されていないパッケージを実行しない。Socket.devなどのスキャンツールを利用して、実行前にパッケージを検証する。
* **バージョンの固定**: 繰り返し利用するコマンドは`devDependencies`に含めるか、`npx some-package@1.2.3`のようにバージョンを明示的に指定して実行する。

### 6. AI Agentのサンドボックス実行

* AI Agentは予期せず外部パッケージをインストールすることがあるため、`sandbox-exec`やDockerコンテナなどのサンドボックス環境で実行し、システムへの影響を隔離する。

### 多層防御の考え方

これらの対策は多層防御の考え方に基づいています。

![パッケージ利用のレイヤー](https://storage.googleapis.com/zenn-user-upload/126eac18dc34-20250917.png)

1. **ロック**: バージョンピニングやロックファイルで依存を固定。
2. **事前スキャン**: Socket.devなどで既知のリスクを検出。
3. **インストール**: ライフサイクルスクリプトの無効化や冷却期間の設定。
4. **アップデート**: Renovate/Dependabotの冷却期間（7日など）を設定。
5. **検証・改ざん検出**: 署名、チェックサム、ロックファイルの整合性チェック。

## パッケージを公開する側

パッケージをnpm registryに公開する側として、攻撃者に認証情報を盗まれたりアカウントを乗っ取られたりするリスクを軽減するための対策です。

### 1. 機密情報をコミットしない

* **secretlintの導入**: `secretlint`などのツールを使い、コミットにAPIキーなどの機密情報が含まれていないかチェックする。

### 2. ローカルに生トークンを置かない

* マルウェアはローカルファイルから認証情報を盗むことが多いため、`.env`ファイルなどにも生のトークンを保存しない。1Passwordなどのパスワードマネージャーと連携し、実行時に認証情報をメモリ上でのみ扱うようにする。

### 3. トークンのスコープを最小化する

* npmのGranular access tokensやGitHubのFine-grained personal access tokensを利用し、トークンに付与する権限（スコープ）を必要最小限に絞る。

### 4. GitHub Actionsのセキュリティチェック

* GitHub Actionsのワークフローでは、`${{ github.event.issue.title }}`のような信頼できない入力を`run`ステップで直接展開すると、スクリプトインジェクションの脆弱性につながる可能性がある。ワークフローを変更するPRは、マージ前にセキュリティチェックを行う。

### 5. トークンレスでのパッケージ公開

* **Trusted Publishing (OIDC連携)**: CI/CDからnpmパッケージを公開する際は、OIDC連携を利用したTrusted Publishingを導入する。これにより、npmトークンを発行・管理する必要がなくなり、トークン漏洩のリスクを根本から排除できる。

### 6. npmパッケージの公開設定

* **2要素認証の必須化**: パッケージの設定で「Require two-factor authentication and disallow tokens」を有効にする。これにより、トークンを使った自動公開は禁止され、人間が2FAを入力しないと公開できなくなるため、マルウェアによる自動的な不正リリースを防げる。

### 7. フィッシング耐性の高いMFAを利用する

* SMSやTOTP（ワンタイムパスワード）はフィッシング攻撃に弱いため、WebAuthn/FIDO2（セキュリティキーやパスキー）といった耐性の高い多要素認証（MFA）を利用する。
