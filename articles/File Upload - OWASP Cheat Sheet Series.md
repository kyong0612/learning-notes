---
title: "File Upload - OWASP Cheat Sheet Series"
source: "https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html"
author: "OWASP Cheat Sheet Series Team"
published:
created: 2025-09-04
description: "セキュアなファイルアップロード実装のための包括的なガイド。悪意のあるファイル、不適切なファイル検証、およびファイルアップロード機能に関連するセキュリティ脅威から保護するためのベストプラクティスと防御戦略を提供。"
tags:
  - "security"
  - "file-upload" 
  - "web-security"
  - "owasp"
  - "validation"
  - "defense-in-depth"
---

# File Upload Cheat Sheet 要約

## はじめに

ファイルアップロード機能は現代のアプリケーションにおいて重要な要素となっており、ユーザーが写真、CV、プロジェクト動画などをアップロードできる機能を提供しています。アプリケーションは悪意のあるファイルや偽装ファイルから身を守り、アプリケーションとユーザーの安全を保つ必要があります。

## セキュアなファイルアップロード実装の原則

セキュアなファイルアップロード実装のために以下の原則に従うべきです：

### 基本原則

- **許可する拡張子のリスト化**: ビジネス機能に必要な安全で重要な拡張子のみを許可
- **拡張子検証前の入力検証の実装**
- **ファイルタイプの検証**: Content-Typeヘッダーは偽装可能なため信頼しない
- **ファイル名の変更**: アプリケーションが生成したファイル名を使用
- **ファイル名の長さ制限と文字制限の設定**
- **ファイルサイズ制限の設定**
- **認証されたユーザーのみにアップロード許可**
- **別サーバーでのファイル保存**: 不可能な場合はWebroot外に保存
- **パブリックアクセスの場合**: アプリケーション内でファイル名にマップされるハンドラを使用
- **アンチウイルスやサンドボックスでの検証**
- **CDR（Content Disarm & Reconstruct）の実行**: 適用可能なファイルタイプ（PDF、DOCXなど）
- **ライブラリの安全な設定と最新状態の維持**
- **CSRFからのファイルアップロード保護**

## ファイルアップロードの脅威

### 悪意のあるファイル

攻撃者は以下のような悪意のあるファイルを送信する可能性があります：

1. **パーサーや処理モジュールの脆弱性を悪用**
   - ImageTrick Exploit
   - XXE（XML外部エンティティ）攻撃

2. **フィッシング目的でのファイル使用**
   - 求人応募フォームなど

3. **DoS攻撃**
   - ZIPボム
   - XMLボム（billion laughs attack）
   - 大容量ファイルによるサーバーストレージの圧迫

4. **既存ファイルの上書き**

5. **クライアントサイドアクティブコンテンツ**
   - XSS、CSRFなど（ファイルが公開されている場合）

### パブリックファイル検索

アップロードされたファイルが公開されている場合の追加脅威：

1. **他のファイルの公開暴露**
2. **DoS攻撃の開始**: 小さなリクエストで大きなレスポンスを要求
3. **違法、不適切、危険なファイルコンテンツ**: 個人データ、著作権データなど

## ファイルアップロード保護

セキュリティ対策では多層防御アプローチが重要です。単一の技術では十分ではなく、複数の技術の実装が推奨されます。

### 拡張子検証

#### 許可拡張子リスト

- ビジネス要件に必要な拡張子のみを許可
- 最も害が少なく、リスクが最低のファイルタイプを使用
- 例：
  - 画像アップロード：合意された1つのタイプのみ
  - CV アップロード：docxとpdfのみ

#### 拡張子ブロック

- 有害な可能性のあるファイルタイプを識別してブロック
- 注意：拡張子ブロックは単独では弱い保護方法

#### 検証時の注意点

- ファイル名デコード後の検証を実施
- 以下のようなバイパス手法を防ぐ適切なフィルターを設置：
  - 二重拡張子：`.jpg.php`
  - ヌルバイト：`.php%00.jpg`
  - 不適切な正規表現

### Content-Type検証

- ユーザーが提供するContent-Typeは信頼できないため、セキュリティの主要手段とすべきではない
- 簡単な保護として許可リストまたは拒否リストアプローチで実装

### ファイルシグネチャ検証

- Content-Type検証と併用してファイルシグネチャを検証
- 単独では使用せず、バイパスが容易であることを認識

### ファイル名の安全性

#### 推奨アプローチ

- **ランダム文字列の生成**: UUID/GUIDの生成が最適
- ビジネス要件でファイル名が必要な場合：
  - 最大長の実装
  - 文字を許可されたサブセット（英数字、ハイフン、スペース、ピリオド）に制限
  - 先頭ピリオド（隠しファイル）と連続ピリオド（ディレクトリトラバーサル）の制限
  - 先頭ハイフンやスペースの制限

### ファイルコンテンツ検証

ファイルタイプに基づく特別な検証：

- **画像**: 画像書き換え技術により悪意のあるコンテンツを削除
- **Microsoft文書**: Apache POIを使用した文書検証
- **ZIPファイル**: 多様な攻撃ベクターのため推奨されない

### ファイル保存場所

セキュリティ優先順位による推奨事項：

1. **別ホストでの保存**: 最も安全
2. **Webroot外での保存**: 管理者アクセスのみ
3. **Webroot内での保存**: 書き込み権限のみ設定

### ユーザー権限

二つのレベルでの検証：

- **認証レベル**: 登録済みまたは識別可能なユーザー
- **認可レベル**: ファイルアクセス・変更の適切な権限

### ファイルシステム権限

- 最小権限の原則に基づく設定
- 許可されたシステムユーザーのみがファイル読み取り可能
- 実行が必要な場合は事前スキャンが必要

### アップロード・ダウンロード制限

- ファイル保存容量保護のための適切なサイズ制限
- 圧縮ファイルの場合は展開後のサイズを考慮
- DoS攻撃防止のためのダウンロードサービスリクエスト制限

## Javaコードスニペット

OWASPチートシートでは、Dominique氏による「Document Upload Protection」リポジトリがJavaでの特定文書タイプの処理例として紹介されています。

## 重要な結論

- **多層防御が不可欠**: 単一の保護手法では不十分
- **最小権限の原則**: 必要最小限の機能のみを提供
- **継続的な監視と更新**: ライブラリとセキュリティ対策の定期的な更新
- **ビジネス要件との調和**: セキュリティとユーザビリティのバランス

この文書は、ファイルアップロード機能を実装する開発者にとって、セキュリティリスクを最小限に抑えるための実践的なガイドラインを提供しています。
