---
title: "緯度経度からの住所検索！〜日本の住所に絶望し、希望を見つけるまで〜"
source: "https://zenn.dev/layerx/articles/489e81aae2e33b"
author:
  - "yata (@arfes)"
  - "LayerX"
published: 2025-12-12
created: 2025-12-16
description: |
  緯度経度から住所を検索する「逆ジオコーディング」の実装について、外部APIの比較検討から日本の住所システムの複雑さに直面し、最終的に国土地理院の位置参照情報を利用した独自のソリューションを構築するまでの過程を解説した技術記事。
tags:
  - "geolocation"
  - "geohash"
  - "逆ジオコーディング"
  - "位置参照情報"
  - "住所検索"
  - "LayerX"
  - "技術選定"
---

## 概要

この記事は、LayerX Tech Advent Calendar 2025 の12日目の記事。「緯度経度から住所を割り出す」という一見シンプルな要件が、日本の住所システムの複雑さにより困難になり、最終的に国土地理院の位置参照情報を活用した独自ソリューションに辿り着くまでの物語。

---

## やりたかったこと

**実装目標**: デバイスの位置情報を記録し、画面上から確認できる機能

### 満たすべき要件

1. **デバイスから緯度経度を取得できること** - `Geolocation API`で実現可能
2. **画面上でパッと見て場所が分かること** - 緯度経度の数値だけでは直感的に理解できない
3. **可能な限り低コストであること** - この機能は「存在自体に価値がある」機能であり、突き詰めた精度は必要なし

---

## 検討①：地図で出すか？住所で出すか？

### 案1：地図を表示する（Google Maps埋め込み等）

| Good | Bad |
|------|-----|
| ビジュアルで分かりやすい | 画面スペースを取る |
| 周辺情報も見ることができる | 縮尺によっては結局どこか分からない |

### 案2：住所（文字）を表示する

| Good | Bad |
|------|-----|
| 省スペースで、リスト表示でも邪魔にならない | 土地勘がない場所だと、文字だけ見てもピンとこない |

### 結論：住所（文字）を採用

**理由**:

- 地図API（Google Maps Platform等）の従量課金が高額になるリスク回避
- 一覧性の重視
- 複数の位置情報表示時、画面上に大量の地図が表示されることを避ける

**補完策**: 住所をクリックすると外部リンクでGoogle Mapsへ飛ぶ仕様でカバー

---

## 検討②：逆ジオコーディングAPIの比較

緯度経度から住所を割り出す処理を「**逆ジオコーディング**」と呼ぶ。

### 主要サービス比較表（2025年10月時点）

| サービス | 金額 | キャッシュ可否 | 信頼性 | 使いやすさ |
|---------|------|--------------|--------|----------|
| **国土地理院 API** | ✅ 無料 | ❓ 不明 | ❌ 非公式・保証なし | ❌ 都道府県などが別取得 |
| **Google Maps Geocoding API** | ❌ 高め ($5 / 1,000 req) | ❌ 禁止 | ✅ 問題なさそう | ✅ 一括取得可 |
| **OpenCage Geocoding API** | ✅ 安い (月2万req程度で約1万円〜) | ✅ 無期限に可能 | ✅ 問題なさそう | ✅ 一括取得可 |
| **HERE Geocoding & Search** | ⚠️ 普通 (月3万reqまで無料) | ⚠️ 30日間可能 | ✅ 問題なさそう | ✅ 一括取得可 |

### 初期選択：OpenCage Geocoding API

**決め手**:

- コスパが良い
- **キャッシュが無期限で許可** → 一定期間運用でリクエストをほぼ0にできる
- ソフトレートリミットで安心
- 全てのデータを構造的に取得可能

---

## 【悲報】日本の住所、難しすぎる問題

開発中盤で発覚した問題：**住所のレイヤー（階層）が揃わない**

### 問題の詳細

APIから返ってくる住所の精度にかなりバラつきがあることが判明。「〇丁目」という情報が異なるフィールドに格納されるなど、一貫性がなかった。

```json
// OpenCage Geocoding APIの返り値サンプル（一部抜粋）
{
  "components": {
    "city": "浦安市",
    "country": "日本",
    "neighbourhood": "舞浜三丁目",
    "province": "千葉県",
    "quarter": "舞浜",
    "theme_park": "東京ディズニーランド"
  }
}
```

### 日本の住所が難しい理由

- 全てが「〇〇県〇〇市〇〇丁目〇〇」のように綺麗なフォーマットで統一されていない
- 郡、政令指定都市、入り組んだ地名の歴史など非常に複雑
- 全世界対応の逆ジオコーディングAPIでは対応が困難

### 精度検証結果

国土地理院の[位置参照情報](https://nlftp.mlit.go.jp/cgi-bin/isj/dls/_choose_method.cgi)を正解データとして使用し、各都道府県からランダム10件、計470件で検証。

**完全一致率**:

- **OpenCage**: 394/470件 (83.8%)
- **HERE**: 427/470件 (90.8%)

→ お客様に安定した体験を届けるには不十分と判断

---

## 【朗報】天啓、来たる

**発想の転換**: 「位置参照情報が正しいんだったら、そっから検索すればいいじゃん」

### 位置参照情報の利点

- 国が公式に出しているデータで住所レベルの正確さが保証
- フォーマットが統一されている
- 住居表示が実施されていない場所（山奥など）はGoogle Mapsへの外部リンクで補完

### 最終比較表

|  | OpenCage API | HERE API | Google Maps API | 位置参照情報 |
|--|--------------|----------|-----------------|-------------|
| 実装コスト | ✅ 低 | ✅ 低 | ✅ 低 | ⚠️ 中 |
| 精度 | ⚠️ 中 (76/470件不一致) | ☑️ 高 (43/470件不一致) | - (未検証) | ☑️ 高 |
| レスポンス速度 | ✅ 高速 | ✅ 高速 | ✅ 高速 | ⚠️ 遅い (約1.3秒) |
| 料金 | ✅ 安価 | ⚠️ 安価〜中程度 | ❌ 高額 (際限なし) | ✅ 無料 |
| キャッシュ可否 | ✅ 無期限可能 | ⚠️ 30日間可能 | ❌ 禁止 | ✅ 制限なし |

---

## 最終的なアーキテクチャ

### 1. データの準備

国土地理院の位置参照情報から全都道府県の街区レベルデータ（**約2,000万行**）をダウンロードし、自社データベースにインポートして住所マスタテーブルを作成。

### 2. 空間検索の実装

デバイスの緯度経度をもとに、DB内で「最も近い場所」を検索。**空間インデックス（Spatial Index）**を活用することで、2,000万件のデータからでも**1秒前後**で検索可能。

### 3. キャッシュ戦略（Geohash）

ユーザー待ち時間削減のため、[Geohash](https://ja.wikipedia.org/wiki/Geohash)（地図をグリッドで区切って文字列化したもの）を活用。

**仕組み**:

1. 初回検索時は住所マスタテーブルから最も近い住所を検索・返却
2. その位置が所属するGeohash（8桁、約30m四方）がキャッシュテーブルになければ保存
3. 2回目以降、同じGeohash内での検索履歴があればキャッシュから即座に返却

### 精度検証結果

- 位置参照情報を正解データとした検証：**100%**（当然の結果）
- 実際の地図上の点でランダム検証：**90%以上**の精度

```
// 各住所内のランダム1000点での精度検証
住所A: 780/1000
住所B: 934/1000
住所C: 1000/1000
住所D: 983/1000
住所E: 987/1000
住所F: 0/1000（Google Maps上では住所が存在している山奥）
住所G: 921/1000
住所H: 990/1000
```

### APIとの違い・メリット

- **管理コストの軽減**: HEREは30日ごとにキャッシュ削除が必要だが、自前DBなら年1回の更新で済む
- **無期限キャッシュ**: リクエスト数が緩やかにしか増加しない
- **コスト**: 既存インスタンスに乗るだけなので数十円程度

---

## まとめ

### 最終結果

- **外部APIコストはゼロ**
- **住所の表記揺れや階層ズレがない**
- **レスポンスも高速**

### 学び

「外部APIを使えばサクッと終わるだろう」と高を括っていたタスクが、日本の住所という魔境に絶望しかけたが、国土地理院のデータを活用することで当初の要件以上の結果を達成。

---

## 参考情報

- [国土地理院 位置参照情報ダウンロードサイト](https://nlftp.mlit.go.jp/cgi-bin/isj/dls/_choose_method.cgi)
- [住所の正規化がいかに難しいかという話 - Kenall Blog](https://blog.kenall.jp/entry/kenall-newsletter-vol7)
- [OpenCage Geocoding API](https://opencagedata.com/)
- [HERE Geocoding & Search](https://www.here.com/platform/geocoding)
- [Google Maps Geocoding API](https://developers.google.com/maps/documentation/geocoding/overview?hl=ja)

> ⚠️ 位置参照情報を利用する場合は、出典の記載などの制約があるので[利用規約](https://nlftp.mlit.go.jp/ksj/other/agreement.html#agree-03)を確認すること。
