---
title: "HMACとは？認証の仕組みと実装 | Okta"
source: "https://www.okta.com/ja-jp/identity-101/hmac/"
author: "Okta"
published: 2024-08-28
created: 2026-01-23
description: "HMACとは、サイバー攻撃などから保護するために暗号鍵と公開鍵の2つの鍵を使用するメッセージ認証方法の1つです。HMACを使用することで、データの暗号化と、得られる情報の整合性チェックの両方が可能になります。今回はHMACの仕組みとHMACを実装した際にいつ、どのように使うかについて説明します。"
tags:
  - "clippings"
  - "HMAC"
  - "認証"
  - "暗号化"
  - "セキュリティ"
  - "ハッシュ関数"
---

## 概要

**HMAC（Hash-based Message Authentication Code）** は、ハッシュ関数と秘密鍵を組み合わせてメッセージの認証と完全性を検証する暗号化認証技術である。HMACを使用することで、2者間で安全に通信し、メッセージが改ざんされていないことを確認できる。

## HMACの仕組み

### 基本コンポーネント

HMACは以下の2つの主要コンポーネントを組み合わせる：

1. **暗号化キー（秘密鍵）** - 両者が所有し、機密を保持する共有秘密鍵
2. **ハッシュ関数** - メッセージを処理する暗号化アルゴリズム（SHA-1、SHA-256、MD5、RIPEMD-128/160など）

### 処理フロー

HMACは2パスのハッシュ計算を使用する：

1. 秘密鍵から内部キー（inner key）と外部キー（outer key）を導出
2. メッセージと内部キーから内部ハッシュを生成
3. 内部ハッシュ結果と外部キーから最終的なHMACコードを生成

この2パスアプローチにより、**長さ拡張攻撃（length extension attack）への耐性**が確保される。

## MACとHMACの違い

| 項目 | MAC | HMAC |
|------|-----|------|
| 定義 | 秘密鍵を使用してメッセージを認証するアルゴリズムの総称 | ハッシュ関数と秘密鍵を組み合わせた特定のMAC実装 |
| 種類 | CBC-MAC、UMAC、HMACなど複数の実装が存在 | MACの一種 |
| 初期化ベクトル | 必要な場合がある | 不要 |
| セキュリティ | 実装により異なる | 擬似ランダム関数（PRF）として証明されたセキュリティ |
| プライバシー | 定義上は平文に関する情報漏洩を防ぐ必要なし | 平文に関する情報を漏洩しないことを保証 |

## 対応ハッシュアルゴリズム

HMACは以下のハッシュ関数と組み合わせて使用可能：

- **MD5** - 128ビット出力（現在は非推奨）
- **SHA-1** - 160ビット出力（現在は非推奨）
- **SHA-256** - 256ビット出力（推奨）
- **SHA-384** - 384ビット出力
- **SHA-512** - 512ビット出力

> **セキュリティ注意**: MD5とSHA-1は脆弱性が発見されているため、新規実装ではSHA-256以上を使用することが推奨される。

## HMACの主な用途

### プロトコルでの使用

- **IPsec** - 認証ヘッダー（AH）、カプセル化セキュリティペイロード（ESP）、IKE/IKEv2でのデータ認証と完全性検証
- **TLS/SSL** - 通信の完全性保証
- **SSH** - セキュアシェル通信
- **JWT（JSON Web Tokens）** - トークンの署名と検証

### 実用的なユースケース

1. **API認証** - リクエストの完全性と認証
2. **ファイル検証** - ダウンロードファイルの改ざん検出
3. **セッション管理** - セッションデータの完全性保証
4. **ワンタイムパスワード** - TOTP/HOTPでの使用

## 実装要件

HMACを実装するには以下が必要：

1. **共有秘密（秘密鍵）** - サーバーと認証されたユーザー間でのみ共有
2. **ハッシュツール/アルゴリズム** - 使用するハッシュ関数の実装
3. **アルゴリズムの合意** - 当事者間でどのアルゴリズムを使用するかの合意

### Okta Workflowsでの実装例

Okta Workflowsでは、HMACファンクションカードが提供されており：

- **対応アルゴリズム**: MD5、SHA-1、SHA-256、SHA-384、SHA-512
- **出力形式**: Base64、hex、またはbinary
- **必要な入力**: 秘密鍵とデータ文字列（UTF-8のみ）

**例**: SHA-256を使用し、キー「my secret key」、データ「My secret message!」で実行すると：
```
qd83l7nEE4gBpuaueA+XtKFeZO99aV7IvGgsJ15qmyo= (Base64形式)
```

## セキュリティ考慮事項

1. **鍵の管理**
   - 秘密鍵はサーバー側でのみ保持
   - アクセス権を持つ者は認証を偽装できるため、厳重な管理が必要

2. **ハッシュ関数の選択**
   - HMACの暗号強度は基礎となるハッシュ関数の特性に依存
   - 出力サイズとキーのサイズ・品質が重要

3. **公開鍵基盤との比較**
   - HMACは共有秘密鍵を使用するため、PKIやデジタル署名より複雑さが低い
   - ただし、事前に信頼されたチャネルでキー交換が必要

## まとめ

HMACは、ハッシュ関数と秘密鍵を組み合わせたメッセージ認証方式であり、データの完全性と認証を同時に提供する。IPsec、TLS、SSH、JWTなど多くのセキュリティプロトコルで採用されており、現代のセキュアな通信において不可欠な技術である。実装時はSHA-256以上のハッシュ関数を使用し、秘密鍵の適切な管理を行うことが重要である。
