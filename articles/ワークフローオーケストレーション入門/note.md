---
title: "ワークフローオーケストレーション入門"
source: "https://speakerdeck.com/nsakki55/wakuhurookesutoresiyonru-men"
author:
  - "長江 五月 (Satsuki Nagae)"
published: 2024-03-05
created: 2025-05-24
description: "Data Engineering Study #23 Data orchestration 特集での発表資料。ワークフローオーケストレーションの基本概念から6つの主要ツール（Airflow、Digdag、Argo、Prefect、Dagster、Step Functions）の比較、ML基盤への導入事例まで包括的に解説。"
tags:
  - "ワークフローオーケストレーション"
  - "データエンジニアリング"
  - "Airflow"
  - "Prefect"
  - "Dagster"
  - "MLOps"
  - "データパイプライン"
---

# ワークフローオーケストレーション入門

> 発表者: 長江 五月 (CyberAgent AI事業本部 Dynalyst データサイエンティスト マネージャー)
>
> 発表日: 2024年3月5日
>
> イベント: Data Engineering Study #23 Data orchestration 特集

## 概要

本発表は、ワークフローオーケストレーションの基本概念から実践的な導入事例まで包括的に解説する資料です。6つの主要ワークフローツールを比較し、実際のML基盤でのDigdagからPrefectへの移行事例を紹介しています。

### 対象者

- ワークフローオーケストレーションツールの導入を検討している人
- 既存のワークフローツールに課題を感じている人

## 1. ワークフローオーケストレーションとは

### 基本概念

**ワークフローオーケストレーション**: ワークフロー実行のためのインフラ・システム・トリガーなどの調整を行うこと

- **ワークフロー**: 2つ以上のステップを含む一連の流れ（Slack通知・ETL処理・ML学習など）
- **オーケストレーション**: 複数システム、アプリケーション、サービスを管理・調整すること

### 類似語と関連概念

- データオーケストレーション / 機械学習オーケストレーション
- ワークフローエンジン / パイプラインオーケストレーション
- データパイプライン / 機械学習パイプライン

**検索トレンド**: ワークフローエンジンが最も一般的な呼び名で、ワークフロー・データオーケストレーションの検索数が増加傾向

## 2. ワークフローオーケストレーションツールの歴史

### 時代別の変遷

#### CRON時代（1970年〜）

- 1974年: UNIXにCRON導入
- 指定時刻にコマンドを実行する基本的な仕組み

#### リレーショナルデータベース時代（1980年〜）

- 1979年: Oracle v2リリース
- 1995年: Oracleがジョブキュー（DBMS_JOB）を導入

#### データウェアハウス・データ統合時代（1990年〜）

- 1998年: Informatica PowerCenterリリース
- ETL（Extract, Transform, Load）プロセスの概念が確立
- データ処理のソースとターゲットを繋ぐワークフローの概念を初導入

#### ビッグデータ時代（2000年〜）

- 2006年: GoogleがHadoopをOSS化
- 2011年: データレイクの提唱・流行
- ELT（Extract, Load, Transform）アプローチが主流に

**ワークフローツール第1世代の登場**:

- 2010年: Yahoo Oozie
- 2012年: Spotify Luigi  
- 2014年: LinkedIn Azkaban
- 2015年: Airbnb Airflow

#### モダンデータスタック時代（2010年〜現在）

- 2011年: BigQuery(GCP)がGA
- 2013年: Redshift(AWS)がGA
- 2014年: Databricks設立、SnowflakeがGA
- オンプレから安価で高速なクラウドへの移行

**ワークフローツール第2世代の登場**:

- 2016年: DigdagがOSS化
- 2017年: StepFunctions(AWS)がGA
- 2018年: Prefectリリース、ArgoがOSS化
- 2019年: Dagsterリリース、Cloud Composer(GCP)がGA

### 現代の役割

新たなデータスタックが登場したが世代交代は行われず、様々な技術を組み合わせたデータ基盤が作られている現状で、ワークフローオーケストレーションツールは様々なデータスタックと連携し、統一的な実行制御を行う中心的役割を担っている。

## 3. ワークフローオーケストレーションツールの機能と恩恵

### 主要機能

1. **実行制御**: タスクの実行順序制御やリトライなどを保証
2. **監視**: ワークフローの実行状態やログを追跡
3. **スケーラビリティ**: 並列処理や柔軟な計算リソース拡張
4. **外部ツール連携**: データベースやETLツールとの容易な連携

### 導入による改善効果

#### データパイプライン

- **エラー対応**: 手動リトライ → 自動リトライ
- **実行順序制御**: 自前実装 → タスク定義のみ
- **実行ログ確認**: 複数箇所 → 一箇所に集約
- **データサイロ化**: チームごと管理 → チーム横断で管理

#### 機械学習パイプライン

- **パイプライン管理**: Jupyter notebook → スクリプト化
- **運用者**: 個人 → チーム
- **複数モデル管理**: 困難 → 比較的容易

## 4. DAGとワークフローの関係

### DAG（Directed Acyclic Graph）の特徴

- **Directed**: タスク依存関係は一方向のみ
- **Acyclic**: タスクが正常実行されると再実行されない
- **Graph**: ワークフローをタスク（ノード）と依存関係（エッジ）で表現

### DAGのメリット

- 実行順序を事前に決定可能
- 最後のタスクが成功 = ワークフローの成功

### DAG普及の経緯

初期のワークフローツールはHadoopジョブをマークアップ言語（YAML・XML）で記述していたが、ループ・相互依存を表現できない制約から、全てのワークフローをDAGとして表現するアプローチが確立された。

## 5. 6つのワークフローツール比較

### 比較対象ツール

1. **Digdag** (OSS)
2. **Argo** (OSS)
3. **Airflow** (OSS/SaaS)
4. **Prefect** (SaaS)
5. **Dagster** (OSS/SaaS)
6. **AWS Step Functions** (クラウドマネージド)

### 特徴比較一覧

| ツール | 特徴 | 実装言語 | 利用形態 | 学習コスト |
|-------|------|----------|----------|------------|
| Digdag | シンプル・手軽 | digファイル(YAML) | OSS | 低 |
| Argo | k8sと連携 | k8s manifest(YAML) | OSS | 中 |
| Airflow | Python DAG・活用事例豊富 | Python(Operator) | OSS/SaaS | 高 |
| Prefect | 自然なPython記法 | Python(Flow) | SaaS/OSS | 高 |
| Dagster | データ運用に特化 | Python(Job) | OSS/SaaS | 高 |
| Step Functions | サーバレス・AWSサービス | JSON/GUI操作 | クラウドマネージド | 低 |

### 各ツール詳細

#### Airflow

- **概要**: ワークフローをDAGとしてプログラムで作成・スケジュール・監視するプラットフォーム
- **構成**: DAG → Operator → Task
- **マネージドサービス**: Astronomer、Amazon MWAA、Cloud Composer、Azure Data Factory
- **GitHub Stars**: 33,635★

#### Digdag  

- **概要**: 複雑なタスクパイプラインの構築・実行・スケジュール・監視に役立つシンプルなツール
- **特徴**: YAML記法 + Dig独自記法
- **YAMLの欠点補填**: 外部ファイルinclude、変数埋め込み、プログラム記述が可能
- **GitHub Stars**: 1,277★

#### Argo

- **概要**: Kubernetes上で並列ジョブを調整するオープンソースのコンテナネイティブワークフローエンジン
- **構成**: Template、Workflow、6種類のTemplate（Container、Script、Resource、Suspend、Steps、Dags）
- **GitHub Stars**: 14,049★

#### Prefect

- **概要**: ワークフローの構築、観測、優先順位付けを行うオーケストレーション・オブザーバビリティプラットフォーム
- **特徴**: Pythonコードをインタラクティブなワークフローに変換する最も簡単な方法
- **アーキテクチャ**: Hybrid Model（PrefectがUI・制御、ユーザーがコード・実行環境を管理）
- **GitHub Stars**: 14,112★

#### Dagster

- **概要**: データリネージ統合・可観測性・宣言的プログラミング・テスト機能を持つクラウドネイティブなデータパイプラインオーケストレータ
- **特徴**: Software-Defined Assets（データに関するオブジェクトの作成・更新方法をコードで表現）
- **GitHub Stars**: 9,703★

#### AWS Step Functions

- **概要**: AWS Lambda関数と他のAWSサービスを組み合わせてビジネスクリティカルなアプリケーションを構築できるサーバーレスオーケストレーションサービス
- **特徴**: JSON形式のAmazonステートメント言語、GUI操作でワークフロー作成可能

## 6. ワークフローツール選定指針

### 選定の基本考え方

**重要な判断基準**: 「使いやすい製品かどうか」

- **使いやすさの定義**: 技術・人・カネの制約の中でプロダクト課題を解決できる最も扱いやすいもの

### 導入パターンの検討

**データ基盤「専用」 vs 既存システムへの「相乗り」**

#### 相乗りする場合のメリット・デメリット

**メリット**:

- データ・MLエンジニアが実行環境を運用しなくてよい
- 事業システムとデータ基盤の処理を1つのワークフローで制御可能

**デメリット**:

- データ基盤のワークフローを気楽に変更できない
- 事業システム側のツールがレガシーで使いにくい場合がある

### 推奨ツール（用途別）

- **Digdag**: シンプルなバッチ実行で十分、お金をかけたくない場合
- **Argo**: 既存システムをKubernetesで構築している場合  
- **Step Functions**: AWSを利用していて小規模なワークフロー実行で十分な場合
- **Airflow/Prefect/Dagster**: 本格的なデータパイプライン・ML基盤を構築する場合

### コミュニティでの評価

**Redditでの議論結果**（好意的コメント数）:

- Dagster: 11
- Prefect: 5  
- Airflow: 1

AirflowからDagster・Prefect・他ツールに移行した人が多い傾向

### 個人的評価

- **Airflow**: 最も有名でノウハウが多いが、ハマりどころも多い
- **Prefect**: 拡張性が高くPythonに慣れている人には使いやすい  
- **Dagster**: データエンジニアに寄り添った仕様で、公式ドキュメント・実装例が整備されている

**結論**: 実際に使ってみて、チームが使いやすいツールを選ぶことが最も重要

## 7. ML基盤へのワークフローツール導入事例

### 背景

**既存のMLワークフロー**:

- N個のモデルの学習が毎日M回実行
- ECS Taskでタスク実行
- Digdagで制御

### 移行の理由

#### 運用課題

1. **巨大YAMLの認知負荷増加**
2. **ログ確認の煩雑さ**: タスクごとのログをCloudWatchで個別確認
3. **データ受け渡しの困難さ**: タスク間のデータ共有が複雑
4. **柔軟な条件分岐の必要性**
5. **ワークフローテストの必要性**

#### 管理の統一化

- ML以外のバッチ処理がdigdagで運用
- 管理するワークフローツールを1つにしたい要望

### Prefect選択の理由

#### 選定要件

1. **既存システムとの相性**: タスクをECS Taskで実行可能
2. **リアルタイムログ監視**: Web UIからログ追跡可能
3. **開発しやすさ**: Pythonで実装可能
4. **柔軟性**: if elseを使った条件分岐が可能
5. **低コスト**: ※Prefect 2.0から値上がりが課題

### 移行後の構成

#### 基本方針

- **変更要素**: ワークフローツールのみ
- **維持要素**: 既存のアプリケーションコード

#### 運用上の工夫

**パラメータ活用**:

- 実行時パラメータに計算リソース・学習設定を設定
- 特定モデルのみ学習、メモリの一時的増加など動的変更が可能

## まとめ

### 主要ポイント

1. **ワークフローオーケストレーション**: ワークフロー実行のためのインフラ・システム・トリガーの調整

2. **ツールのトレンド**: Airflow以降、モダンデータスタックと呼ばれるワークフローツールが次々登場

3. **選択指針**: 実際に使ってみて、チームにとって最も使いやすいツールを選ぶ

4. **実践事例**: ML基盤のワークフローをDigdagからPrefectに移行し、運用課題を解決

### 今後の展望

ワークフローオーケストレーションツールは、現代のデータ基盤において中心的な役割を担い、様々なデータスタックを統合する重要なコンポーネントとして位置づけられています。適切なツール選択により、チームの生産性向上とデータパイプラインの安定運用が実現できます。

---

## 参考文献

- A Brief History of Workflow Orchestration
- An Introduction to Workflow Orchestration  
- awesome-workflow-engines
- Data Orchestration: Definition, Parts, Examples, and Benefits
- データエンジニアが最初に学ぶべき3つのポイント：「ETL」「データモデリング」「ワークフロー」
- データパイプラインのためのワークフロー管理
- Argo vs Airflow vs Prefect: How Are They Different
- DigdagはなぜYAMLなのか？
- 実践的データ基盤への処方箋〜ビジネス価値創出のためのデータ・システム・ヒトのノウハウ
- Orchestration: Thoughts on Dagster, Airflow and Prefect?
