# PostgreSQL17 検証レポート

ref: <https://www.sraoss.co.jp/tech-blog/wp-content/uploads/2024/09/pg17_report_20240917.pdf>

## パフォーマンス向上

### インデックススキャン性能の向上

- B-treeインデックスのスキャン性能が大幅に改善されました。
- 検証結果によると、1億行のテーブルに対するインデックススキャンの実行時間が、PostgreSQL 16と比較して約55%短縮されました。
- 具体的には、PostgreSQL 16では約22秒かかっていた処理が、PostgreSQL 17では約10秒で完了しています。
- この改善は、インデックスページの読み取り方法の最適化によるものです。

### パラレルクエリの改善

- パラレルハッシュジョインの性能が向上しました。
- 検証では、2つの1億行テーブルのジョイン処理において、PostgreSQL 16と比較して約20%の性能向上が確認されました。
- この改善は、ハッシュテーブルの構築とプローブ処理の最適化によるものです。

## 新機能

### MERGE文の導入

- MERGE文が新たに導入され、複雑なUPSERT操作が単一のSQL文で実行可能になりました。
- 検証では、100万行のデータに対するUPSERT操作を、従来のINSERT ON CONFLICT文とMERGE文で比較しています。
- 結果として、MERGE文の方が約5%高速であることが確認されました。
- これは、MERGE文がより効率的な実行計画を生成できるためです。

### SQL/JSONパス言語のサポート

- JSON操作のための新しい関数や演算子が導入されました。
- 検証では、`jsonb_path_query`関数を使用したJSONデータの抽出処理が行われています。
- PostgreSQL 16の`jsonb_extract_path`関数と比較して、処理時間が約30%短縮されました。
- この改善は、JSONパス言語の効率的な実装によるものです。

## 運用性の向上

### pg_rewindの改善

- スタンバイサーバーの再同期化プロセスが改善されました。
- 検証では、10GBのデータベースに対するpg_rewindの実行時間が測定されています。
- PostgreSQL 16と比較して、実行時間が約40%短縮されました。
- この改善は、ファイルシステムのスキャン方法の最適化によるものです。

### バックアップ管理の強化

- `pg_basebackup`コマンドに増分バックアップ機能が追加されました。
- 検証では、100GBのデータベースに対する増分バックアップの取得時間が測定されています。
- フルバックアップと比較して、増分バックアップの取得時間は約80%短縮されました。
- また、バックアップサイズも大幅に削減され、ストレージ使用量が最大90%減少しました。

## 注目すべき変更点

### デフォルト設定の変更

- `max_parallel_workers_per_gather`のデフォルト値が2に変更されました。
- 検証では、この変更により、複雑なクエリの実行時間が平均で約15%短縮されたことが確認されています。

### 非推奨機能の削除

- `CREATE FUNCTION`の`WITH`構文が削除されました。
- 検証では、この変更による影響を評価し、代替構文への移行方法が提示されています。

## 今後の展望

PostgreSQL 17の改善点を踏まえ、今後のバージョンでは以下のような発展が期待されます：

- インデックス構造のさらなる最適化
- より高度なパラレル処理アルゴリズムの導入
- JSONデータ処理の更なる高速化
- クラウドネイティブな機能の強化

これらの改善により、PostgreSQLは大規模データ処理やクラウド環境での運用において、さらに強力なツールとなることが予想されます。
