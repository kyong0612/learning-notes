# NEWT（ニュート）における Firebase Dynamic Links から AppsFlyer OneLink への移行

ref: <https://zenn.dev/reiwatravel/articles/9226207e0f4eb5>

## 背景と目的

- Firebase Dynamic Links（FDL）が2025年8月25日以降に停止される
- 「NEWT（ニュート）」アプリでは多くの箇所でFDLを利用していた
- アプリエンジニアとWebエンジニアによる移行プロジェクトを発足

## FDLの利用状況調査

- 利用箇所は主に2種類に分類
  1. NEWTシステムのソースコード内で管理されている箇所
     - Webのアプリ導線
     - システムメール内のリンク
     - アプリ内から招待リンクの発行など
  2. ソースコード内では管理されない箇所
     - セールのランディングページ
     - マガジン記事
     - メルマガなど
- Firebase Console上で確認できるだけで約1,400のリンクが存在
- 手動で作成したパラメータを組み合わせたリンクも無数に存在
- すべての利用箇所を洗い出すことは実質不可能だった

## 代替サービスの検討

### 機能要件の洗い出し

**必須**

- アプリの特定の画面へのディープリンク
- アプリストアへのリダイレクト
- パラメータを組み合わせた静的なリンク（Long Link）の生成

**なるべく必要**

- ディファードディープリンク
- 独自ドメインの付与
- アプリから動的にShort Link生成
- リンクにOGPの指定

**なくてもOK**

- リンクの分析（Google Analyticsのイベントで計測する運用）

### 候補サービス

- Adjust
- AppsFlyer
- Bitly
- Branch
- Kochava

### 選定結果

- **AppsFlyer OneLink**を採用
- 理由：
  - クロスプラットフォームなリンクとしての利用であれば無償範囲内で利用可能
  - 機能的に十分で、コスト面で優位

## アプリのOneLink対応

### 実装内容

- AppsFlyer SDKの導入
- OneLinkからアプリ起動時のディープリンク対応
- アプリからの招待用リンクをOneLinkに置き換え
- カスタムドメインの設定

### 慎重な移行ステップ

1. アプリでOneLinkをサポートしつつ、FDLのサポートも並行維持
2. アプリリリース後、強制アップデートによりOneLink対応アプリの浸透を促進
3. 一部リンクをOneLinkで作成・運用し、問題ないことを確認
4. FDLからOneLinkへの置き換え実施

## FDLからOneLinkへの移行

### OneLink運用開始の準備

- 社内での新規FDLリンク発行を停止
- OneLinkの運用マニュアルを整備・展開
  - 非エンジニアメンバーも利用できるよう説明
  - リンク作成に必要なパラメータの詳細説明
  - 運用フローの明確化

### 既存リンクの置き換え手法

- **リダイレクトプロキシを構築**
  - FDLのリンクURLにアクセスした際、OneLinkのURLに自動リダイレクト
  - FDLのパラメータからOneLinkのパラメータに変換
  - FDLで使用していたカスタムドメインをプロキシに付け替え

### 実装上の工夫

- FDLで設定されていた各リンクのメタデータをエクスポート
- OneLinkのパラメータマッピングを実施
- 発生した2つの問題への対応：
  1. デスクトップでのリダイレクト先指定問題
     - OneLinkでは`af_web_dp`パラメータを明示的に指定する必要があった
  2. 不要なパラメータ引き継ぎ問題
     - `af_param_forwarding`を`false`に設定して解決

## まとめ

- 既存FDLの運用状況把握から始め、段階的に移行を進めた
- リダイレクトプロキシの構築で既存リンクの置換を実現
- 記事執筆時点ではプロキシの運用はまだ開始されておらず、運用後に記事アップデート予定
