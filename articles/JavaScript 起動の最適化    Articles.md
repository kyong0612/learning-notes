---
title: "JavaScript 起動の最適化  |  Articles"
source: "https://web.dev/articles/optimizing-content-efficiency-javascript-startup-optimization?hl=ja"
author:
  - "Addy Osmani"
published: 2017-11-30
created: 2025-10-21
description: "ネットワーク転送と JavaScript の解析やコンパイルにかかるコストを低く抑えて、ページがすばやくインタラクティブになるようにします。モバイルデバイスでのJS処理コスト、最適化手法、パフォーマンスバジェットの重要性について解説。"
tags:
  - "JavaScript"
  - "パフォーマンス"
  - "最適化"
  - "web-performance"
  - "モバイル"
  - "コード分割"
  - "PRPL"
---

## 概要

JavaScript依存サイトを構築する際、配信したコンテンツに対して見えないコストが発生する。モバイルデバイスでサイトを高速かつインタラクティブにするには、配信するJavaScriptを減らすことが重要。これにより、ネットワーク転送時間、コードの解凍時間、JavaScript の解析とコンパイル時間が短縮される。

## ネットワークコスト

### 主な課題

- JavaScriptのバイト数が多いほど、特に遅い接続では時間がかかる
- ユーザーの実際のネットワーク接続タイプは見かけと異なる場合がある（Wi-Fi接続でも実際は2G速度など）

### 削減手法

**必要なコードのみを送信**

- **コード分割**: JavaScriptを重要なものとそうでないものに分割
- **遅延読み込み**: クリティカルでないコードの遅延読み込み

**圧縮（Minification）**

- ES5コード: UglifyJS を使用
- ES2015以降: babel-minify または uglify-es を使用

**圧縮（Compression）**

- 最低限、gzipでテキストベースリソースを圧縮
- **Brotli ~q11の使用を推奨**:
  - gzipより優れた圧縮率
  - CertSimpleでは圧縮JSバイトサイズが17%削減
  - LinkedInでは読み込み時間が4%削減

**未使用コードの削除**

- DevToolsコードカバレッジで削除・遅延読み込みの機会を特定
- babel-preset-envとbrowserlistで不要なトランスパイルを回避
- Tree-shaking、Closure Compiler、ライブラリトリミングプラグインを活用

**キャッシュの活用**

- **HTTPキャッシュ**: 最適な存続期間（max-age）とETags
- **Service Workerキャッシュ**: ネットワーク復元力の向上、V8コードキャッシュへのアクセス
- **長期保存キャッシュ**: 変更されていないリソースの再取得を回避
- Webpackのファイル名ハッシュ化を使用

## 解析/コンパイルコスト

### 重要な洞察

- ダウンロード後、**最も負荷の高いコスト**の1つがJS解析/コンパイル時間
- Chrome DevToolsのパフォーマンスパネルで「スクリプト処理」時間として表示（黄色）
- V8のランタイム呼び出し統計情報で正確な時間を確認可能

### なぜ重要か

- **同等サイズの画像やWebフォントより処理コストが高い**
- 平均的なモバイルハードウェアでは、JSの方がページのインタラクティビティに悪影響
- 画像はデコード/ラスタライズ中にメインスレッドをブロックしないが、JSは解析・コンパイル・実行コストでインタラクティビティを遅延させる

### パフォーマンスデータ

**デバイス間の性能差**

- **最速スマートフォンと平均的スマートフォンでは、コードの解析/コンパイル時間が2〜5倍の差**
- 1MBの圧縮解除JavaScript（gzip圧縮で約250KB）の解析時間:
  - ハイエンドiPhone 8: 約4秒
  - 平均的スマートフォン（Moto G4）: 約13秒

**実例: CNN.com**

- iPhone 8でのJS解析/コンパイル: 約4秒
- Moto G4での解析/コンパイル: 約13秒
- ユーザーがサイトを完全に操作できるまでの時間に大きな影響

### 重要な考慮事項

- ネットワーク機能とデバイス機能は必ずしも一致しない
- 優れたFiber接続でもCPUが遅いデバイスの可能性
- **平均的なハードウェアでテスト**: ポケットの高性能スマートフォンだけでなく
- **ユーザーのデバイスとネットワーク状況に合わせて最適化**

### 業界の現状

HTTP Archive（上位50万サイト）の分析結果:

- 50%のサイトでインタラクティブになるまで14秒以上
- JavaScriptの解析とコンパイルに最大4秒

**重要な結論**: ページから重要でないJavaScriptを削除すると、転送時間、CPU使用率の高い解析とコンパイル、潜在的なメモリオーバーヘッドを削減でき、ページのインタラクティブ性をより早く実現できる。

## 実行時間

### 主要ポイント

- **JavaScript実行**はメインスレッドで実行する必要がある
- 実行時間が長いとユーザーがサイトを操作できるまでの時間が長くなる
- **スクリプトの実行時間が50ms超過**: JS のダウンロード、コンパイル、実行の合計時間だけインタラクティブになるまでの時間が遅延

### 対処法

- JavaScriptを**小さなチャンク**で実行し、メインスレッドのロックを回避
- 実行中に処理される作業量の削減を検討

## その他のコスト

### メモリ関連

**ガベージコレクション（GC）**

- ページが頻繁にジャンクしたり一時停止する原因
- ブラウザがメモリを再利用する際、JS実行が一時停止
- 頻繁なGCでは望ましくない頻度で実行が一時停止
- **対策**: メモリリークや頻繁なGC停止を回避

### 応答性の問題

**長時間実行されるJavaScript**

- メインスレッドをブロック
- ページが応答しなくなる可能性

**解決策**

- 処理を小さな部分に分割
- `requestAnimationFrame()` または `requestIdleCallback()` をスケジュールに使用
- Interaction to Next Paint（INP）の改善

## JavaScript配信コストを削減するパターン

### PRPL パターン

**PRPL = Push、Render、Pre-cache、Lazy-load**

積極的なコード分割とキャッシュ保存によってインタラクティビティを最適化するパターン。

**効果**

- 解析時間の短縮
- 非常に迅速にインタラクティブな状態を実現
- 実例: Wegoなど

### プログレッシブブートストラップ

**従来のアプローチの問題点**

多くのサイトはインタラクティビティを犠牲にしてコンテンツの視認性を最適化:

1. サーバーサイドレンダリングでファーストペイントを高速化
2. JavaScript取得後にイベントハンドラをアタッチ

**コスト**

1. インタラクティビティを押し上げるより大きなHTMLレスポンス
2. JavaScriptの処理が完了するまでエクスペリエンスが実際にインタラクティブにならない「不気味の谷」

**より良い方法: プログレッシブブートストラップ**

- 最小限の機能を持つページを送信（現在のルートに必要なHTML/JS/CSSのみ）
- リソースが追加されると、アプリはレイジーロードで機能を拡張
- **理想**: 表示内容に応じてコードを読み込む

## まとめ

### 重要原則

**低価格帯のネットワークでは、転送サイズが重要**
**CPU負荷の高いデバイスでは、解析時間が重要**
→ **これらの数値を低く抑えることが極めて重要**

### 成功のための戦略

**パフォーマンスバジェットの採用**

- JavaScriptの送信と解析/コンパイル時間を短くするための厳格な制限
- アーキテクチャの決定がアプリロジックに残せるJSの「ヘッドルーム」を検討

**開発のベストプラクティス**

1. **代表的なハードウェアで開発**
2. **JavaScript解析/コンパイル時間を短く抑える**
3. **パフォーマンス予算を導入**
4. **チームがJavaScriptのコストを常に把握**

### 参考リソース

- Chrome Dev Summit 2017 - 最新の読み込みに関するベストプラクティス
- JavaScript の起動パフォーマンス
- ウェブパフォーマンスの危機を解決する（Nolan Lawson）
- 費用は支払えますか？実際のパフォーマンスバジェット（Alex Russell）
- ウェブフレームワークとライブラリの評価（Kristofer Baxter）
- Cloudflare の Brotli テストの結果
- パフォーマンスフューチャーズ（Sam Saccone）

## キーポイント

1. **JavaScriptはバイト単位で画像やフォントより処理コストが高い**
2. **デバイス性能差は2〜5倍**: 最適化の重要性
3. **50%のサイトでインタラクティブまで14秒以上**: 改善の余地は大きい
4. **コード分割、遅延読み込み、キャッシュ戦略が効果的**
5. **PRPL とプログレッシブブートストラップ**: 推奨パターン
6. **パフォーマンスバジェット**: 継続的な品質維持に不可欠
