# Cloud Run でカスタムドメインを使うとレイテンシーが高くなる原因と解決

ref: <https://mixi-developers.mixi.co.jp/cloudrun-custom-domain-latency-20a127d40448>

- Cloud Run上のカスタムドメインを使用すると、デフォルトドメインを使用する場合と比べて、HTTPアクセス時間が2倍以上に増加するなど、レイテンシーが大幅に増加する可能性がある。
- このレイテンシーの問題は、Cloud Runの処理能力ではなく、ネットワークパスの問題が原因とされている。
- トレースルートテストの結果、カスタムドメインの通信フローには、Google Front End (GFE)やghs.googlehosted.comドメインを含む複数のホップが含まれることが明らかになった。
- ghs.googlehosted.comは、Googleホストサービスにカスタムドメインを割り当てる際に使用されるドメインで、CNAMEレコードとして登録する必要がある。
- カスタムドメインを使用する場合、通信パスは「クライアント → ISP → GFE → ghs.googlehosted.com → Cloud Run」となる。
- ghs.googlehosted.comに関連付けられているIPアドレスは米国に所在していることから、日本のユーザーにとってレイテンシーが増加する要因となっている。
- この文書では、データが日本国内にとどまるのではなく米国に移動することで、レイテンシーが悪化する可能性が指摘されている。
- これらの知見は、ネットワークパスとアプリケーションパフォーマンスの関係を理解する重要性を示している。
- Apache Benchを使用してレイテンシーを測定し、これらの調査結果を裏付けるデータが得られた。
- この文書は、Cloud Runでカスタムドメインを使用する開発者に対し、パフォーマンストレードオフの可能性について警告を発するものである。
