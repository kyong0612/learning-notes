---
title: "Claude CodeのDeny+Bashはあくまで緩和である"
source: "https://zenn.dev/watany/articles/df6f3b0d3af825"
author:
  - "watany"
published: 2025-07-03
created: 2025-07-05
description: |
  Claude Codeの`deny`設定が、コマンドのオプションや順序を変更するとバイパスされる可能性があることを検証した記事。完全一致ではないため、セキュリティ対策としては緩和策に過ぎないと結論付けています。
tags:
  - "Claude Code"
  - "Bash"
  - "security"
  - "LLM"
---

この記事は、Claude Codeの`deny`機能がシェルの危険なコマンド実行をどの程度防げるかを検証したものです。

## 検証の概要

Claude Codeの設定ファイル (`.claude/settings.local.json`) で特定のコマンドを禁止（deny）した場合の挙動を調査しています。

- **検証バージョン**: `claude 1.0.41 (Claude Code)`
- **設定**:
  - `Bash(rm -rf:*)` を`deny`リストに追加。
  - `Bash(touch:*)` と `Bash(rm:*)` は`allow`リストに含まれている。

```json
{
  "permissions": {
    "allow": [
      "Bash(touch:*)",
      "Bash(rm:*)"
    ],
    "deny": [
      "Bash(rm -rf:*)"
    ]
  }
}
```

## 検証結果

### 検証1: `rm -rf` はブロックされる

`deny`リストに完全一致する `rm -rf` コマンドは、何度試行しても権限エラーとなり、正しくブロックされました。

### 検証2: `rm -fr` は確率的に成功する

オプションの順序を変えた `rm -fr` は、数回の試行のうちに **確率的に成功してしまう** ことが確認されました。これは、`deny`のルールが完全一致でのみ機能しているわけではないものの、論理的な解釈が不完全である可能性を示唆しています。

### 検証3: オプションの表記を変えるとバイパスされる

`rm -rf` と等価な `rm --force --recursive` のように、長いオプション名を使用すると、コマンドの実行が **成功してしまう** ケースがありました。

## まとめと考察

Claude Codeの`deny`機能は、コマンドのオプションの順序や表記を変更するだけでバイパスされる可能性があり、厳格なセキュリティ制御としては不十分であることが示唆されました。

筆者は、この挙動から、バリデーションがLLMによって行われているものの、コマンドの意味的な解釈までは行われていないと推測しています。

### 提言

安全な運用のためには、以下の対策が推奨されます。

1. **Allowリストを厳格に管理する**: 許可するコマンドを最小限に絞る。
2. **実行環境を分離する**: コンテナなど、影響範囲が限定された環境でClaude Codeを実行する。

また、`allow`/`deny`リストが長くなると、LLMのコンテキストサイズに影響を与える可能性についても懸念が示されています。
