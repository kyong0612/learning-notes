---
title: "はじめてのDSPy - 言語モデルを『プロンプト』ではなく『プログラミング』するための仕組み"
source: "https://speakerdeck.com/masahiro_nishimi/hazimetenodspy-yan-yu-moderuwo-puronputo-dehanaku-puroguramingu-surutamenoshi-zu-mi"
author:
  - "[[Masahiro Nishimi]]"
published: 2024-10-16
created: 2025-10-28
description: |
  スタンフォード発のDSPyフレームワークを紹介するプレゼンテーション。プロンプトを手書きで最適化する従来のアプローチから脱却し、データと評価関数を用いてプロンプトを自動生成・最適化する新しいパラダイムを解説。AIエージェント開発における主要な課題とDSPyによる解決策を、実践的なコード例とともに説明する。
tags:
  - DSPy
  - プロンプトエンジニアリング
  - LLM
  - AIエージェント
  - 機械学習
  - プロンプト最適化
  - LangChain
---

## 概要

株式会社ジェネラティブエージェンツの西見公宏氏によるDSPy入門プレゼンテーション。従来のプロンプトエンジニアリングが抱える課題を指摘し、DSPyによる宣言的なアプローチでプロンプトを「重み」として扱う新しいパラダイムを提案する。

## 発表者・組織情報

**株式会社ジェネラティブエージェンツ**

- 設立: 2024年3月14日
- 役員: CEO 西見公宏、COO 吉田真吾、CTO 大嶋勇樹
- 事業内容: AIエージェント技術を軸とした生成AIアプリケーション開発支援、コンサルティング、教育・研修サービス
- ビジョン: AIエージェントが「ハブ」となり人間とAIエージェントの協働が当たり前になる世界を実現する

**西見公宏氏の主な著書**

- 『現場で活用するためのAIエージェント実践入門』（2024年7月発売）
- Software Design誌にて「実践LLMアプリケーション開発」を2023年10月から連載中（第25回からDSPy特集）

## 1. AIエージェント開発フレームワークの現状

### ワークフローとAIエージェントの違い

**ワークフロー**

- ユーザーが個々の処理をフローとして手動で繋ぎ合わせる
- 決められた通りに動作するため安定性が高い
- ワークフローは増え続け、保守に注意が必要

**AIエージェント**

- AIエージェントがユーザーの要求に応じてオンデマンドでワークフローを生成
- 必ず要求を達成するフローが生成されるとは限らない
- 新しいマネジメント手法が必要

### エージェンティックワークフローの構成要素

1. **AIモデルによる評価**: LLM-as-a-Judgeなどを用いた自律的実行
2. **AIモデルを利用した柔軟な分岐**: 分類タスクによる動的なルート選択
3. **ヒューマン・イン・ザ・ループ**: 人間による介入と代行

### 主要なAIエージェント開発フレームワーク比較

| フレームワーク | LangGraph/LangChain | Strands Agent | Mastra |
|--------------|---------------------|---------------|--------|
| 開発元 | LangChain | AWS | Mastra（元Gatsbyチーム） |
| 初回リリース | 2022年11月/2024年 | 2025年5月（プレビュー） | 2024年10月 |
| ライセンス | MIT | Apache 2.0 | Apache 2.0 |
| 言語 | Python、TypeScript | Python | TypeScript |
| 設計思想 | ワークフローベース/明示的な制御フロー | モデル駆動アプローチ | フルスタック開発者向け |
| 制御方法 | 開発者が明示的にノードとエッジを定義 | モデルが自律的にツール選択 | ハイブリッド |

### 共通する開発パターン

どのフレームワークにも共通する3つのステップ：

**①ツール定義**

```python
def weather_api(city: str) -> dict:
    """指定された都市の天気情報を取得"""
    return get_weather(city)

def search_database(query: str) -> list:
    """データベースから関連情報を検索"""
    return db.search(query)
```

- 外部API呼び出し、データ処理、ファイル操作など、LLM単体では実現できない処理を提供
- 最近のトレンドではMCP（Model Context Protocol）を用いて提供するケースが多い

**②プロンプト設計**

```python
system_prompt = """
あなたは親切な旅行アシスタントです。
ユーザーの質問に対して、利用可能なツールを使って
正確で役立つ情報を提供してください。
必ず天気情報を確認してから提案を行ってください。
"""
```

- システムプロンプト（ペルソナ、役割、制約）
- タスク固有の指示（何をすべきか、どのように振る舞うべきか）
- Few-shotサンプル（望ましい挙動の例示）
- **課題**: ツールの利用方策などあらゆる情報を記述するため、非常に長くなる傾向

**③ワークフロー構築**

- LangGraph: ワークフローベース
- Strands: エージェント + ツール（モデルが使用ツールを判断）
- Mastra: ワークフロー + エージェントのハイブリッド

## 2. プロンプトエンジニアリングが持つ課題

### 課題1: モデルによって性能の出るプロンプティングが異なる

**論文事例**: "Tuning LLM-based Code Optimization via Meta-Prompting: An Industrial Perspective"（2025年8月）

- Llama.cppのパフォーマンス最適化実験
- **結果**: 各モデルに特化したプロンプトを用いた方がパフォーマンスが向上
- **示唆**: 汎用的なプロンプトでは最適な性能を引き出せない

### 課題2: 評価の仕組みは銀の弾丸ではない

- データセットからプロンプトを評価 → アップデートのイテレーションを組んでも、アップデート自体は人間が行う必要がある
- プロンプトの数が増えるほど、メンテナンス対象が増加
- **問題**: プロンプトのどの部分が評価に影響するのかは明らかでない

### 課題3: モデルの進化とRetirement

**OpenAIの例**:

- gpt-4（2023年7月提供開始）→ 2025年11月停止
- gpt-4(32k)（2023年7月）→ 2025年6月停止
- gpt-4.5 Preview（2025年2月）→ 2025年7月停止

**Anthropicの例**:

- claude 1系（2023年3月）→ 2024年11月停止
- claude 2系（2023年7月）→ 2025年7月停止
- claude 3 sonnet（2023年11月）→ 2025年7月停止

**問題点**:

- 数ヶ月単位でアップデート＆より高性能・低価格になる
- モデルバージョンの固定化が現実的ではない
- 性能維持ないし向上の工数が大きな課題

### まとめ: プロンプトエンジニアリングの限界

1. AIエージェント開発フレームワークの基本構造は同じだが、パフォーマンスを左右する大きな要素が「プロンプト」
2. プロンプトのパフォーマンスを左右する要素が多く、メンテナンスが困難
3. モデルの変化にプロンプトは敏感に反応するため、継続的な最適化が必要

## 3. DSPyによる課題解決アプローチ

### DSPyの基本思想

> **プロンプトを手書きするのではなく、データと評価関数によって自動生成する**

### DSPyの歴史

**起源（2023年以前）: DSP（Demonstrate-Search-Predict）**

- スタンフォードのHazy Researchグループ（Omar Khattab氏、Matei Zaharia氏ら）により開発
- LLMに数例のデモを提示（Demonstrate）
- 多数の候補出力を生成しスコアリング（Search）
- 最終的に最も良い探索結果を選択（Predict）

**論文発表（2023年10月）**: "DSPy: Compiling Declarative Language Model Calls into Self-Improving Pipelines"

- Omar Khattab、Arnav Singhvi、Hanna Moazam、Matei Zaharia、Chris Pottsらによる
- スタンフォードとDatabricksの連名
- 「プロンプトをハードコードせず、言語モデルを使用したモジュールを宣言的に組み合わせ、コンパイル時に最適化する」というコア設計

**発展のタイムライン**:

| 時期 | バージョン | 主な機能・トピック | Databricksとの関係 |
|------|-----------|-------------------|-------------------|
| 2023年10〜12月 | v1.x | モジュール化・コンパイラ最適化の基本構造確立 | 研究者主導のPoC段階 |
| 2024年上旬 | v2.0-2.5系 | 最適化器改善、評価ループ自動化 | Databricksが公式ブログ公開、統合開始 |
| 2024年下旬 | v2.6系 | LM usage tracking、RAG Module強化 | MLflow integration着手 |
| 2025年6月 | v3.0 | GRPO、GEPA、SIMBA、MLflow 3.0統合、Adapter/Type System追加 | DATA+AI SUMMITで発表 |
| 2025年8〜10月 | v3.0.1-3.0.3 | パッチ安定化、Databricks Runtime最適化 | MLflow Docsに対応明記 |

### DSPyの基本構造

**シグネチャ**: 『LLMにどのような情報が入力され、どのような情報が出力されるのか』を定義

```python
class ConversationSignature(dspy.Signature):
    """枝豆の妖精として対話する"""
    query = dspy.InputField(desc="ユーザーからの質問や発言")
    history = dspy.InputField(desc="過去の対話履歴", format=list, default=[])
    response = dspy.OutputField(
        desc="枝豆の妖精としての応答。語尾に「のだ」「なのだ」を自然に使い、"
             "一人称は「ボク」。親しみやすく可愛らしい口調で、日本語として自然な文章"
    )
```

**シグネチャのパラメータ**:

| パラメータ | 役割 | デフォルト値 | 最適化への影響 |
|----------|------|-------------|---------------|
| desc | フィールドの説明文。LLMへの指示として使用 | なし | 主要な要素。詳細な記述が品質に影響 |
| format | 期待される型（str, int, list, dictなど） | str | 出力の形式を制約し、パース可能な結果を保証 |
| default | デフォルト値 | なし | 省略可能なフィールドの初期値を提供 |
| prefix | プロンプト内での接頭辞 | フィールド名 | プロンプトの構造を明確化 |

**モジュール**: シグネチャをどのように使うのかを定義

```python
class EdamameFairyBot(dspy.Module):
    """枝豆の妖精スタイルのチャットボット"""
    def __init__(self):
        super().__init__()
        self.respond = dspy.Predict(ConversationSignature)
    
    def forward(self, query: str, history: list | None = None) -> dspy.Prediction:
        if history is None:
            history = []
        return self.respond(query=query, history=history)
```

### プリセットモジュールの種類

| モジュール名 | 説明 | 使用場面 |
|------------|------|----------|
| dspy.Predict | 質問に対して直接回答を生成 | シンプルな質問応答、分類タスク、チャットボット |
| dspy.ChainOfThought | 段階的な思考過程を明示してから最終回答を出力 | 複雑な推論、数学問題、論理パズル、判断根拠が必要な場面 |
| dspy.ReAct | 思考と行動を交互に実行 | Web検索、データベース照会、API呼び出しを伴うタスク |
| dspy.ProgramOfThought | 問題をPythonコードのような擬似プログラムに変換 | アルゴリズム的な問題、条件分岐が多い処理 |
| dspy.MultiChainComparison | 複数の角度から回答を生成し比較 | 医療診断、法律相談、重要な意思決定 |

### モジュールの実行例

```python
# チャット用LM設定
lm = dspy.LM(
    model="openai/gpt-4.1-nano",
    temperature=0.0,
    max_tokens=1000
)

# DSPyのグローバル設定
dspy.configure(lm=lm)

# モジュール実行
chatbot = EdamameFairyBot()
result = chatbot(query="こんにちは！", history=[])
```

**実行結果**:

```
あなた: こんにちは！
🌱妖精: やっほーなのだ！ボクは枝豆の妖精、エダマメちゃんなのだ。
会えてうれしいのだ！何かお手伝いできることがあったら教えてほしいのだ〜！
```

### DSPyプログラムの最適化プロセス

**最適化の流れ**:

```
シグネチャ + モジュール → DSPyプログラム
         ↓
データセット + 評価関数 + オプティマイザー
         ↓
シグネチャ + モジュール → DSPyプログラム v2（最適化済み）
```

### 主要なオプティマイザー

| オプティマイザー | 最適化アルゴリズム | 計算コスト |
|----------------|------------------|-----------|
| **GEPA** | リフレクションによる進化的最適化。実行トレースを言語で振り返り、問題診断→改善案生成→統合 | 高 |
| **MIPROv2** | プロンプトの命令文とfew-shot例の両方を最適化。ベイズ最適化+ミニバッチ評価を用いた探索 | 中〜高 |
| **BootstrapFewShot** | 訓練データから良い例だけを自動選択（例：100例から有用な5例を選ぶ）。ランダムサーチ | 低 |
| **GRPO** | プロンプト最適化+LoRAによる重み更新。オンラインRLでモジュール横断のDSPyプログラム全体を最適化 | 高 |

### MIPROv2による最適化の詳細プロセス

**①トレース収集**

- スコアの高いfew-shot例を生成
- データセットから良質なサンプルを抽出

**②プロンプト候補生成**

- 複数のプロンプトバリエーションを自動生成
- 指示文の表現を多様化

**③ベイズ最適化**

- プロンプト候補とfew-shot例の組み合わせを評価
- 最高スコアの組み合わせを探索
- イテレーティブに性能向上

### 実践例: 枝豆の妖精チャットボット

**データセット準備**:

- databricks-dolly-15k-jaをベースに作成された`takaaki-inada/databricks-dolly-15k-ja-zundamon`を使用

**評価関数の実装**:
LLM as a Judgeで以下の基準を0-10点で評価：

1. 語尾に「のだ」「なのだ」を適切に使用（3点）
   - 過度な使用（のだのだ等）は減点
   - 自然な日本語として成立しているか
   - 「なのだよ」「なのだね」といった語尾は不自然のため減点
2. 一人称を使う際は「ボク」を使用（2点）
3. 親しみやすく可愛らしい口調（3点）
4. 日本語として自然で読みやすい（2点）
   - 不自然な繰り返しがないか
   - 文法的に正しいか

**MLflowでの実験管理**:

- 最適化の各イテレーションを自動的に記録
- パラメータ、メトリクス、アーティファクトを一元管理
- 実験結果の比較と再現が容易

## まとめ

### DSPyの3つのポイント

1. **『シグネチャ』と『モジュール』によって処理を構造化する**
   - 『LLMの入出力』と『その組み合わせ』を定義することで、言語モデルを利用したプログラムを作成

2. **状況に応じて適切な『オプティマイザー』を選定する**
   - データセットの規模、タスクの特性を見極めて最適なオプティマイザーを選択

3. **『プロンプト』を手書きするのではなく、演算された『重み』として扱う**
   - データセットと評価関数によって導き出される『重み』として扱う

### 全体のまとめ

1. **AIエージェントの性能は『プロンプト』に依存する**
   - コードによるルールベースの制御よりも、LLMの判断による制御のパフォーマンスがAIエージェントの性能の鍵

2. **『プロンプト』の性能を維持・向上させていくのは困難**
   - モデルのアップデートやリタイアメントが繰り返される中で、人手によるアップデートでは限界がある

3. **『プロンプト』を手書きするのではなく、演算された『重み』として扱う**
   - プロンプトを手書きでアップデートするのは限界があると認め、データセットと評価関数によって導き出される『重み』として扱う

## 参考情報

**サンプルコード**:

- <https://github.com/mahm/softwaredesign-llm-application/blob/main/25>

**関連書籍**:

- 『現場で活用するためのAIエージェント実践入門』（2024年7月発売）
  - 著者: 太田真人（Sakana AI）、宮脇峻平（Algomatic）、西見公宏（Generative Agents）、後藤勇輝（電通総研）、阿田木勇八（電通総研）
- Software Design誌「実践LLMアプリケーション開発」第25回以降でDSPyの使い方を連載

**今後のイベント**:

- 2025/10/29（水）19:30〜21:00: 【Databricks共催】プロンプトエンジニアリングからの脱却！DSPyによるプロンプト最適化入門
- 2025/11/13（木）: DSPyミートアップ（会場: 東京スクエアガーデンWeWork）
- 12月2日、12月9日、12月16日（火）10:00〜18:00: LLMアプリケーション開発者養成講座（合同研修）
