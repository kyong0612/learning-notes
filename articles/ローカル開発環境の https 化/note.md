---
title: "ローカル開発環境の https 化"
source: "https://blog.jxck.io/entries/2020-06-29/https-for-localhost.html"
author:
  - "Jxck"
published: 2020-06-29
created: 2025-05-14
description: |
  Webのhttps化が進み、httpsを前提とするAPIが増加。ローカル開発でlocalhostを用いる際の注意点や、筆者が実践する独自ドメインとLet's Encryptを利用したhttps環境構築方法を解説。
tags:
  - "localhost"
  - "https"
  - "security"
  - "clippings"
---
## 要約

本記事では、ローカル開発環境におけるHTTPS化の必要性と、その実現方法について解説しています。

### Intro

WebのHTTPS化が進展し、HTTPSを前提とするAPIが増えています。これに伴い、ローカル開発環境でもHTTPSが求められるケースが増加しています。`localhost`での開発には特有の注意点があり、筆者が実践している方法や注意点をまとめています。

### localhost での開発の注意点

`http://localhost` での開発は、本番環境との差異が大きくなる可能性があります。

* **localhost の特異性**: ブラウザは `localhost` に対して多くの例外を許容しており（例: ServiceWorkerのHTTPでの利用）、これが本番環境との挙動の違いを生む原因となります。
* **localhost の実態**: `localhost` は通常 `127.0.0.1` を指すhostsファイルのエントリですが、変更可能です。このため、`localhost` が必ずしもループバックアドレスを指す保証はありません。
* **localhost https**: `https://localhost` を実現するには自己署名証明書を用いる方法がありますが、ブラウザエラーや証明書ストアの取り扱いに関する注意が必要です。

### トラストアンカーとしての証明書ストア

証明書ストアはPKIの信頼の基点であり、安易な変更は危険です。自動で証明書ストアを操作するツールにも注意が必要です。

### 安全なローカルHTTPS環境の構築方法

筆者は、hostsファイルや証明書ストアを直接編集するよりも安全な方法として、以下の手法を提案しています。

1. **個人用開発環境**:
    * 自身が所有するドメインのサブドメイン（例: `localhost.jxck.io`）を用意し、そのAレコードを `127.0.0.1` に設定します。
    * Let's Encryptを使用し、DNS認証で本物のSSL証明書を発行します。
    * この証明書をローカルサーバーに設定することで、`https://localhost.jxck.io:3000` のような形で、ブラウザに信頼されるHTTPS環境を構築できます。
    * この方法は、マシン間での環境再現が容易で、証明書ストアを汚すリスクもありません。

    ![https://localhost.jxck.io:3000](https://blog.jxck.io/entries/2020-06-29/localhost.jxck.io.avif?231116_154951 "certificate detail view on https://localhost.jxck.io:3000 demo")

2. **管理された証明書ストア（企業向け）**:
    * 組織で管理するCAとイントラ向けドメインを利用し、社内CAから証明書を発行します。
    * `.test` などの予約済みドメインの使用や、自社ドメインのサブドメイン利用を推奨します。

3. **現場用開発環境（チーム開発）**:
    * ステージング用ドメイン（例: `dev.example.com`）の証明書をLet's Encryptで取得し、チームで共有します。
    * 開発サーバーにこの証明書を設定し、ドメインを `127.0.0.1` に向けることで、チームメンバー全員が同じHTTPS環境を再現できます。
    * Let's Encryptは発行履歴が公開されるため、機密プロジェクトでは注意が必要です。

### 開発ツールにはどこまでが許されるか?

HTTPSが必須となった現代において、開発環境の整備とOSのモデルに乖離が生じています。ブラウザの開発者ツール内で、hostsの代替や証明書検証の無視などを安全に設定できる機能が望まれますが、セキュリティ上の懸念もあります。

### 追記: Chrome の `host-rules` フラグ

Chromeには起動時フラグ `--host-rules` があり、これを利用することで特定のホスト名の名前解決を書き換えることができます。例えば、`google-chrome --host-rules="MAP example.com 127.0.0.1"` のように指定します。これにより、権限なしで一時的な名前解決の変更が可能ですが、既に起動しているChromeの場合は再起動が必要です。

## 元記事の重要な結論・発見

* ローカル開発環境での `http://localhost` は、ブラウザによる特例措置が多く、本番環境との差異を生むため、HTTPS化が推奨される。
* 自己署名証明書や自前CAによる `https://localhost` 化は、証明書ストアの取り扱いに注意が必要であり、安易な変更は危険を伴う。
* 最も安全かつ確実な方法は、自身が所有するドメインとLet's Encryptを利用して、正規のSSL証明書でローカルHTTPS環境を構築することである。
* Chromeの `--host-rules` フラグは、OSのhostsファイルを変更せずに一時的な名前解決の変更が可能で、開発に有用な場合がある。

## 元記事で言及されている制限事項

* 本記事で紹介されている方法は、特に推奨するものではなく、あくまで筆者の個人的な見解と実践例である。
* Let's Encryptで発行した証明書はCertificate Transparency Logに記録されるため、極秘プロジェクトの場合はステージング用ドメインの選定に注意が必要。
* Chromeの `--host-rules` は便利だが、適用するにはChromeの再起動が必要になる場合がある。
