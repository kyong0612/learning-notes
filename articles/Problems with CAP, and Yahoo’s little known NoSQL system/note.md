# Problems with CAP, and Yahoo’s little known NoSQL system

ref: <https://dbmsmusings.blogspot.com/2010/04/problems-with-cap-and-yahoos-little.html>

## CAP定理とその問題点

CAP定理は分散システムにおける3つの性質（整合性、可用性、ネットワーク分断への耐性）のうち、2つしか選択できないと述べています。しかし、この定理には以下のような問題点があります：

1. **整合性（C）と可用性（A）の非対称性**:
   - APシステムは常に整合性を犠牲にするのに対し、CPシステムはネットワーク分断時のみ可用性を犠牲にします。この違いが混乱を招く要因となっています。

2. **CAとCPの区別が曖昧**:
   - ネットワーク分断が発生すると、CAシステムは事実上CPシステムと同じ動作をします。そのため、実質的には「CP/CA」と「AP」の2種類だけと考えられます。

---

## CAPの限界とYahooのNoSQLシステム「PNUTS」

YahooのPNUTS（別名Sherpa）はCAP定理の枠組みに当てはめると、一見すると整合性と可用性の両方を犠牲にしているように見えます。具体的には：

- **整合性**: 「タイムライン整合性」のみを保証し、レプリカ間の不整合を許容。
- **可用性**: 特定のデータアイテムのマスターレプリカが到達不可能な場合、そのアイテムは更新不可。

これは整合性と可用性を犠牲にする理由が、可用性向上のためではなく「低遅延」を達成するためだからです。広域ネットワークでの同期型レプリケーションは遅延を大きくし、特にWebアプリケーションではこの遅延が受け入れられないことがあります。

---

## PACELCモデルの提案

CAP定理を補完するため、筆者はPACELC（パセルク）モデルを提案します：

- **P（ネットワーク分断）発生時**: 可用性（A）と整合性（C）のトレードオフ。
- **E（Else、正常時）**: 遅延（L）と整合性（C）のトレードオフ。

### 具体例

1. **Amazon Dynamoと類似システム**:
   - PA/EL（分断時：可用性重視／通常時：低遅延重視）
   - これらのシステムは、整合性よりも可用性を優先するように設計されています。この選択は、可用性がユーザー体験にとって重要であるWebアプリケーションに適しています。

2. **PNUTS**:
   - PC/EL（分断時：整合性重視／通常時：低遅延重視）
   - YahooのPNUTSは、通常時に整合性を犠牲にすることで遅延を低減し、ネットワーク分断時には可用性を犠牲にして整合性を維持するシステムです。

3. **完全なACIDシステム**:
   - PC/EC（分断時：整合性重視／通常時：整合性重視）
   - トランザクション処理が求められるシステム（例：銀行システム）は、整合性を犠牲にしない設計を選択します。

---

## YahooのPNUTSシステムの特徴

### タイムライン整合性の採用

PNUTSは、整合性の犠牲による遅延削減の典型例として挙げられます。この整合性モデルでは、レプリカ間で更新の順序が保証されるものの、一時的な不一致が許容されます。

### 適用範囲

PNUTSの設計は、主に次のような状況に適しています：

- **低遅延が求められるアプリケーション**（例：リアルタイム広告、SNS）。
- **分散環境での可用性と整合性の柔軟なトレードオフ**。

---

## まとめ

- CAP定理は分散システムの設計における基本的な枠組みを提供しますが、その簡略化された性質がしばしば誤解を招きます。
- PACELCモデルは、CAPの弱点を補完し、遅延を含む包括的なトレードオフ分析を可能にします。
- YahooのPNUTSのようなシステムは、PACELCの枠組みで初めてその設計意図が明確になります。
