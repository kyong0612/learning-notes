---
title: "『呪術廻戦 ファントムパレード』「バトルリザルト」の大規模リファクタ ~工数10営削減までの裏側~"
source: "https://tech.sumzap.co.jp/entry/battle-result-refactoring-in-jujutsuphanpara"
author:
  - "[[水田将大]]"
  - "[[sumzap_engineer]]"
published: 2025-08-19
created: 2025-11-05
description: "『呪術廻戦 ファントムパレード』のバトルリザルト画面の大規模リファクタリングプロジェクトの記録。運用1.5年で蓄積された設計の硬直性、知識の属人化、チームのボトルネック、コードの複雑性といった課題に対し、Command/Composite/Decorator/Template Methodパターンを組み合わせた統一的なコマンド実行システムを実装。10営業日以上の工数削減を実現し、新規実装者の作業時間を1-2営業日に短縮。チーム横断での実装が可能になり、開発速度と柔軟性が向上した事例。"
tags:
  - "Unity"
  - "リファクタリング"
  - "ゲーム開発"
  - "デザインパターン"
  - "技術的負債"
  - "clippings"
---

## 概要

サイバーエージェント2024年新卒入社の水田将大氏による、『呪術廻戦 ファントムパレード』のバトルリザルト画面の大規模リファクタリングプロジェクトの詳細な記録。運用開始から1.5年が経過し、当初の設計では対応しきれない課題が顕在化していたバトルリザルトシステムを、デザインパターンを活用した統一的なアーキテクチャへと刷新。工数10営業日以上の削減という定量的成果と、チーム横断での開発が可能になるという定性的成果の両面で成功を収めた。

## バトルリザルトが抱えていた課題

運用1.5年を経て、バトルリザルトシステムには以下の4つの主要な課題が存在していた：

### 1. 設計の硬直性

- 初期設計が「リリース後の変更は最小限」という前提で構築されていた
- 新規コンテンツ追加時に既存実装の理解が必須となり、実装コストが増大
- 変更の影響範囲が広く、保守性が低下

### 2. 知識の属人化

- インゲームチームのみが実装詳細を理解している状態
- チーム間での知識共有が不十分
- ドキュメント不足による理解コストの増大

### 3. チームのボトルネック

- インゲームチームへの作業集中
- アウトゲームチームがUI関連タスクに貢献できない
- チーム全体の開発速度が制約される

### 4. コードの複雑性

- 複数のバトルタイプごとにカスタム実装が必要
- コードの再利用性が低い
- 保守性とスケーラビリティの問題

## リファクタリングの実施方針

プロジェクトでは以下の原則を重視：

- **最小限の影響**: 既存の本番システムへの影響を最小化
- **明確なスコープ管理**: 演出フローロジックに焦点を絞り、視覚的改善は含めない
- **保守性重視**: 新機能追加よりも保守性向上を優先
- **詳細なQA検証**: リリース前の徹底的な検証

## リファクタリングのフロー

### フェーズ1: フロー分析

既存のバトルリザルトシーケンスを完全にドキュメント化：

- 動画再生
- ラベル表示
- 複数ページのUIアニメーション
- スキップ機能の動作

### フェーズ2: ゴール定義

リファクタリングの目標を明確化：

- 演出フローロジックのみに焦点
- 視覚的改善は除外
- スコープクリープの防止

### フェーズ3: QA調整

数ヶ月前からテストパラメータを確立：

- 動作変更が発生する可能性のあるチェックポイントの特定
- 影響を受けない領域の除外
- 効率的な検証戦略の策定

### フェーズ4: 設計アーキテクチャ

複数のデザインパターンを組み合わせたハイブリッドアプローチ：

#### 採用したデザインパターン

##### Command Pattern（コマンドパターン）

- 個々の演出アクションを独立したオブジェクトとして実装
- 実行、キャンセル、完了待機などの操作を標準化

##### Composite Pattern（コンポジットパターン）

- 複数のコマンドをグループ化して同時実行
- 階層的な構造での柔軟な組み合わせ

##### Decorator Pattern（デコレータパターン）

- コマンドの再利用可能なバリエーションを実装
- 既存コードを変更せずに機能拡張

##### Template Method Pattern（テンプレートメソッドパターン）

- コマンド実行フローの標準化
- 一貫したライフサイクル管理

### フェーズ5: 実装

統一されたコマンド実行システムの構築：

#### コアインターフェース

すべてのコマンドが実装する一貫した動作フロー：

```text
InitializeAsync() → PrepareAsync() → ExecuteAsync()
→ WaitForComplete() → Complete()
```

**各フェーズの役割**：

- **InitializeAsync()**: リソースの初期化、依存関係の解決
- **PrepareAsync()**: 実行前の準備処理
- **ExecuteAsync()**: 実際の演出実行
- **WaitForComplete()**: 完了待機、スキップ対応
- **Complete()**: 後処理とクリーンアップ

#### メイン実行ループ

- コマンドの順次処理を自動化
- キャンセルトークンによるスキップ機能のサポート
- エラーハンドリングの統一

## 達成された成果

### 定量的成果

- **工数削減**: 10営業日以上の削減を実現
- **実装時間の短縮**: 新規実装者の所要時間が1-2営業日に短縮
- **開発速度の向上**: 類似のリファクタリングが他機能にも波及

### 定性的成果

- **チーム横断での実装**: アウトゲームチームもバトルリザルト機能に貢献可能に
- **技術的負債の削減**: コードベースの保守性が向上
- **チーム効率とモラルの改善**: ボトルネックの解消により全体的な生産性が向上
- **将来の最適化基盤**: さらなる改善のための土台を確立

## 成功の重要要因

1. **最小限の影響**: 本番システムへの影響を慎重に管理
2. **詳細なQA検証**: リリース前の徹底的なテスト
3. **明確なスコープ管理**: 機能追加の誘惑を避け、リファクタリングに集中
4. **保守性の重視**: 新機能追加よりも保守性向上を優先

## 技術的な学び

このリファクタリングプロジェクトは、以下の重要な教訓を示している：

1. **段階的なアプローチ**: 大規模な変更を管理可能な段階に分割
2. **パターンの組み合わせ**: 単一のパターンではなく、複数パターンの組み合わせが効果的
3. **チーム全体の関与**: QAや他チームとの早期からの連携が成功の鍵
4. **明確な目標設定**: スコープクリープを防ぐための明確な境界線の設定

このプロジェクトは、構造化された技術改善が直接的にゲーム開発の速度とチームの柔軟性を向上させることを実証している。
