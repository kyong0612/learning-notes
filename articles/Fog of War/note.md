---
title: Fog of War
source: https://remix.run/blog/fog-of-war
author:
published:
created: 2024-12-25
description: |
  Remixは、アプリケーションをデフォルトで高性能に保つために設計されています。その最新機能「Fog of War」（別名「遅延ルート発見」）により、アプリケーションがどれだけ大規模になっても、パフォーマンスを維持できるようになりました。
tags:
  - Remix
  - React Router
  - SSR
  - Performance
  - Fog of War
  - Lazy Route Discovery
---

Remixは、アプリケーションをデフォルトで高性能に保つために設計されています。その最新機能「Fog of War」（別名「遅延ルート発見」）により、アプリケーションがどれだけ大規模になっても、パフォーマンスを維持できるようになりました。

Remixは主に、React Routerの上に構築されたコンパイラとサーバーランタイムとして機能し、React Routerのサーバーサイドレンダリング（SSR）アプリを記述するための直感的で高性能な方法を提供します。もちろん、Remixを使用せずにReact Routerを使ったSSRアプリを独自に構築することも可能ですが、同じようなパフォーマンス向上を実現するには、自分でコンパイラやサーバーランタイムを構築し、Remixが提供する最適化を模倣する必要があるでしょう。

Remixの最適化の多くは、ネットワークのウォーターフォール（連続的なリクエスト遅延）を排除することを目的としています。

## 「レンダー後にフェッチ」から「フェッチ後にレンダー」へ

「レンダー後にフェッチ」の場合、ルートの実装をダウンロードした後にデータフェッチを開始します。これによりウォーターフォールが発生しますが、「フェッチ後にレンダー」ではモジュールのダウンロードとデータフェッチを並行して行うことができます。さらに、Remixでは<Link prefetch>を使用することで、リンクをクリックする前にルートデータとコンポーネントをプリフェッチし、クリック時のナビゲーションを即座に実現します。

## 「Fog of War」とは？

ゲームにおける拡大する地図のように、アプリケーションのルートツリーも初期の部分だけを公開し、ユーザーの移動に応じて徐々に展開する仕組みです。これにより、大規模アプリでも初期ロード時のパフォーマンスへの影響を最小限に抑えることができます。

以前のRemixでは、初期のルートのみをサーバーサイドで提供し、リンクがクリックされるとサーバーから新しいルートをリクエストしてデータとモジュールをフェッチしていましたが、これではネットワークウォーターフォールが発生します。そのため、Remix v2.10では「future.unstable_fogOfWar」フラグ（v2.11では「future.unstable_lazyRouteDiscovery」に改名）を導入し、リンクが表示された時点でルートを事前に発見する仕組みを採用しました。

この技術により、アプリケーションの初期ロード時には、必要なルートだけが送信され、ユーザーのナビゲーションに応じて追加のルートがロードされます。例えば、Shopifyでこの機能を使用したところ、初期ルートマニフェストは1300ルートから3ルートに削減され、初期ロードサイズが大幅に軽減されました。

## ルートツリーの視覚的な説明

現在のRemixでは、初期ロード時に完全なルートマニフェストが送信されます。以下の図では、赤い点がアクティブにレンダリングされているルートを示し、白い部分がすべての可能なルートを含むマニフェストを表しています。

![alt text](<assets/CleanShot 2024-12-25 at 18.13.22@2x.png>)

一方、「Fog of War」を有効にすると、初期ロード時にはアクティブなルートだけがマニフェストに含まれます。

![alt text](<assets/CleanShot 2024-12-25 at 18.13.27@2x.png>)

クライアントサイドでUIがハイドレート（レンダリング）されると、リンクが表示され、現在マニフェストで知られていないいくつかのルートが検出されます。

![alt text](<assets/CleanShot 2024-12-25 at 18.13.31@2x.png>)

RemixはそれらのルートをRemixサーバーにフェッチリクエストを送ることで発見し、マニフェストに追加します。

![alt text](<assets/CleanShot 2024-12-25 at 18.13.35@2x.png>)

このように、発見型アプローチを活用することで、ルートマニフェストは小さな状態で始まり、ユーザーがアプリケーション内を移動するたびに成長していきます。これにより、アプリケーションがどれだけ多くのルートを持っていても、初期ロード時のパフォーマンスに影響を与えることなくスケール可能になります。

## 「Fog of War」の実績

この新しいアプローチはすでにShopifyやRemix公式サイトで使用されています。Shopifyでは、以前の1300ルート、10MB（圧縮前）のマニフェストが、初期ロード時にはわずか3ルート、1.9KB（圧縮前）まで削減されました。Remix公式サイトでも、20KB（圧縮前）から4KB（圧縮前）に削減されています。

## React Routerとの連携

「Fog of War」はReact Routerの新しいAPI、unstable_patchRoutesOnMissにより実現されています。このAPIにより、React Routerが現在のルートツリーでパスをマッチングできない場合に新しいルートを追加できます。この非同期ロジックは、マイクロフロントエンドやモジュールフェデレーションアーキテクチャにも適しています。

例として、以下のように非同期ロジックを実装できます。

``` typescript
const router = createBrowserRouter(
  [
    {
      id: "root",
      path: "/",
      Component: RootComponent,
    },
  ],
  {
    async unstable_patchRoutesOnMiss({ path, patch }) {
      if (path === "/a") {
        let route = await getARoute(); // { path: 'a', Component: A }
        patch("root", [route]);
      }
    },
  }
);
```

この機能により、React Routerアプリケーションでのモジュールフェデレーションを活用した動的なサブアプリケーションのロードが可能になります。

## 「Fog of War」の今後

「Fog of War」機能は、Remix v2.10で不安定なフラグ（future.unstable_fogOfWar）としてリリースされ、v2.11で「future.unstable_lazyRouteDiscovery」に名前が変更されました。この技術は引き続き改善され、将来的に完全に安定した機能として公開される予定です。
